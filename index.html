<!DOCTYPE html>

<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–¢–í–û–ò –î–ê–ù–ù–´–ï ‚Äî –æ—Ç—Å–µ–∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      background: #000;
      color: #fff;
      font-family: "Anticva", "Times New Roman", serif;
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
    }

    :root {
      --bg: #000;
      --fg: #ffffff;
      --soft: #c9c9c9;
      --muted: #7f7f7f;
      --accent: #ffffff;
      --border: #ffffff;
    }

    .elongated {
      display: inline-block;
      transform: scaleY(1.7);
      transform-origin: center;
      letter-spacing: 0.16em;
    }

    .small-elongated {
      display: inline-block;
      transform: scaleY(1.4);
      transform-origin: center;
      letter-spacing: 0.14em;
    }

    .screen {
      position: fixed;
      inset: 0;
      background: #000;
      color: #fff;
      display: none;
    }

    .screen-visible {
      display: block;
    }

    .screen-inner {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    /* 01 ‚Äî –∑–∞—Å—Ç–∞–≤–∫–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º */
    #screen-splash .screen-inner {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }

    .splash-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .splash-hint {
      position: absolute;
      bottom: 24px;
      right: 40px;
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    /* 02 ‚Äî –í –ú–û–ó–ì (–º–æ–∑–≥ + –∫–≤–∞–¥—Ä–∞—Ç—ã) */

    #screen-brain .screen-inner {
      padding: 48px 72px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 40px;
    }

    .brain-left {
      flex: 1;
    }
    .brain-site-name {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--muted);
      margin-bottom: 18px;
    }

    .brain-menu {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 380px;
    }

    .brain-menu-btn {
      border: 1px solid #ffffff;
      background: #000000;
      color: #ffffff;
      padding: 10px 16px;
      text-align: left;
      cursor: pointer;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-size: clamp(16px, 2.4vw, 22px);
      width: 100%;
      transition: background 0.15s ease-out, color 0.15s ease-out, transform 0.15s ease-out;
    }

    .brain-menu-btn:hover {
      background: #ffffff;
      color: #000000;
      transform: translateY(-2px);
    }


    .brain-main-title {
      font-size: clamp(32px, 5vw, 46px);
      margin-bottom: 16px;
      text-transform: uppercase;
      display: block;
    }

    .brain-sub {
      font-size: clamp(16px, 2.4vw, 24px);
      text-transform: uppercase;
      margin-bottom: 6px;
      display: block;
    }

    .brain-sub:nth-child(2) {
      margin-top: 18px;
    }

    .brain-sub:last-child {
      margin-top: 6px;
    }

    .brain-left-bottom {
      margin-top: 40px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    .brain-right {
      flex: 0 0 420px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
    }

    .brain-icon {
      width: 260px;
      max-width: 100%;
      cursor: pointer;
      image-rendering: auto;
    }

    .brain-person {
      width: 100px;
      opacity: 0.95;
    }

    .brain-squares {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 120px));
      gap: 14px;
      margin-top: 6px;
    }

    .brain-square {
      border: 2px solid #fff;
      background: transparent;
      cursor: pointer;
      transition: background 0.15s ease-out, transform 0.15s ease-out;
      /* –ó–æ–ª–æ—Ç–æ–µ —Å–µ—á–µ–Ω–∏–µ: —à–∏—Ä–∏–Ω–∞ / –≤—ã—Å–æ—Ç–∞ ‚âà 1.618 */
      aspect-ratio: 1.618 / 1;
    }

    .brain-square:hover {
      background: #fff;
      transform: translateY(-2px);
    }

    .brain-square.small {
      grid-column: span 2;
      /* –ü–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–æ–µ –∑–æ–ª–æ—Ç–æ–µ —Å–µ—á–µ–Ω–∏–µ: —à–∏—Ä–∏–Ω–∞ / –≤—ã—Å–æ—Ç–∞ ‚âà 1 / 0.618 */
      aspect-ratio: 1 / 0.618;
    }

    .brain-square-disabled {
      cursor: default;
      opacity: 0.85;
      pointer-events: none;
    }

    .brain-square-label {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .square-relative {
      position: relative;
    }

    .brain-io-row {
      display: flex;
      gap: 16px;
      margin-top: 8px;
      align-items: center;
      justify-content: center;
    }

    .brain-io {
      border: 2px solid #fff;
      width: 120px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      background: transparent;
      transition: background 0.15s ease-out, transform 0.15s ease-out;
    }

    .brain-io:hover {
      background: #fff;
      color: #000;
      transform: translateY(-2px);
    }

    #fileInput {
      display: none;
    }

    .brain-brand {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    .brain-brand-logo {
      width: 120px;
      opacity: 0.95;
    }

    /* 02b ‚Äî –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –∫–æ—Ä–Ω—è (–∞–∫—Ç–∏–≤–∏–∑–∞—Ü–∏—è –Ω–µ–π—Ä–æ–Ω–æ–≤) */

    #screen-roots .screen-inner {
      padding: 40px 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 40px;
    }

    .roots-header {
      width: 100%;
      text-align: center;
      text-transform: uppercase;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .roots-title {
      font-size: clamp(42px, 7vw, 64px);
    }

    .roots-sub {
      margin-top: 4px;
      font-size: clamp(18px, 3vw, 24px);
      letter-spacing: 0.18em;
    }

    .roots-center {
      width: 100%;
      max-width: 980px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 40px;
    }

    .roots-bracket {
      border: 2px dotted #ffffff;
      height: 260px;
    }

    .roots-bracket-left {
      border-right: none;
    }

    .roots-bracket-right {
      border-left: none;
    }

    .roots-list-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 18px;
    }

    .roots-add-btn {
      width: 60px;
      height: 60px;
      border-radius: 14px;
      border: 2px solid #ffffff;
      background: #ffffff;
      color: #000000;
      font-size: 32px;
      cursor: pointer;
    }

    .roots-add-btn:hover {
      transform: translateY(-2px);
    }

    .roots-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 20px;
      text-transform: uppercase;
    }

    .root-item {
      display: flex;
      align-items: baseline;
      gap: 12px;
      cursor: pointer;
    }

    .root-item-star {
      font-size: 26px;
    }

    .root-item-label {
      letter-spacing: 0.09em;
      display: inline-block;
      transform: scaleY(1.4);
      transform-origin: center;
    }

    .root-item:hover .root-item-label {
      text-decoration: underline;
    }

    .roots-empty {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    /* 03 ‚Äî –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∞—Ä—Ö–∏–≤–æ—Ç—Å–µ–∫ / –ø–∞—Ç—Ç–µ—Ä–Ω) */

    #screen-app .screen-inner {
      padding: 24px 40px 24px 40px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #appRoot {
      flex: 1;
      display: grid;
      grid-template-columns: 96px 260px 6px minmax(0, 1fr);
      gap: 32px;
    }

    .rootbar {
      border-right: 2px dashed #ffffff;
      padding-right: 12px;
      padding-left: 4px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
      background: #050505;
      border-radius: 8px;
      padding-top: 6px;
      padding-bottom: 6px;
    }

    .rootbar-top {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
      margin-bottom: 8px;
    }

    .rootbar-plus {
      width: 100%;
      height: 36px;
      border-radius: 6px;
      background: #ffffff;
      color: #000000;
      border: none;
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .rootbar-plus:hover {
      transform: translateY(-1px);
      background: #ffffff;
      color: #000000;
    }

    .rootbar-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--muted);
    }

    .rootbar-list {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      text-transform: uppercase;
      overflow-y: auto;
    }

    .rootbar-section-title {
      font-size: 9px;
      letter-spacing: 0.16em;
      color: var(--muted);
      margin-top: 4px;
    }

    .rootbar-item {
      padding: 4px 4px;
      border-radius: 6px;
      border: 1px solid transparent;
      cursor: pointer;
      line-height: 1.35;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .rootbar-item:hover {
      border-color: #ffffff;
      background: #101010;
    }

    .rootbar-item-current {
      border-color: #ffffff;
      background: #151515;
    }

    .rootbar-item-label {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }


    .sidebar {
      border-right: 2px dashed #ffffff;
      padding-right: 24px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .sidebar-resizer {
      width: 2px;
      cursor: col-resize;
      align-self: stretch;
      background: #ffffff;
    }

    .sidebar-resizer::before {
      content: none;
    }

    body.resizing {
      cursor: col-resize;
      user-select: none;
    }


    .sidebar-top {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 18px;
    }

    .sidebar-brand {
      font-size: 22px;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      border: 1px solid #ffffff;
      padding: 4px 12px;
      border-radius: 4px;
    }

    .sidebar-brand:hover {
      background: #ffffff;
      color: #000000;
    }

    .sidebar-brand span {
      display: inline-block;
    }

    .sidebar-plus {
      width: 72px;
      height: 40px;
      border-radius: 6px;
      background: #fff;
      color: #000;
      font-size: 26px;
      border: none;
      cursor: pointer;
      display: none;
    }

    .sidebar-plus:hover {
      transform: translateY(-2px);
    }

    .sidebar-breadcrumb-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    #breadcrumb {
      margin-top: 4px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      word-break: break-word;
    }

    .sidebar-tree-wrapper {
      margin-top: 16px;
      overflow-y: visible;
      padding-right: 8px;
      font-size: 13px;
      flex: 1;
    }

    /* simple tree look */
    .tree-item {
      padding: 4px 6px;
      border-left: 2px solid transparent;
      cursor: pointer;
      margin-bottom: 4px;
      text-transform: uppercase;
    }

    .tree-item:hover {
      border-left-color: #fff;
      background: #111;
    }

    .tree-item.active {
      border-left-color: #fff;
      background: #111;
    }

    .tree-label {
      font-size: 13px;
    }

    .tree-meta {
      font-size: 9px;
      color: var(--muted);
    }

    .tree-badge {
      display: none;
    }

    .hier-fx {
      font-size: 20px;
      margin-bottom: 8px;
    }

    .hier-row {
      display: flex;
      position: relative;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 10px;
      cursor: pointer;
    }

    .hier-row.hier-row-drop-inside {
      background: rgba(255, 255, 255, 0.08);
    }

    .hier-row.hier-row-drop-before::before,
    .hier-row.hier-row-drop-after::after {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      border-top: 2px solid #ffffff;
    }

    .hier-row.hier-row-drop-before::before {
      top: -2px;
    }

    .hier-row.hier-row-drop-after::after {
      bottom: -2px;
    }

    .hier-tag {
      font-size: 11px;
      text-transform: lowercase;
      letter-spacing: 0.1em;
      min-width: 56px;
    }

    .hier-name {
      font-size: 16px;
      text-transform: uppercase;
      display: inline-block;
      transform: scaleY(1.3);
      transform-origin: center;
      letter-spacing: 0.14em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .hier-row-current .hier-name {
      text-decoration: underline;
    }

    .hier-name-link {
      cursor: pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
    }

    /* main panel */
    .main-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .main-header-line {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 2px dashed #fff;
      padding-bottom: 8px;
      margin-bottom: 12px;
    }

    .main-title-wrapper {
      font-size: 26px;
      text-transform: uppercase;
    }

    .main-title-wrapper .small-elongated {
      font-size: 18px;
    }

    #headerActions {
      display: flex;
      gap: 8px;
      font-size: 11px;
      text-transform: uppercase;
    }

    #detailsRoot {
      flex: 1;
      overflow-y: auto;
      padding-right: 8px;
      font-size: 13px;
    }

    .section {
      border: 1px solid #ffffff;
      padding: 8px 10px;
      margin-bottom: 10px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      text-transform: uppercase;
      font-size: 12px;
      cursor: pointer;
    }

    .section-header .section-title {
      display: inline-block;
      transform: scaleY(1.35);
      transform-origin: center;
      letter-spacing: 0.14em;
    }

    .section-body {
      margin-top: 8px;
      font-size: 12px;
    }

    .hint {
      font-size: 11px;
      color: var(--muted);
    }

    .btn {
      font-family: inherit;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      background: #000;
      color: #fff;
      border: 1px solid #fff;
      padding: 4px 10px;
      cursor: pointer;
    }

    .btn-sm {
      font-size: 10px;
      padding: 4px 8px;
    }

    .btn:disabled,
    .btn[disabled] {
      opacity: 0.35;
      cursor: not-allowed;
      border-color: #555555;
      color: #555555;
      background: #000000;
    }

    .btn-primary {
      background: #fff;
      color: #000;
    }

    .btn-ghost {
      background: transparent;
    }

    .btn-danger {
      border-color: #ff6282;
      color: #ff6282;
    }

    .btn-hidden {
      display: none !important;
    }

    .btn-option {
      width: 100%;
      text-align: left;
      margin-bottom: 6px;
    }

    .btn-option-selected {
      background: #fff;
      color: #000;
    }

    .btn-option-correct {
      background: #1c8c3c;
      border-color: #a7ffb0;
      color: #eafff0;
    }

    .btn-option-wrong {
      background: #7b112f;
      border-color: #ff99ba;
      color: #ffe5f1;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      background: #000;
      border: 1px solid #fff;
      color: #fff;
      padding: 4px 6px;
      font-family: inherit;
      font-size: 12px;
    }

    .form-textarea {
      min-height: 60px;
      resize: vertical;
    }

    .form-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--muted);
    }

    .form-row {
      display: grid;
      grid-template-columns: 150px minmax(0, 1fr);
      gap: 6px;
      margin-bottom: 6px;
      align-items: flex-start;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
    }

    .row-xs {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .child-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .child-card {
      border: 1px solid #fff;
      padding: 4px 6px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      cursor: pointer;
      text-transform: uppercase;
      font-size: 11px;
    }

    .child-card:hover {
      background: #111;
    }

    .child-name {
      max-width: 240px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .child-meta {
      font-size: 9px;
      color: var(--muted);
      display: flex;
      gap: 8px;
    }

    .card-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .card-table th,
    .card-table td {
      border-bottom: 1px solid #444;
      padding: 4px 4px;
      text-align: left;
    }

    .card-table-actions,
    .card-order-controls {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-start;
    }


    /* –ö–Ω–æ–ø–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
    .sidebar-toggle-fixed {
      position: absolute;
      left: 8px;
      top: 12px;
      z-index: 10;
      width: 26px;
      height: 32px;
      border-radius: 16px;
      border: 1px solid #ffffff;
      background: #000000;
      color: #ffffff;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-toggle-fixed:hover {
      background: #ffffff;
      color: #000000;
    }

    #appRoot.sidebar-collapsed {
      grid-template-columns: minmax(0, 1fr);
    }

    #appRoot.sidebar-collapsed .rootbar,
    #appRoot.sidebar-collapsed .sidebar,
    #appRoot.sidebar-collapsed .sidebar-resizer {
      display: none;
    }

    /* overlays: —Ç–µ—Å—Ç—ã –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–∫—Ç–æ–≤ */

    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.93);
      z-index: 40;
    }

    .overlay-card {
      width: min(860px, 100% - 40px);
      max-height: min(600px, 100% - 80px);
      background: #000;
      border: 1px solid #fff;
      padding: 16px 18px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 1px dashed #fff;
      padding-bottom: 6px;
    }

    .overlay-title {
      font-size: 20px;
      text-transform: uppercase;
      display: inline-block;
      transform: scaleY(1.4);
      transform-origin: center;
      letter-spacing: 0.14em;
    }

    .overlay-subtitle,
    .overlay-progress {
      font-size: 11px;
      color: var(--muted);
    }

    .overlay-body {
      flex: 1;
      overflow-y: auto;
      font-size: 13px;
    }

    .quiz-question {
      font-size: 14px;
      margin-bottom: 8px;
    }

    .quiz-options {
      margin-top: 4px;
    }

    .quiz-footer {
      border-top: 1px dashed #fff;
      padding-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .quiz-message {
      font-size: 11px;
      color: var(--muted);
      white-space: pre-wrap;
    }

    .facts-text {
      font-size: 13px;
      white-space: pre-wrap;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.93);
      z-index: 50;
    }

    .modal-card {
      width: min(520px, 100% - 40px);
      background: #000;
      border: 1px solid #fff;
      padding: 14px 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 13px;
    }

    .modal-header {
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .modal-header-main {
      display: flex;
      flex-direction: column;
    }

    .modal-close {
      border: 1px solid #fff;
      background: transparent;
      color: #fff;
      padding: 0 6px;
      font-size: 16px;
      line-height: 1;
      cursor: pointer;
      text-transform: none;
    }

    .modal-close:hover {
      background: #fff;
      color: #000;
    }


    .modal-title {
      font-size: 18px;
      text-transform: uppercase;
    }

    .modal-subtitle {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .modal-footer {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      width: 100%;
    }

    .segmented {
      display: inline-flex;
      border: 1px solid #fff;
      padding: 2px;
      gap: 2px;
      margin-top: 4px;
    }

    .segmented button {
      border: none;
      background: transparent;
      color: #fff;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 3px 6px;
      cursor: pointer;
    }

    .segmented button.active {
      background: #fff;
      color: #000;
    }

    .seg-title {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-top: 4px;
    }

    /* overlay —Å —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–æ –º–æ–∑–≥ */
    .brain-story-overlay {
      position: fixed;
      inset: 0;
      background: #000;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }

    .brain-story-overlay.visible {
      display: flex;
    }

    .brain-story-card {
      max-width: 680px;
      padding: 32px 40px 24px;
      border: 1px solid #fff;
      text-align: center;
      font-size: 16px;
      line-height: 1.6;
    }

    .brain-story-card p {
      margin-bottom: 18px;
    }

    /* RESPONSIVE */

    @media (max-width: 960px) {
      #screen-brain .screen-inner {
        padding: 32px 20px;
        flex-direction: column;
      }
      #appRoot {
        grid-template-columns: minmax(0, 1fr);
      }
      .sidebar-resizer {
        display: none;
      }
      .sidebar {
        border-right: none;
        border-bottom: 2px dashed #fff;
        padding-right: 0;
        padding-bottom: 14px;
        margin-bottom: 10px;
      }
      .screen-inner {
        overflow-y: auto;
      }
      body {
        overflow: hidden;
      }
      .hier-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 640px) {
      #screen-brain .screen-inner {
        padding-inline: 14px;
      }
      .brain-main-title {
        font-size: 26px;
      }
      .brain-sub {
        font-size: 16px;
      }
      #screen-app .screen-inner {
        padding-inline: 18px;
      }
    }
  
/* --- Overrides: —Å–∫—Ä–æ–ª–ª –∏ –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è --- */
body {
  overflow-y: auto;
}

.screen-inner {
  overflow-y: auto;
  overflow-x: hidden;
}

#appRoot.sidebar-collapsed {
  grid-template-columns: 72px minmax(0, 1fr);
}

#appRoot.sidebar-collapsed .sidebar,
#appRoot.sidebar-collapsed .sidebar-resizer {
  display: none;
}

#appRoot.sidebar-collapsed .rootbar {
  display: flex;
  padding-inline: 6px;
  border-right: 1px solid #ffffff;
}

#appRoot.sidebar-collapsed .rootbar-expanded {
  display: none;
}

#appRoot.sidebar-collapsed .rootbar-collapsed {
  display: flex;
}

.hier-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
  gap: 8px;
}


.hier-fx-buttons {
  display: flex;
  gap: 4px;
  font-size: 8px;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  flex-wrap: wrap;
}

.hier-fx-btn {
  border: 1px solid #ffffff;
  background: #000000;
  color: #ffffff;
  padding: 2px 6px;
  cursor: pointer;
  font-family: inherit;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  display: inline-block;
  transform: scaleY(1.2);
  transform-origin: center;
  flex: 1 1 auto;
  text-align: center;
  white-space: nowrap;
}

.hier-fx-btn:hover {
  background: #ffffff;
  color: #000000;
}


.hier-row-category {
  color: #ffffff;
  /* –≤–∏–∑—É–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä: —ç—Ç–æ "–ø–∞–ø–∫–∞-–æ—Ç—Å–µ–∫" */
  border-left: 2px solid #ffffff;
}

.hier-row-characteristic {
  color: #c9c9c9;
  /* –≤–∏–∑—É–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä: —ç—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω —Å —Ñ–∞–∫—Ç–∞–º–∏ */
  border-left: 2px dashed #555555;
}

.hier-toggle {
  width: 14px;
  font-size: 10px;
  text-align: center;
  cursor: pointer;
  user-select: none;
}

.hier-toggle-placeholder {
  visibility: hidden;
  cursor: default;
}

  
    .hier-row.hier-row-drop {
      background: rgba(255, 255, 255, 0.08);
    }

  
    .date-exact-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    /* --- Sidebar hierarchy clarity tweaks --- */
    .sidebar-tree-wrapper {
      margin-top: 16px;
      padding: 8px 8px 10px;
      border: 1px solid #ffffff;
      border-radius: 8px;
      background: #050505;
      overflow-y: auto;
      font-size: 13px;
      flex: 1;
    }

    .hier-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px dashed #333333;
    }

    .hier-fx {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .hier-row {
      padding: 4px 6px;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.12s ease-out, border-color 0.12s ease-out;
      align-items: flex-start;
      line-height: 1.4;
    }

    .hier-row:hover {
      background: #111111;
    }

    .hier-row-current {
      border: 1px solid #ffffff;
      background: #151515;
    }

    .hier-tag {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      min-width: 80px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #555555;
      text-align: center;
      margin-right: 6px;
      flex-shrink: 0;
    }

    .hier-row-category .hier-tag {
      border-color: #ffffff;
      color: #ffffff;
    }

    .hier-row-characteristic .hier-tag {
      border-style: dashed;
      color: var(--muted);
    }

    .hier-name {
      /* –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç—Å–µ–∫–∞ / –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É —Å —Ç—Ä–æ–µ—Ç–æ—á–∏–µ–º */
      font-size: 12px;
      text-transform: uppercase;
      display: inline-block;
      transform: scaleY(1.25);
      transform-origin: center;
      letter-spacing: 0.14em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .sidebar-legend {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px dashed #333333;
      font-size: 9px;
      color: var(--muted);
      line-height: 1.5;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 3px;
    }

    .legend-badge {
      border-radius: 999px;
      padding: 1px 6px;
      border: 1px solid #555555;
      font-size: 8px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .legend-badge-cell {
      border-color: #ffffff;
      color: #ffffff;
    }

    .legend-badge-patt {
      border-style: dashed;
    }


    /* –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –∏ –ø–æ–∏—Å–∫ */

    .rootbar {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .rootbar-expanded {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .rootbar-collapsed {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding-top: 8px;
    }

    .rootbar-icon,
    .rootbar-toggle-mini {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid #444444;
      background: #000000;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
    }

    .rootbar-icon img {
      width: 20px;
      height: 20px;
      object-fit: contain;
      pointer-events: none;
    }

    .sidebar-top {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .sidebar-toggle-inner {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      border: 1px solid #333333;
      background: #000000;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .sidebar-search {
      margin-top: 8px;
      position: relative;
    }

    .sidebar-search-input {
      font-size: 11px;
      padding-right: 24px;
    }

    .sidebar-search-results {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      margin-top: 4px;
      max-height: 260px;
      overflow-y: auto;
      background: #000000;
      border: 1px solid #333333;
      border-radius: 8px;
      padding: 4px 0;
      z-index: 40;
      display: none;
    }

    .sidebar-search-result {
      padding: 4px 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sidebar-search-result:hover {
      background: #111111;
    }

    .sidebar-search-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .sidebar-search-path {
      font-size: 10px;
      color: #aaaaaa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* === Search highlight (–∫–∞–∫ Ctrl+F) === */
    mark.search-highlight{
      background: rgba(255, 0, 0, 0.14);
      color: inherit;
      padding: 0 1px;
      border-bottom: 2px solid rgba(255, 0, 0, 0.95);
      border-radius: 2px;
    }

</style>
</head>
<body>
  <!-- 01. –ó–∞—Å—Ç–∞–≤–∫–∞ -->
  <div id="screen-splash" class="screen">
    <div class="screen-inner">
      <img src="01.jpg" alt="–¢–í–û–ò –î–ê–ù–ù–´–ï" class="splash-image" />
      <div class="splash-hint">–Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</div>
    </div>
  </div>

  <!-- 02. –í –ú–û–ó–ì -->
  <div id="screen-brain" class="screen screen-visible">
    <div class="screen-inner">
      
      <div class="brain-left">
        <div class="brain-site-name small-elongated">item:crate</div>

        <div class="brain-menu">
          <button class="brain-menu-btn elongated" id="brainTitle" type="button">
            –ê–ö–¢–ò–í–ò–ó–ê–¶–ò–Ø –ù–ï–ô–†–û–ù–û–í
          </button>
          <button class="brain-menu-btn small-elongated" type="button">
            –ó–ê–ü–ò–°–ö–ò –û–ù–û–ò?
          </button>
          <button class="brain-menu-btn small-elongated" type="button">
            –ù–ï –ï–©–Å –ü–û–¢–ï–†–Ø–ù–ù–´–ï –ú–û–ú–ï–ù–¢–´
          </button>
        </div>

        <div class="brain-left-bottom">
          –ø–æ–º–æ–≥–∏ —Å–∞–º —Å–µ–±–µ<span class="elongated"> –∞ —ç—Ç–æ—Ç —Å–∞–π—Ç –∫—Å—Ç–∞ –Ω–µ –ø–æ–º–æ–∂–µ—Ç </span>
        </div>
      </div
      </div>

      <div class="brain-right">
        <img src="brain_icon.png" alt="–ú–æ–∑–≥" class="brain-icon" id="brainIcon" />

        <img src="person_data.png" alt="–¢–í–û–ò –î–ê–ù–ù–´–ï" class="brain-person" />

        <div class="brain-squares">
          <button class="brain-square square-relative brain-square-disabled" id="btnGoToApp" type="button" disabled></button>
          <button class="brain-square"></button>
          <button class="brain-square small"></button>
        </div>

        <div class="brain-io-row">
          <button class="brain-io" id="btnExport">–≠–ö–°–ü–û–†–¢</button>
          <button class="brain-io" id="btnImport">–ò–ú–ü–û–†–¢</button>
          <input type="file" id="fileInput" accept="application/json" />
        </div>

        <div class="brain-brand">
          <div class="small-elongated">–¢–í–û–ò –î–ê–ù–ù–´–ï</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 02b. –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –∫–æ—Ä–Ω—è -->
  <div id="screen-roots" class="screen">
    <div class="screen-inner">
      <div class="roots-back small-elongated" id="backToBrainRoots">–í –ú–û–ó–ì</div>
      <div class="roots-header">
        <div class="roots-title elongated">–ê–ö–¢–ò–í–ò–ó–ê–¶–ò–Ø –ù–ï–ô–†–û–ù–û–í</div>
        <div class="roots-sub small-elongated">–í–´–ë–ï–†–ò –ö–û–†–ï–ù–¨</div>
      </div>
      <div class="roots-center">
        <div class="roots-bracket roots-bracket-left"></div>
        <div class="roots-list-wrapper">
          <button class="roots-add-btn" id="btnRootsAdd">+</button>
          <div class="roots-list" id="rootsList"></div>
        </div>
        <div class="roots-bracket roots-bracket-right"></div>
      </div>
    </div>
  </div>

  <!-- 03. –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
  <div id="screen-app" class="screen">
    <div class="screen-inner">
      <div id="appRoot">
        <aside class="rootbar">
          <div class="rootbar-expanded">
            <div class="rootbar-top">
              <button class="rootbar-plus" id="btnRootbarAdd" type="button">+</button>
              <div class="rootbar-label small-elongated">–ö–û–†–ù–ò</div>
            </div>
            <div class="rootbar-list" id="rootbarList"></div>
          </div>
          <div class="rootbar-collapsed">
            <button class="rootbar-toggle-mini js-sidebar-toggle" type="button" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å">‚ñ∂</button>
            <button class="rootbar-icon" id="collapsedGoBrain" type="button" title="–í –ú–û–ó–ì">
              <img src="brain_icon.png" alt="–í –ú–û–ó–ì" />
            </button>
            <button class="rootbar-icon" id="collapsedAddRoot" type="button" title="–ù–æ–≤—ã–π –∫–æ—Ä–µ–Ω—å">+</button>
            <button class="rootbar-icon" id="collapsedSearch" type="button" title="–ü–æ–∏—Å–∫ –ø–æ —Å–∞–π—Ç—É">üîç</button>
          </div>
        </aside>
        <aside class="sidebar">
          <div class="sidebar-top">
            <button class="sidebar-toggle-inner js-sidebar-toggle" type="button" title="–°–≤–µ—Ä–Ω—É—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å">‚óÄ</button>
            <div class="sidebar-brand small-elongated" id="backToBrain">
              –í –ú–û–ó–ì
            </div>
            <button class="sidebar-plus" id="btnCreateRootCategory">+</button>
            <div>
              <div class="sidebar-breadcrumb-label">–ö–ê–¢–ï–ì–û–†–ò–ò</div>
              <div id="breadcrumb"></div>
            </div>
          </div>
          <div class="sidebar-search">
            <input
              type="search"
              id="globalSearchInput"
              class="form-input sidebar-search-input"
              placeholder="–ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –æ—Ç—Å–µ–∫–∞–º –∏ —Ñ–∞–∫—Ç–∞–º..."
            />
            <div class="sidebar-search-results" id="globalSearchResults"></div>
          </div>
          <div class="sidebar-tree-wrapper">
            <div id="treeRoot"></div>
            <div class="sidebar-legend">
              <div class="legend-item">
                <span class="legend-badge legend-badge-cell">–û–¢–°–ï–ö</span>
                <span>‚Äî —Ä–∞–∑–¥–µ–ª / ¬´–ø–∞–ø–∫–∞¬ª —Å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏.</span>
              </div>
              <div class="legend-item">
                <span class="legend-badge legend-badge-patt">–ü–ê–¢–¢–ï–†–ù</span>
                <span>‚Äî –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ –ª–µ–∂–∞—Ç —Ñ–∞–∫—Ç—ã, –≥–æ–¥—ã, —Å–ø–∏—Å–∫–∏ –∏ —Ç–µ—Ä–º–∏–Ω—ã.</span>
              </div>
            </div>
          </div>
        </aside>
        <div id="sidebarResizer" class="sidebar-resizer"></div>

        <section class="main-panel">
          <div class="main-header-line">
            <div class="main-title-wrapper">
              <span class="small-elongated" id="mainTitleText">–û–¢–°–ï–ö / –ü–ê–¢–¢–ï–†–ù</span>
            </div>
            <div id="headerActions"></div>
          </div>
          <div id="detailsRoot"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- –¢–µ–∫—Å—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –º–æ–∑–≥ -->
  <div id="brainStory" class="brain-story-overlay">
    <div class="brain-story-card">
      <p>
        –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —Å–∞–π—Ç —Å–¥–µ–ª–∞–Ω –ø—Å–∏—Ö–∏—á–µ—Å–∫–∏ –±–æ–ª—å–Ω—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º, –æ–Ω —Ö–æ—Ç–µ–ª –∑–Ω–∞—Ç—å –æ—á–µ–Ω—å –º–Ω–æ–≥–æ,
        –∏ –µ–≥–æ –º–æ–∑–≥ –Ω–µ –±—ã–ª —Å–ø–æ—Å–æ–±–µ–Ω –≤—Å—ë —É–º–µ—Å—Ç–∏—Ç—å, –ø–æ—ç—Ç–æ–º—É –æ–Ω–æ —Å–æ–∑–¥–∞–ª–æ —ç—Ç–æ—Ç —Å–∞–π—Ç.
        –ï–º—É —Å—Ç–∞–ª–æ –ª–µ–≥—á–µ, –∂–∏—Ç—å, —á—É—Ç—å —á—É—Ç—å.
      </p>
      <button class="btn btn-sm btn-primary" id="brainStoryClose">–≤–µ—Ä–Ω—É—Ç—å—Å—è</button>
    </div>
  </div>
  <!-- QUIZ OVERLAY -->
  <div class="overlay" id="quizScreen">
    <div class="overlay-card">
      <div class="overlay-header">
        <div class="overlay-title-block">
          <div class="overlay-title" id="quizHeaderTitle"></div>
          <div class="overlay-subtitle" id="quizProgress"></div>
        </div>
        <div class="overlay-progress">
          –†–µ–∂–∏–º —Ç–µ—Å—Ç–∞: —Ñ–æ–∫—É—Å ‚Äî —Ç–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç—ã.
        </div>
      </div>
      <div class="overlay-body">
        <div class="quiz-question" id="quizQuestion"></div>
        <div class="quiz-options" id="quizOptions"></div>
      </div>
      <div class="quiz-footer">
        <div class="quiz-message" id="quizMessage"></div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-sm btn-ghost" id="btnQuizRestart">–ó–ê–ù–û–í–û</button>
          <button class="btn btn-sm btn-ghost btn-hidden" id="btnQuizNext">–î–∞–ª—å—à–µ</button>
          <button class="btn btn-sm btn-danger" id="btnQuizExit">–í—ã–π—Ç–∏</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FACTS OVERLAY -->
  <div class="overlay" id="factsScreen">
    <div class="overlay-card">
      <div class="overlay-header">
        <div class="overlay-title-block">
          <div class="overlay-title facts" id="factsHeaderTitle"></div>
          <div class="overlay-subtitle" id="factsProgress"></div>
        </div>
        <div class="overlay-progress" id="factsCount"></div>
      </div>
      <div class="overlay-body">
        <div class="facts-text" id="factsText"></div>
      </div>
      <div class="quiz-footer">
        <div class="facts-footer-left">
          <span>–ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–∫—Ç–æ–≤ –±–µ–∑ –æ—Ç–≤–ª–µ–∫–∞—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤.</span>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-sm btn-ghost" id="btnFactPrev">‚Üê –ù–∞–∑–∞–¥</button>
          <button class="btn btn-sm btn-ghost" id="btnFactNext">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
          <button class="btn btn-sm btn-danger" id="btnFactsClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CREATE MODAL -->
  <div class="modal-backdrop" id="createModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-header-main">
          <div class="modal-title" id="createModalTitle"></div>
          <div class="modal-subtitle" id="createModalSubtitle"></div>
        </div>
        <button type="button" class="modal-close" id="createModalClose">√ó</button>
      </div>

      <div class="modal-body">
        <div class="form-row" style="margin-bottom:8px;">
          <div class="form-label" id="createNameLabel">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
          <div>
            <input class="form-input" id="createNameInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–ò—Å—Ç–æ—Ä–∏—è –ë–µ–ª–∞—Ä—É—Å–∏¬ª" />
            <div class="form-helper">–ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º ‚Äî –∏–º—è –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
          </div>
        </div>

        <div id="createConfigBlock">
          <div class="seg-group">
            <div class="seg-title">–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è?</div>
            <div class="segmented" id="segConfigScope">
              <button type="button" data-scope="subject">–£–ß–ï–ë–ù–´–ô –ü–†–ï–î–ú–ï–¢</button>
              <button type="button" data-scope="personal">–õ–ò–ß–ù–û–ï / –°–í–û–ò –ó–ê–ú–ï–¢–ö–ò</button>
            </div>
          </div>

          <div class="seg-group" id="configPresetSubject">
            <div class="seg-title">–ì–æ—Ç–æ–≤—ã–π –ø—Ä–µ—Å–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–∞</div>
            <div class="segmented" id="segConfigPresetSubject">
              <button type="button" data-preset="history">–ò–°–¢–û–†–ò–Ø</button>
              <button type="button" data-preset="english">–ê–ù–ì–õ–ò–ô–°–ö–ò–ô</button>
            </div>
          </div>

          <div class="seg-group" id="configPresetPersonal">
            <div class="seg-title">–õ–∏—á–Ω—ã–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞</div>
            <div class="segmented" id="segConfigPresetPersonal">
              <button type="button" data-preset="notes">–ó–ê–ú–ï–¢–ö–ò</button>
              <button type="button" data-preset="ideas">–ò–î–ï–ò / –ß–ï–†–ù–û–í–ò–ö–ò</button>
            </div>
          </div>

          <div class="seg-group" id="configImportBlock">
            <div class="seg-title">–ò–º–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤–æ–π –±–∞–∑—ã</div>
            <p class="hint" style="margin-top:4px; margin-bottom:4px;">
              –ï—Å–ª–∏ —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å —Ñ–∞–π–ª <code>exam-db.json</code>, –º–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å –Ω—É–ª—è.
            </p>
            <button type="button" class="btn btn-sm" id="btnImportInCreate">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É</button>
          </div>
        </div>
      </div>

      <div id="createPatternTypeBlock" style="display:none; margin-top:8px;">
        <div class="seg-title">–¢–∏–ø –ø–∞—Ç—Ç–µ—Ä–Ω–∞</div>
        <div class="segmented" id="segPatternType">
          <button type="button" data-ptype="assertion">–§–ê–ö–¢–´</button>
          <button type="button" data-ptype="years">–ì–û–î–ê</button>
          <button type="button" data-ptype="olist">–û–ë–™–ï–ö–¢–ù–´–ï –°–ü–ò–°–ö–ò</button>
          <button type="button" data-ptype="term">–°–õ–û–í–ê-–û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø</button>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-sm btn-ghost" id="btnCreateCancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-sm btn-primary" id="btnCreateConfirm">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </div>
  </div>

<script>
    // ===== DOM ELEMENTS =====

    const treeRootEl = document.getElementById('treeRoot');
    let dragNodeId = null;
    let dragOverMode = null;

    // –í–∫–ª—é—á–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
    document.addEventListener('focusin', (e) => {
      const t = e.target;
      if (!t || !t.tagName) return;
      const tag = t.tagName.toLowerCase();
      if (tag === 'textarea') {
        t.setAttribute('spellcheck', 'true');
      } else if (tag === 'input') {
        const type = (t.getAttribute('type') || 'text').toLowerCase();
        if (type === 'text' || type === 'search') {
          t.setAttribute('spellcheck', 'true');
        }
      }
    });


    if (treeRootEl) {
      treeRootEl.addEventListener('dragstart', (e) => {
        const row = e.target.closest('.hier-row');
        if (!row || !row.dataset.id) return;
        dragNodeId = row.dataset.id;
        dragOverMode = null;
        if (e.dataTransfer) {
          e.dataTransfer.effectAllowed = 'move';
          try {
            e.dataTransfer.setData('text/plain', dragNodeId);
          } catch (err) {}
        }
      });

      treeRootEl.addEventListener('dragover', (e) => {
        const row = e.target.closest('.hier-row');
        if (!row) return;
        e.preventDefault();

        const rect = row.getBoundingClientRect();
        const offsetY = e.clientY - rect.top;
        let mode = 'inside';
        if (offsetY < rect.height * 0.25) {
          mode = 'before';
        } else if (offsetY > rect.height * 0.75) {
          mode = 'after';
        }

        dragOverMode = mode;

        // –æ—á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        Array.from(treeRootEl.querySelectorAll('.hier-row')).forEach(r => {
          r.classList.remove('hier-row-drop', 'hier-row-drop-before', 'hier-row-drop-after', 'hier-row-drop-inside');
        });

        if (mode === 'before') {
          row.classList.add('hier-row-drop-before');
        } else if (mode === 'after') {
          row.classList.add('hier-row-drop-after');
        } else {
          row.classList.add('hier-row-drop-inside');
        }

        if (e.dataTransfer) {
          e.dataTransfer.dropEffect = 'move';
        }
      });

      treeRootEl.addEventListener('dragleave', (e) => {
        const row = e.target.closest('.hier-row');
        if (!row) return;
        row.classList.remove('hier-row-drop', 'hier-row-drop-before', 'hier-row-drop-after', 'hier-row-drop-inside');
      });

      treeRootEl.addEventListener('drop', (e) => {
        const row = e.target.closest('.hier-row');
        if (!row || !row.dataset.id) return;
        e.preventDefault();
        const targetId = row.dataset.id;
        const draggedId = dragNodeId;
        dragNodeId = null;

        Array.from(treeRootEl.querySelectorAll('.hier-row')).forEach(r => {
          r.classList.remove('hier-row-drop', 'hier-row-drop-before', 'hier-row-drop-after', 'hier-row-drop-inside');
        });

        if (!draggedId || draggedId === targetId) {
          dragOverMode = null;
          return;
        }

        const draggedNode = getNode(draggedId);
        const targetNode = getNode(targetId);
        if (!draggedNode || !targetNode) {
          dragOverMode = null;
          return;
        }

        let mode = dragOverMode || 'inside';
        let newParentId;
        let afterSiblingId = null;

        if (mode === 'inside' && targetNode.type === 'category') {
          // –ë—Ä–æ—Å–∏–ª–∏ –≤–Ω—É—Ç—Ä—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –∫–ª–∞–¥—ë–º –≤ –∫–æ–Ω–µ—Ü –µ—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
          newParentId = targetNode.id;
        } else {
          // –ë—Ä–æ—Å–∏–ª–∏ –º–µ–∂–¥—É —Å–æ—Å–µ–¥—è–º–∏ ‚Äî —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–æ–¥–∏—Ç–µ–ª—è
          const parent = getNode(targetNode.parentId || state.rootId);
          if (!parent) {
            dragOverMode = null;
            return;
          }
          newParentId = parent.id;
          const siblings = parent.children || [];
          const idx = siblings.indexOf(targetNode.id);

          if (mode === 'before') {
            if (idx <= 0) {
              // –≤—Å—Ç–∞–≤–∫–∞ –≤ —Å–∞–º–æ–µ –Ω–∞—á–∞–ª–æ
              afterSiblingId = '__FIRST__';
            } else {
              // –≤—Å—Ç–∞–≤–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ—Å–µ–¥–∞ => –≤–∏–∑—É–∞–ª—å–Ω–æ "–ø–µ—Ä–µ–¥" —Ç–µ–∫—É—â–∏–º
              afterSiblingId = siblings[idx - 1];
            }
          } else {
            // after –∏–ª–∏ inside –ø–æ –Ω–µ‚Äë–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ—Å–ª–µ —Ü–µ–ª–µ–≤–æ–≥–æ —É–∑–ª–∞
            afterSiblingId = targetNode.id;
          }
        }

        moveNode(draggedId, newParentId, afterSiblingId);
        dragOverMode = null;
        render();
      });

      treeRootEl.addEventListener('dragend', () => {
        dragNodeId = null;
        dragOverMode = null;
        Array.from(treeRootEl.querySelectorAll('.hier-row')).forEach(r => {
          r.classList.remove('hier-row-drop', 'hier-row-drop-before', 'hier-row-drop-after', 'hier-row-drop-inside');
        });
      });
    }

    const detailsRootEl = document.getElementById('detailsRoot');
    const breadcrumbEl = document.getElementById('breadcrumb');
    const headerActionsEl = document.getElementById('headerActions');
    const mainTitleTextEl = document.getElementById('mainTitleText');

    const btnCreateRootCategory = document.getElementById('btnCreateRootCategory');
    const rootsListEl = document.getElementById('rootsList');
    const btnRootsAdd = document.getElementById('btnRootsAdd');
    const rootbarListEl = document.getElementById('rootbarList');
    const btnRootbarAdd = document.getElementById('btnRootbarAdd');

    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const fileInput = document.getElementById('fileInput');

    const quizScreenEl = document.getElementById('quizScreen');
    const quizHeaderTitleEl = document.getElementById('quizHeaderTitle');
    const quizProgressEl = document.getElementById('quizProgress');
    const quizQuestionEl = document.getElementById('quizQuestion');
    const quizOptionsEl = document.getElementById('quizOptions');
    const quizMessageEl = document.getElementById('quizMessage');
    const btnQuizExit = document.getElementById('btnQuizExit');
    const btnQuizRestart = document.getElementById('btnQuizRestart');
    const btnQuizNext = document.getElementById('btnQuizNext');

    const factsScreenEl = document.getElementById('factsScreen');
    const factsHeaderTitleEl = document.getElementById('factsHeaderTitle');
    const factsTextEl = document.getElementById('factsText');
    const factsProgressEl = document.getElementById('factsProgress');
    const factsCountEl = document.getElementById('factsCount');
    const btnFactsClose = document.getElementById('btnFactsClose');
    const btnFactPrev = document.getElementById('btnFactPrev');
    const btnFactNext = document.getElementById('btnFactNext');

    const createModalEl = document.getElementById('createModal');
    const createModalTitleEl = document.getElementById('createModalTitle');
    const createModalSubtitleEl = document.getElementById('createModalSubtitle');
    const createNameLabelEl = document.getElementById('createNameLabel');
    const createNameInputEl = document.getElementById('createNameInput');
    const createConfigBlockEl = document.getElementById('createConfigBlock');
    const segConfigScopeEl = document.getElementById('segConfigScope');
    const configPresetSubjectEl = document.getElementById('configPresetSubject');
    const configPresetPersonalEl = document.getElementById('configPresetPersonal');
    const segConfigPresetSubjectEl = document.getElementById('segConfigPresetSubject');
    const segConfigPresetPersonalEl = document.getElementById('segConfigPresetPersonal');
    const createPatternTypeBlockEl = document.getElementById('createPatternTypeBlock');
    const segPatternTypeEl = document.getElementById('segPatternType');
    const btnCreateClose = document.getElementById('createModalClose');
    const btnCreateCancel = document.getElementById('btnCreateCancel');
    const btnCreateConfirm = document.getElementById('btnCreateConfirm');
    const btnImportInCreate = document.getElementById('btnImportInCreate');

    const appRootEl = document.getElementById('appRoot');
    const sidebarEl = document.querySelector('.sidebar');
    const sidebarResizerEl = document.getElementById('sidebarResizer');
    let sidebarIsResizing = false;
    let sidebarStartX = 0;
    let sidebarStartWidth = 0;
    const SIDEBAR_MIN_WIDTH = 200;
    const SIDEBAR_MAX_WIDTH = 600;

    if (sidebarResizerEl && appRootEl && sidebarEl) {
      const applySidebarWidth = (w) => {
        window.__sidebarWidthPx = w;
        appRootEl.style.gridTemplateColumns = `96px ${w}px 6px minmax(0, 1fr)`;
      };

      const initialRect = sidebarEl.getBoundingClientRect();
      if (initialRect.width) {
        applySidebarWidth(initialRect.width);
      }

      sidebarResizerEl.addEventListener('mousedown', (e) => {
        e.preventDefault();
        sidebarIsResizing = true;
        sidebarStartX = e.clientX;
        sidebarStartWidth = sidebarEl.getBoundingClientRect().width;
        document.body.classList.add('resizing');
        document.addEventListener('mousemove', onSidebarResizeMove);
        document.addEventListener('mouseup', onSidebarResizeEnd);
      });

      function onSidebarResizeMove(e) {
        if (!sidebarIsResizing) return;
        let newWidth = sidebarStartWidth + (e.clientX - sidebarStartX);
        if (newWidth < SIDEBAR_MIN_WIDTH) newWidth = SIDEBAR_MIN_WIDTH;
        if (newWidth > SIDEBAR_MAX_WIDTH) newWidth = SIDEBAR_MAX_WIDTH;
        applySidebarWidth(newWidth);
      }

      function onSidebarResizeEnd() {
        if (!sidebarIsResizing) return;
        sidebarIsResizing = false;
        document.body.classList.remove('resizing');
        document.removeEventListener('mousemove', onSidebarResizeMove);
        document.removeEventListener('mouseup', onSidebarResizeEnd);
      }
    }


    // ===== DATA MODEL =====

    function createInitialState() {
      const rootId = 'root';
      return {
        rootId,
        nextId: 1,
        nodes: {
          [rootId]: {
            id: rootId,
            type: 'category',
            name: '–ú–æ—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π',
            parentId: null,
            children: [],
            cards: [],
            config: null
          }
        }
      };
    }

    const STORAGE_KEY = 'exam-helper-state-v1';

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return createInitialState();
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object' || !parsed.nodes) {
          return createInitialState();
        }
        return parsed;
      } catch (e) {
        console.warn('Failed to load state, using initial', e);
        return createInitialState();
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn('Failed to save state', e);
      }
    }

    let state = loadState();
    let currentNodeId = state.rootId;
    let quizState = null;
    let factsState = null;
    let treeExpanded = {};
    let sidebarViewNodeId = state.rootId;

    // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (item:–∫–æ—Ä–Ω–∏).
    // –í—à–∏—Ç–∞ –ø—Ä—è–º–æ –≤ —ç—Ç–æ—Ç —Ñ–∞–π–ª –∫–∞–∫ embeddedDeveloperDB,
    // –∞ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ exam-db.json —Ä—è–¥–æ–º —Å HTML ‚Äî –ø–æ–¥–º–µ–Ω—è–µ—Ç—Å—è —Å–≤–µ–∂–µ–π –≤–µ—Ä—Å–∏–µ–π.
    const embeddedDeveloperDB = {"rootId": "root", "nextId": 141, "nodes": {"root": {"id": "root", "name": "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏", "type": "category", "parentId": null, "children": ["n1"], "cards": []}, "n1": {"id": "n1", "name": "–ò—Å—Ç–æ—Ä–∏—è –ë–µ–ª–∞—Ä—É—Å–∏", "type": "category", "parentId": "root", "children": ["n2"], "config": {"scope": "subject", "preset": "history"}, "cards": []}, "n2": {"id": "n2", "name": "–í–ö–õ", "type": "category", "parentId": "n1", "children": ["n3", "n83"], "cards": []}, "n3": {"id": "n3", "name": "–ö–Ω—è–∑—å—è", "type": "category", "parentId": "n2", "children": ["n9", "n26", "n32", "n40", "n46", "n56"], "cards": []}, "n9": {"id": "n9", "name": "–ú–∏–Ω–¥–æ–≤–≥", "type": "category", "parentId": "n3", "children": ["n10", "n23", "n74"], "cards": []}, "n10": {"id": "n10", "name": "–ì–æ–¥–∞", "type": "characteristic", "parentId": "n9", "children": [], "factType": "years", "cards": [{"id": "n11", "kind": "years", "event": "–ú–∏–Ω–¥–æ–≤–≥ —É–∂–µ –∏–º–µ–ª –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—É—é –≤–ª–∞—Å—Ç—å –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞–ª –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é —á–∞—Å—Ç—å –ª–∏—Ç–æ–≤—Å–∫–∏—Ö –∑–µ–º–µ–ª—å - \"–õ–∏—Ç–≤–∞ –ú–∏–Ω–¥–æ–≤–≥–∞\", —Ö–æ—Ç—è –µ—â–µ –Ω–µ –ø—Ä–∞–≤–∏–ª –≤—Å–µ–π –õ–∏—Ç–≤–æ–π", "timeRaw": "1235", "era": "–Ω. —ç.", "person": "–ú–∏–Ω–¥–æ–≤–≥"}, {"id": "n12", "kind": "years", "event": "–ø—Ä–æ–∏–∑–æ—à–ª–∞ –±–∏—Ç–≤–∞ –ø–æ–¥ –®—è—É–ª—è–µ–º, –≥–¥–µ –ª–∏—Ç–æ–≤—Ü—ã, –≤–æ –≥–ª–∞–≤–µ –ú–∏–Ω–¥–æ–≤–≥–∞, —Ä–∞–∑–≥—Ä–æ–º–∏–ª–∏ –û—Ä–¥–µ–Ω –º–µ—á–µ–Ω–æ—Å—Ü–µ–≤", "timeRaw": "1236", "era": "–Ω. —ç.", "person": "–ú–∏–Ω–¥–æ–≤–≥"}, {"id": "n13", "kind": "years", "event": "–ú–∏–Ω–¥–æ–≤–≥ —Å—Ç–∞–ª –∫–Ω—è–∑–µ–º –ù–æ–≤–æ–≥–æ—Ä–æ–¥—Å–∫–æ–≥–æ(–ù–æ–≤–æ–≥—Ä—É–¥–æ–∫) –∫–Ω—è–∂–µ—Å—Ç–≤–∞", "timeRaw": "1240", "era": "–Ω. —ç.", "person": "–ú–∏–Ω–¥–æ–≤–≥"}, {"id": "n14", "kind": "years", "event": "–ú–∏–Ω–¥–æ–≤–≥ –ø—Ä–∏–Ω—è–ª –ø—Ä–∞–≤–æ—Å–ª–∞–≤–∏–µ", "timeRaw": "1246", "era": "–Ω. —ç.", "person": "–ú–∏–Ω–¥–æ–≤–≥"}, {"id": "n15", "kind": "years", "event": "–ú–∏–Ω–¥–æ–≤–≥ –ø—Ä–∏–Ω—è–ª –∫–∞—Ç–æ–ª–∏—á–µ—Å—Ç–≤–æ", "timeRaw": "1251", "era": "–Ω. —ç.", "person": "–ú–∏–Ω–¥–æ–≤–≥"}, {"id": "n16", "kind": "years", "event": "–ú–∏–Ω–¥–æ–≤–≥ –∫–æ—Ä–æ–Ω–æ–≤–∞–ª—Å—è –≤ –ù–æ–≤–≥–æ—Ä–æ–¥–∫–µ (–ú–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–∞—Ç–æ–π —Å–æ–∑–¥–∞–Ω–∏—è –í–ö–õ)", "timeRaw": "1253", "era": "–Ω. —ç.", "person": "–ú–∏–Ω–¥–æ–≤–≥"}, {"id": "n17", "kind": "years", "event": "–ø—Ä–æ–∏–∑–æ—à–ª–∞ –±–∏—Ç–≤–∞ –Ω–∞ –æ–∑–µ—Ä–µ –î—É—Ä–±–µ, –ø–æ–¥ –∫–æ–º–∞–Ω–¥–æ–≤–∞–Ω–∏–µ–º –ú–∏–Ω–¥–æ–≤–≥–∞, –ø—Ä–æ—Ç–∏–≤ –¢–µ–≤—Ç–æ–Ω—Å–∫–æ–≥–æ –æ—Ä–¥–µ–Ω–∞", "timeRaw": "1260", "era": "–Ω. —ç.", "person": "–ú–∏–Ω–¥–æ–≤–≥"}, {"id": "n18", "kind": "years", "event": "–ú–∏–Ω–¥–æ–≤–≥ —Ä–∞–∑–æ—Ä–≤–∞–ª —Å–æ—é–∑ —Å –∫—Ä–µ—Å—Ç–æ–Ω–æ—Å—Ü–∞–º–∏, –∏ –∑–∞–∫–ª—é—á–∏–ª —Å–æ—é–∑ —Å –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–º –ù–µ–≤—Å–∫–∏–º", "timeRaw": "1261", "era": "–Ω. —ç.", "person": "–ú–∏–Ω–¥–æ–≤–≥"}, {"id": "n19", "kind": "years", "event": "–ú–∏–Ω–¥–æ–≤–≥ –±—ã–ª —É–±–∏—Ç –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∑–∞–≥–æ–≤–æ—Ä–∞ –º–µ–∂–¥—É –¢—Ä–æ–π–Ω–∞—Ç–æ–º, –¢–æ–≤—Ç–∏–≤–∏–ª–æ–º, –î–æ–≤–º–æ–Ω—Ç–æ–º", "timeRaw": "1263", "era": "–Ω. —ç.", "person": "–ú–∏–Ω–¥–æ–≤–≥"}]}, "n23": {"id": "n23", "name": "–§–∞–∫—Ç", "type": "characteristic", "parentId": "n9", "children": [], "factType": "assertion", "cards": [{"id": "n24", "kind": "assertion", "text": "–ø–µ—Ä–≤—ã–π –∫–Ω—è–∑—å –í–ö–õ, –æ–±—ä–µ–¥–∏–Ω–∏–ª –õ–∏—Ç–≤—É –∏ –ù–æ–≤–æ–≥–æ—Ä–æ–¥—Å–∫–æ–µ –∫–Ω—è–∂–µ—Å—Ç–≤–æ –≤ –æ–¥–Ω–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ", "subject": "–ú–∏–Ω–¥–æ–≤–≥"}, {"id": "n25", "kind": "assertion", "text": "–ì–æ–¥—ã –ø—Ä–∞–≤–ª–µ–Ω–∏—è: 1253 - 1263 –≥–≥.", "subject": "–ú–∏–Ω–¥–æ–≤–≥"}]}, "n26": {"id": "n26", "name": "–¢—Ä–æ–π–Ω–∞—Ç", "type": "category", "parentId": "n3", "children": ["n28"], "cards": []}, "n28": {"id": "n28", "name": "–§–∞–∫—Ç", "type": "characteristic", "parentId": "n26", "children": [], "factType": "years", "cards": [{"id": "n29", "kind": "assertion", "text": "–æ–¥–∏–Ω –∏–∑ –∑–∞–≥–æ–≤–æ—Ä—â–∏–∫–æ–≤ –ø—Ä–æ—Ç–∏–≤ –ú–∏–Ω–¥–æ–≤–≥–∞", "subject": "–¢—Ä–æ–π–Ω–∞—Ç"}, {"id": "n30", "kind": "assertion", "text": "—Å—Ç–∞–ª –∫–Ω—è–∑–µ–º –í–ö–õ –ø–æ—Å–ª–µ —É–±–∏–π—Å—Ç–≤–∞ –ú–∏–Ω–¥–æ–≤–≥–∞", "subject": "–¢—Ä–æ–π–Ω–∞—Ç"}, {"id": "n31", "kind": "assertion", "text": "–µ–≥–æ –ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–ª–æ—Å—å –º–µ–∂–¥–æ—É—Å–æ–±–∏—Ü–∞–º–∏ –∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å—é", "subject": "–¢—Ä–æ–π–Ω–∞—Ç"}]}, "n32": {"id": "n32", "name": "–í–æ–π—à–µ–ª–∫", "type": "category", "parentId": "n3", "children": ["n33"], "cards": []}, "n33": {"id": "n33", "name": "–§–∞–∫—Ç", "type": "characteristic", "parentId": "n32", "children": [], "factType": "assertion", "cards": [{"id": "n34", "kind": "assertion", "text": "—Å—ã–Ω –ú–∏–Ω–¥–æ–≤–≥–∞", "subject": "–í–æ–π—à–µ–ª–∫"}, {"id": "n35", "kind": "assertion", "text": "–ø—Ä–∏–Ω—è–ª –º–æ–Ω–∞—à–µ—Å—Ç–≤–æ", "subject": "–í–æ–π—à–µ–ª–∫"}, {"id": "n36", "kind": "assertion", "text": "–ø–æ—Å–ª–µ —É–±–∏–π—Å—Ç–≤–∞ –¢—Ä–æ–π–Ω–∞—Ç–∞ –≤–µ—Ä–Ω—É–ª—Å—è –∫ –≤–ª–∞—Å—Ç–∏", "subject": "–í–æ–π—à–µ–ª–∫"}, {"id": "n37", "kind": "assertion", "text": "–ø–µ—Ä–µ–¥–∞–ª –≤–ª–∞—Å—Ç—å –®–≤–∞—Ä–Ω—É", "subject": "–í–æ–π—à–µ–ª–∫"}, {"id": "n38", "kind": "assertion", "text": "–±—ã–ª —É–±–∏—Ç –õ–µ–≤–æ–º –î–∞–Ω–∏–ª–æ–≤–∏—á–µ–º", "subject": "–í–æ–π—à–µ–ª–∫"}, {"id": "n39", "kind": "assertion", "text": "–µ–≥–æ –ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±—Å—Ç–≤–æ–≤–∞–ª–æ —É–∫—Ä–µ–ø–ª–µ–Ω–∏—é —Ö—Ä–∏—Å—Ç–∏–∞–Ω—Å—Ç–≤–∞", "subject": "–í–æ–π—à–µ–ª–∫"}]}, "n40": {"id": "n40", "name": "–¢—Ä–æ–π–¥–µ–Ω—å", "type": "category", "parentId": "n3", "children": ["n41", "n43"], "cards": []}, "n41": {"id": "n41", "name": "–§–∞–∫—Ç", "type": "characteristic", "parentId": "n40", "children": [], "factType": "assertion", "cards": [{"id": "n42", "kind": "assertion", "text": "–æ–¥–∏–Ω –∏–∑ –∫–Ω—è–∑–µ–π –í–ö–õ, –ø—Ä–∏—à—ë–ª –∫ –≤–ª–∞—Å—Ç–∏ –ø–æ—Å–ª–µ –í–æ–π—à–µ–ª–∫–∞", "subject": "–¢—Ä–æ–π–¥–µ–Ω—å"}]}, "n43": {"id": "n43", "name": "–ì–æ–¥–∞", "type": "characteristic", "parentId": "n40", "children": [], "factType": "years", "cards": [{"id": "n44", "kind": "years", "event": "–¢—Ä–æ–π–¥–µ–Ω—å —Ä–∞–∑–±–∏–ª —Ç–∞—Ç–∞—Ä –≤–æ–∑–ª–µ –ì—Ä–æ–¥–Ω–æ –∏ –°–ª–æ–Ω–∏–º–∞", "timeRaw": "1277", "era": "–Ω. —ç.", "person": "–¢—Ä–æ–π–¥–µ–Ω—å"}, {"id": "n45", "kind": "years", "event": "–¢—Ä–æ–π–¥–µ–Ω—å –≤–æ–µ–≤–∞–ª —Å –∫—Ä–µ—Å—Ç–æ–Ω–æ—Å—Ü–∞–º–∏ –≤–æ–∑–ª–µ –î–∏–Ω–∞–±—É—Ä–≥–∞", "timeRaw": "1281", "era": "–Ω. —ç.", "person": "–¢—Ä–æ–π–¥–µ–Ω—å"}]}, "n46": {"id": "n46", "name": "–í–∏—Ç–µ–Ω—å", "type": "category", "parentId": "n3", "children": ["n47", "n50"], "cards": []}, "n47": {"id": "n47", "name": "–§–∞–∫—Ç", "type": "characteristic", "parentId": "n46", "children": [], "factType": "assertion", "cards": [{"id": "n48", "kind": "assertion", "text": "–∫–Ω—è–∑—å –í–ö–õ –¥–æ –ì–µ–¥–∏–º–∏–Ω–∞", "subject": "–í–∏—Ç–µ–Ω—å"}, {"id": "n49", "kind": "assertion", "text": "—É–∫—Ä–µ–ø–ª—è–ª –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ –∏ –≤–µ–ª –±–æ—Ä—å–±—É —Å –∫—Ä–µ—Å—Ç–æ–Ω–æ—Å—Ü–∞–º–∏", "subject": "–í–∏—Ç–µ–Ω—å"}, {"id": "n51", "kind": "assertion", "text": "–ø—Ä–∏ –Ω—ë–º –í–ö–õ —É—Å–∏–ª–∏–ª–æ —Å–≤–æ—ë –≤–ª–∏—è–Ω–∏–µ –≤ —Ä–µ–≥–∏–æ–Ω–µ", "subject": "–í–∏—Ç–µ–Ω—å"}]}, "n50": {"id": "n50", "name": "–ì–æ–¥–∞", "type": "characteristic", "parentId": "n46", "children": [], "factType": "years", "cards": [{"id": "n52", "kind": "years", "event": "–±–∏—Ç–≤–∞ –í–∏—Ç–µ–Ω—è —Å –∫—Ä–µ—Å—Ç–æ–Ω–æ—Å—Ü–∞–º–∏ –ø–æ–¥ –†—É–¥–æ–π", "timeRaw": "1298", "era": "–Ω. —ç.", "person": "–í–∏—Ç–µ–Ω—å"}, {"id": "n53", "kind": "years", "event": "—É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –í–∏—Ç–µ–Ω–µ–º –ù–æ–≤–æ–≥—Ä—É–¥–∫–∞ –∫–∞–∫ –æ–¥–Ω–æ–≥–æ –∏–∑ —Ü–µ–Ω—Ç—Ä–æ–≤ –í–ö–õ", "timeRaw": "1316", "era": "–Ω. —ç.", "person": "–í–∏—Ç–µ–Ω—å"}, {"id": "n54", "kind": "years", "event": "–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Å–º–µ—Ä—Ç–∏ –í–∏—Ç–µ–Ω—è", "timeRaw": "1316", "era": "–Ω. —ç.", "person": "–í–∏—Ç–µ–Ω—å"}]}, "n56": {"id": "n56", "name": "–ì–µ–¥–∏–º–∏–Ω", "type": "category", "parentId": "n3", "children": ["n57", "n58"], "cards": []}, "n57": {"id": "n57", "name": "–ì–æ–¥–∞", "type": "characteristic", "parentId": "n56", "children": [], "factType": "years", "cards": [{"id": "n60", "kind": "years", "event": "–ì–µ–¥–∏–º–∏–Ω –æ—Å–Ω–æ–≤–∞–ª –í–∏–ª—å–Ω–æ –∏ –ø–µ—Ä–µ–Ω–µ—Å —Å—Ç–æ–ª–∏—Ü—É –≤ –í–∏–ª—å–Ω–æ", "timeRaw": "1323", "era": "–Ω. —ç.", "person": "–ì–µ–¥–∏–º–∏–Ω"}, {"id": "n65", "kind": "years", "event": "–±–∏—Ç–≤–∞ –ì–µ–¥–∏–º–∏–Ω–∞ –Ω–∞ —Ä–µ–∫–µ –û–∫–º–µ–Ω–µ", "timeRaw": "1331", "era": "–Ω. —ç.", "person": "–ì–µ–¥–∏–º–∏–Ω"}]}, "n58": {"id": "n58", "name": "–§–∞–∫—Ç", "type": "characteristic", "parentId": "n56", "children": [], "factType": "assertion", "cards": [{"id": "n59", "kind": "assertion", "text": "–≤–µ–ª–∏–∫–∞—è –∫–Ω—è–∑—å –í–ö–õ, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∏–ª–∏–ª–æ—Å—å", "subject": "–ì–µ–¥–∏–º–∏–Ω"}, {"id": "n61", "kind": "assertion", "text": "–ø—Ä–∏ –ì–µ–¥–∏–º–∏–Ω–µ –í–ö–õ –∞–∫—Ç–∏–≤–Ω–æ —Ä–∞—Å—à–∏—Ä—è–ª–æ —Å–≤–æ–∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –Ω–∞ –≤–æ—Å—Ç–æ–∫ –∏ –∑–∞–ø–∞–¥", "subject": "–ì–µ–¥–∏–º–∏–Ω"}, {"id": "n62", "kind": "assertion", "text": "–∏–∑–≤–µ—Å—Ç–µ–Ω –¥–∏–ø–ª–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–∏—Å—å–º–∞–º–∏ –∑–∞–ø–∞–¥–Ω–æ–µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–º –ø—Ä–∞–≤–∏—Ç–µ–ª—è–º –∏ –æ—Ä–¥–µ–Ω–∞–º", "subject": "–ì–µ–¥–∏–º–∏–Ω"}, {"id": "n63", "kind": "assertion", "text": "—Å—Ç—Ä–µ–º–∏–ª—Å—è –ø—Ä–∏–≤–ª–µ—á—å –≤ –í–ö–õ —Ä–µ–º–µ—Å–ª–µ–Ω–Ω–∏–∫–æ–≤ –∏ –∫—É–ø—Ü–æ–≤ –∏–∑ –ï–≤—Ä–æ–ø—ã", "subject": "–ì–µ–¥–∏–º–∏–Ω"}, {"id": "n64", "kind": "assertion", "text": "–ø—Ä–∏ –Ω—ë–º –í–ö–õ —É–∫—Ä–µ–ø–∏–ª–æ –ø–æ–∑–∏—Ü–∏–∏ –≤ –±–æ—Ä—å–±–µ —Å –¢–µ–≤—Ç–æ–Ω—Å–∫–∏–º –æ—Ä–¥–µ–Ω–æ–º", "subject": "–ì–µ–¥–∏–º–∏–Ω"}, {"id": "n66", "kind": "assertion", "text": "–¥–∏–Ω–∞—Å—Ç–∏—è –ì–µ–¥–∏–º–∏–Ω–æ–≤–∏—á–µ–π —Å—Ç–∞–ª–∞ –æ–¥–Ω–æ–π –∏–∑ –≤–µ–¥—É—â–∏—Ö –¥–∏–Ω–∞—Å—Ç–∏–π –í–æ—Å—Ç–æ—á–Ω–æ–π –ï–≤—Ä–æ–ø—ã", "subject": "–ì–µ–¥–∏–º–∏–Ω"}, {"id": "n67", "kind": "assertion", "text": "—Å—ã–Ω–æ–≤—å—è –ì–µ–¥–∏–º–∏–Ω–∞ –ø—Ä–∞–≤–∏–ª–∏ –≤ —Ä–∞–∑–Ω—ã—Ö —á–∞—Å—Ç—è—Ö –í–ö–õ –∏ —Å–æ—Å–µ–¥–Ω–∏—Ö –∑–µ–º–ª—è—Ö", "subject": "–ì–µ–¥–∏–º–∏–Ω"}, {"id": "n68", "kind": "assertion", "text": "–ì–µ–¥–∏–º–∏–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—É—é —Ä–µ–ª–∏–≥–∏–æ–∑–Ω—É—é —Ç–µ—Ä–ø–∏–º–æ—Å—Ç—å –≤ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ", "subject": "–ì–µ–¥–∏–º–∏–Ω"}, {"id": "n69", "kind": "assertion", "text": "–ø—Ä–∏ –Ω—ë–º —É–∫—Ä–µ–ø–ª—è–ª–∞—Å—å —Ä–æ–ª—å –í–∏–ª—å–Ω–æ –∫–∞–∫ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏ –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞", "subject": "–ì–µ–¥–∏–º–∏–Ω"}, {"id": "n70", "kind": "assertion", "text": "–µ–≥–æ –ø–æ–ª–∏—Ç–∏–∫–∞ –∑–∞–ª–æ–∂–∏–ª–∞ –æ—Å–Ω–æ–≤—É –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —É—Å–∏–ª–µ–Ω–∏—è –í–ö–õ –ø—Ä–∏ –µ–≥–æ –ø—Ä–µ–µ–º–Ω–∏–∫–∞—Ö", "subject": "–ì–µ–¥–∏–º–∏–Ω"}, {"id": "n71", "kind": "assertion", "text": "–ì–µ–¥–∏–º–∏–Ω —Å—Ç–∞–ª —Ä–æ–¥–æ–Ω–∞—á–∞–ª—å–Ω–∏–∫–æ–º –¥–∏–Ω–∞—Å—Ç–∏–∏, —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å –º–Ω–æ–≥–∏–º–∏ –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–º–∏ –ø—Ä–∞–≤—è—â–∏–º–∏ –¥–æ–º–∞–º–∏", "subject": "–ì–µ–¥–∏–º–∏–Ω"}, {"id": "n72", "kind": "assertion", "text": "–µ–≥–æ –ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ–¥–Ω–∏–º –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–æ–≤ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ—â–∏ –í–ö–õ", "subject": "–ì–µ–¥–∏–º–∏–Ω"}]}, "n74": {"id": "n74", "type": "characteristic", "name": "123", "parentId": "n9", "children": [], "factType": "assertion", "cards": []}, "n83": {"id": "n83", "type": "category", "name": "–°–∏—Å—Ç–µ–º–∞ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–ª–∞—Å—Ç–∏", "parentId": "n2", "children": ["n84", "n112", "n118"], "cards": [], "config": null}, "n84": {"id": "n84", "type": "category", "name": "–í–µ—Ä—Ö–Ω—è—è –≤–ª–∞—Å—Ç—å", "parentId": "n83", "children": ["n87", "n100", "n107"], "cards": [], "config": null}, "n87": {"id": "n87", "type": "category", "name": "–í–ï–õ–ò–ö–ò–ô –ö–ù–Ø–ó–¨ –õ–ò–¢–í–û–°–ö–ò–ô", "parentId": "n84", "children": ["n89", "n94"], "cards": [], "config": null}, "n89": {"id": "n89", "type": "characteristic", "name": "–ù–ê–ò–ú–ò–ù–û–í–ê–ù–ò–Ø", "parentId": "n87", "children": [], "factType": "olist", "cards": [{"id": "n96", "kind": "olist-item", "text": "–í–µ–ª–∏–∫–∏–π –∫–Ω—è–∑—å –ª–∏—Ç–æ–≤—Å–∫–∏–π"}, {"id": "n97", "kind": "olist-item", "text": "–∫–æ—Ä–æ–ª—å"}, {"id": "n98", "kind": "olist-item", "text": "–≥–æ—Å–ø–æ–¥–∞—Ä—å"}, {"id": "n99", "kind": "olist-item", "text": "–∫–æ—Ä–æ–ª—å –ª–∏—Ç–≤—ã –∏ —Ä—É—Å–∏"}]}, "n94": {"id": "n94", "type": "characteristic", "name": "—Ñ–∞–∫—Ç—ã", "parentId": "n87", "children": [], "factType": "assertion", "cards": [{"id": "n95", "kind": "assertion", "text": "–Ω–∞—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –≤–ª–∞—Å—Ç—å", "subject": "–í–ï–õ–ò–ö–ò–ô –ö–ù–Ø–ó–¨ –õ–ò–¢–í–û–°–ö–ò–ô"}]}, "n100": {"id": "n100", "type": "category", "name": "–ø–∞–Ω—ã-—Ä–∞–¥–∞", "parentId": "n84", "children": ["n101"], "cards": [], "config": null}, "n101": {"id": "n101", "type": "characteristic", "name": "—Ñ–∞–∫—Ç—ã", "parentId": "n100", "children": [], "factType": "assertion", "cards": [{"id": "n103", "kind": "assertion", "text": "—Å 14 –≤–µ–∫–∞ - —Å–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω—ã–π –æ—Ä–≥–∞–Ω –ø—Ä–∏ –∫–Ω—è–∑–µ", "subject": "–ø–∞–Ω—ã-—Ä–∞–¥–∞"}, {"id": "n105", "kind": "assertion", "text": "\"–ø—Ä–µ–¥–Ω–µ–π—à–∞—è –ª–∞–≤–∏—Ü–∞\" - –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –¥–µ–π—Å—Ç–≤—É—é—â–∏–π –æ—Ä–≥–∞–Ω –≤–ª–∞—Å—Ç–∏  –≤ —Å—Ç—Ä–∞–Ω–µ (—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è, –º–µ—Å—Ç–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...)", "subject": "–ø–∞–Ω—ã-—Ä–∞–¥–∞"}, {"id": "n106", "kind": "assertion", "text": "1492 –≥–æ–¥, 1506–≥–æ–¥ -–ø—Ä–∏–≤–∏–ª–µ–π –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –†–∞–¥–µ, –æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ –ø–æ–ª–Ω–æ–º–æ—á–∏–π - –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å–Ω—ã–µ –æ—Ä–≥–∞–Ω—ã –≤–ª–∞—Å—Ç–∏", "subject": "–ø–∞–Ω—ã-—Ä–∞–¥–∞"}]}, "n107": {"id": "n107", "type": "category", "name": "—Å–µ–π–º", "parentId": "n84", "children": ["n108"], "cards": [], "config": null}, "n108": {"id": "n108", "type": "characteristic", "name": "—Ñ–∞–∫—Ç—ã", "parentId": "n107", "children": [], "factType": "assertion", "cards": [{"id": "n109", "kind": "assertion", "text": "—Å—å–µ–∑–¥ —à–ª—è—Ö—Ç—ã –≤ –≤–∫–ª", "subject": "—Å–µ–π–º"}, {"id": "n110", "kind": "assertion", "text": "—Å 1511 –≥–æ–¥–∞ —à–ª—è—Ö—Ç–∞ –∑–∞—Å–µ–¥–∞–ª–∞ –ø–æ 2 –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è –æ—Ç –ø–æ–≤–µ—Ç–æ–≤", "subject": "—Å–µ–π–º"}, {"id": "n111", "kind": "assertion", "text": "—Å 14 –≤–µ–∫–∞ - –≤—ã—Å—à–∏–π –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å–Ω—ã–π –æ—Ä–≥–∞–Ω –≤–ª–∞—Å—Ç–∏", "subject": "—Å–µ–π–º"}]}, "n112": {"id": "n112", "type": "category", "name": "—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –≤–ª–∞—Å—Ç—å", "parentId": "n83", "children": ["n114"], "cards": [], "config": null}, "n114": {"id": "n114", "type": "characteristic", "name": "—É—Ä—è–¥–Ω–∏–∫–∏", "parentId": "n112", "children": [], "factType": "term", "cards": [{"id": "n115", "kind": "term", "word": "–∫–∞–Ω—Ü–ª–µ—Ä", "definition": "–∑–∞–≤–µ–¥–æ–≤–∞–ª –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–µ–π, –ø–µ—á–∞—Ç—å—é"}, {"id": "n116", "kind": "term", "word": "–≥–µ—Ç–º–∞–Ω –Ω–∞–∏–≤—ã—Å—à–∏–π", "definition": "–∫–æ–º–∞–Ω–¥–æ–≤–∞–ª –≤–æ–π—Å–∫–æ–º –≤–∫–ª"}, {"id": "n117", "kind": "term", "word": "–ø–æ–¥—Å–∫–∞—Ä–±–∏–π –∑–µ–º–∫—Å–∫–∏–π", "definition": "–∑–∞–≤–µ–¥–æ–≤–∞–ª –∫–∞–∑–Ω–æ–π (—Å–∫–∞—Ä–±–æ–º) –≤–∫–ª"}]}, "n118": {"id": "n118", "type": "category", "name": "–º–µ—Å—Ç–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "parentId": "n83", "children": ["n124"], "cards": [], "config": null}, "n121": {"id": "n121", "type": "characteristic", "name": "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã", "parentId": "n124", "children": [], "factType": "term", "cards": [{"id": "n122", "kind": "term", "word": "–í–æ–µ–≤–æ–¥—Å—Ç–≤–æ", "definition": "–∫—Ä—É–ø–Ω–µ–π—à–∞—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞, –¥–µ–ª–∏–ª–æ—Å—å –Ω–∞ –ø–æ–≤–µ—Ç—ã (–Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ª–∞–¥ - –æ–±–ª–∞—Å—Ç–∏)"}, {"id": "n123", "kind": "term", "word": "–ø–æ–≤–µ—Ç = –≤–æ–ª–æ—Å—Ç—å", "definition": "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ (–Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ª–∞–¥ - —Ä–∞–π–æ–Ω)"}]}, "n124": {"id": "n124", "type": "category", "name": "–ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–ò–í–ù–´–ï –ï–î–ò–ù–ò–¶–´", "parentId": "n118", "children": ["n121", "n125", "n126"], "cards": [], "config": null}, "n125": {"id": "n125", "type": "category", "name": "–í–æ–µ–≤–æ–¥—Å—Ç–≤–æ", "parentId": "n124", "children": ["n131"], "cards": [], "config": null}, "n126": {"id": "n126", "type": "category", "name": "–ø–æ–≤–µ—Ç(–≤–æ–ª–æ—Å—Ç—å)", "parentId": "n124", "children": ["n137", "n140"], "cards": [], "config": null}, "n131": {"id": "n131", "type": "characteristic", "name": "–ü–†–ï–î–°–¢–ê–í–ò–¢–ï–õ–ò –í–û–ï–í–û–î–°–¢–í–ê", "parentId": "n125", "children": [], "factType": "term", "cards": [{"id": "n132", "kind": "term", "word": "–≤–æ–µ–≤–æ–¥–∞", "definition": "—Å–º–µ–Ω–∏–ª –∫–Ω—è–∂–µ—Å–∫–æ–≥–æ –Ω–∞–º–µ—Å—Ç–Ω–∏–∫–∞; –∏–∑ –º–µ—Å—Ç–Ω–æ–π —à–ª—è—Ö—Ç—ã; –Ω–∞–∑–Ω–∞—á–µ–Ω –ø–æ–∂–∏–∑–Ω–µ–Ω–Ω–æ; –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª –Ω–∞ –∑–∞—Å–µ–¥–∞–Ω–∏–∏ —Ä–∞–¥—ã –∏ —Å–µ–π–º–∞"}, {"id": "n133", "kind": "term", "word": "–∫–∞—à—Ç–µ–ª—è–Ω", "definition": "–≤–æ–∑–≥–ª–∞–≤–ª—è–ª –≤–æ–π—Å–∫–æ –≤–æ–µ–≤–æ–¥—Å—Ç–≤–∞"}, {"id": "n135", "kind": "term", "word": "–≥–æ—Ä–æ–¥–Ω–∏—á–∏–π", "definition": "–æ—Ç–≤–µ—á–∞–ª –∑–∞ —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –≤–æ–µ–≤–æ–¥—Å–∫–æ–≥–æ –∑–∞–º–∫–∞"}, {"id": "n136", "kind": "term", "word": "–∫–ª—é—á–Ω–∏–∫", "definition": "–æ—Ç–≤–µ—á–∞–ª –∑–∞ —Å–±–æ—Ä –ø–æ–¥–∞—Ç–µ–π"}]}, "n137": {"id": "n137", "type": "characteristic", "name": "–ü–†–ï–î–°–¢–ê–í–ò–¢–ï–õ–ò –ø–æ–≤–µ—Ç–∞", "parentId": "n126", "children": [], "factType": "term", "cards": [{"id": "n138", "kind": "term", "word": "—Å—Ç–∞—Ä–æ—Å—Ç–∞", "definition": "—Ä—É–∫–æ–≤–æ–¥–∏–ª —Ä–∞–π–æ–Ω–æ–º, –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å –º–µ—Å—Ç–Ω–æ–π —à–ª—è—Ö—Ç—ã"}, {"id": "n139", "kind": "term", "word": "–¢–∏—É–Ω", "definition": "—Å—Ç–∞—Ä–µ—Ü,, –æ—Ç–≤–µ—á–∞–ª –∑–∞ —Å–±–æ—Ä –ø–æ–¥–∞—Ç–µ–π –≤ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—É—é –∫–∞–∑–Ω—É"}]}, "n140": {"id": "n140", "type": "characteristic", "name": "–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–≤–µ—Ç–∞", "parentId": "n126", "children": [], "factType": "term", "cards": [{"id": "n141", "kind": "term", "word": "–≤–æ–ª–æ—Å—Ç—å(10-30 —Å—ë–ª)", "definition": "—Å–µ–ª—å—Å–∫–∏–π –≤–æ–π—Ç"}]}}};
    window.__developerState = embeddedDeveloperDB;

    (function loadDeveloperState() {
      try {
        fetch('exam-db.json')
          .then(resp => {
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            return resp.json();
          })
          .then(data => {
            if (data && typeof data === 'object' && data.nodes && data.rootId) {
              window.__developerState = data;
              // –û–±–Ω–æ–≤–∏–º —ç–∫—Ä–∞–Ω –∫–æ—Ä–Ω–µ–π, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –æ—Ç–∫—Ä—ã—Ç
              try {
                renderRootsScreen();
              } catch (e) {
                console.warn('Cannot re-render roots screen after developer DB load', e);
              }
            }
          })
          .catch(err => {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–Ω–µ—à–Ω—é—é exam-db.json —Å –∫–æ—Ä–Ω—è–º–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é):', err);
          });
      } catch (err) {
        console.warn('fetch exam-db.json –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é)', err);
      }
    })();

    function genId() {
      state.nextId = (state.nextId || 1) + 1;
      return 'n' + state.nextId;
    }

    function getNode(id) {
      return state.nodes[id] || null;
    }

    function createCategory(name, parentId, config = null) {
      const id = genId();
      state.nodes[id] = {
        id,
        type: 'category',
        name: name || '',
        parentId: parentId || state.rootId,
        children: [],
        cards: [],
        config: config || null
      };
      const parent = getNode(parentId || state.rootId);
      if (parent) {
        parent.children = parent.children || [];
        parent.children.push(id);
      }
      saveState();
      return id;
    }

    function createCharacteristic(name, parentId, factType = 'assertion') {
      const id = genId();
      const node = {
        id,
        type: 'characteristic',
        name: name || '',
        parentId: parentId || state.rootId,
        children: [],
        factType: factType || 'assertion',
        cards: []
      };
      state.nodes[id] = node;
      const parent = getNode(parentId || state.rootId);
      if (parent) {
        parent.children = parent.children || [];
        parent.children.push(id);
      }
      saveState();
      return id;
    }

    function renameNode(id, name) {
      const n = getNode(id);
      if (!n) return;
      if (!name || !name.trim()) return;
      n.name = name.trim();
      saveState();
    }

    function deleteNodeAndDescendants(id) {
      if (id === state.rootId) return;
      const node = getNode(id);
      if (!node) return;
      const parent = getNode(node.parentId);
      if (parent) {
        parent.children = (parent.children || []).filter(c => c !== id);
      }
      function walkRemove(nodeId) {
        const n = getNode(nodeId);
        if (!n) return;
        (n.children || []).forEach(ch => walkRemove(ch));
        delete state.nodes[nodeId];
      }
      walkRemove(id);
      saveState();
    }

    function moveNode(nodeId, newParentId, afterSiblingId = null) {
      const node = getNode(nodeId);
      const newParent = getNode(newParentId);
      if (!node || !newParent) return;
      if (node.id === state.rootId) return;

      // –Ω–µ –¥–∞—ë–º –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —É–∑–µ–ª –≤–Ω—É—Ç—Ä—å —Å–∞–º–æ–≥–æ —Å–µ–±—è –∏–ª–∏ —Å–≤–æ–µ–≥–æ –ø–æ—Ç–æ–º–∫–∞
      let p = newParent;
      while (p) {
        if (p.id === node.id) return;
        p = getNode(p.parentId);
      }

      const oldParent = getNode(node.parentId);
      if (oldParent && oldParent.children) {
        oldParent.children = oldParent.children.filter(c => c !== node.id);
      }

      newParent.children = newParent.children || [];

      // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä: –≤—Å—Ç–∞–≤–∏—Ç—å –≤ —Å–∞–º–æ–µ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–µ–π
      if (afterSiblingId === '__FIRST__') {
        newParent.children = newParent.children.filter(c => c !== node.id);
        newParent.children.unshift(node.id);
      }
      // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–æ—Å–µ–¥–∞
      else if (afterSiblingId && newParent.children.includes(afterSiblingId)) {
        const idx = newParent.children.indexOf(afterSiblingId);
        // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —É–¥–∞–ª–∏–º —É–∑–µ–ª, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –±—ã–ª –≤ —ç—Ç–æ–º —Å–ø–∏—Å–∫–µ
        newParent.children = newParent.children.filter(c => c !== node.id);
        newParent.children.splice(idx + 1, 0, node.id);
      } else {
        // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–ª–∞–¥—ë–º –≤ –∫–æ–Ω–µ—Ü
        if (!newParent.children.includes(node.id)) {
          newParent.children.push(node.id);
        }
      }

      node.parentId = newParent.id;
      saveState();
    }

    // --- FACT CARDS ---

    function addAssertionCard(nodeId, text, subject) {
      const node = getNode(nodeId);
      if (!node || node.type !== 'characteristic') return;
      node.factType = 'assertion';
      node.cards = node.cards || [];
      node.cards.push({
        id: genId(),
        kind: 'assertion',
        text: (text || '').trim(),
        subject: (subject || '').trim() || null
      });
      saveState();
    }

    function addYearsCard(nodeId, event, timeRaw, era, person, timeExact) {
      const node = getNode(nodeId);
      if (!node || node.type !== 'characteristic') return;
      node.factType = 'years';
      node.cards = node.cards || [];
      node.cards.push({
        id: genId(),
        kind: 'years',
        event: (event || '').trim(),
        timeRaw: (timeRaw || '').trim(),
        era: (era || '').trim(),
        person: (person || '').trim() || null,
        timeExact: (timeExact || '').trim() || null
      });
      saveState();
    }

    function addOListItem(nodeId, text) {
      const node = getNode(nodeId);
      if (!node || node.type !== 'characteristic') return;
      node.factType = 'olist';
      node.cards = node.cards || [];
      node.cards.push({
        id: genId(),
        kind: 'olist-item',
        text: (text || '').trim()
      });
      saveState();
    }

    function addTermCard(nodeId, word, definition) {
      const node = getNode(nodeId);
      if (!node || node.type !== 'characteristic') return;
      node.factType = 'term';
      node.cards = node.cards || [];
      node.cards.push({
        id: genId(),
        kind: 'term',
        word: (word || '').trim(),
        definition: (definition || '').trim()
      });
      saveState();
    }

    
    function updateCard(nodeId, cardId, patch) {
      const node = getNode(nodeId);
      if (!node || node.type !== 'characteristic') return;
      const cards = node.cards || [];
      const card = cards.find(c => c.id === cardId);
      if (!card) return;
      Object.assign(card, patch);
      saveState();
    }

function deleteCard(nodeId, cardId) {
      const node = getNode(nodeId);
      if (!node || node.type !== 'characteristic') return;
      node.cards = (node.cards || []).filter(c => c.id !== cardId);
      saveState();
    }

    function moveCard(nodeId, cardId, direction) {
      const node = getNode(nodeId);
      if (!node || node.type !== 'characteristic') return;
      const cards = node.cards || [];
      const index = cards.findIndex(c => c.id === cardId);
      if (index === -1) return;
      const newIndex = direction === 'up' ? index - 1 : index + 1;
      if (newIndex < 0 || newIndex >= cards.length) return;
      const [moved] = cards.splice(index, 1);
      cards.splice(newIndex, 0, moved);
      saveState();
    }

    // ===== UTILS =====

    function isValidYearOrPeriod(str) {
      const s = (str || '').trim();
      if (!s) return false;
      const single = /^\d{1,4}$/;
      const range = /^(\d{1,4})\s*[-‚Äì‚Äî]\s*(\d{1,4})$/;
      return single.test(s) || range.test(s);
    }

    function normalizeMonthName(monthRaw) {
      const m = (monthRaw || '').toLowerCase().trim();
      if (!m) return '';
      // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã (–ª–∞—Ç–∏–Ω–∏—Ü–∞ + –∫–∏—Ä–∏–ª–ª–∏—Ü–∞)
      const s = m.normalize('NFD').replace(/[^a-z–∞-—è—ë]+/g, '');
      return s;
    }

    function getMaxDaysForMonth(monthRaw) {
      const m = normalizeMonthName(monthRaw);
      if (!m) return 31;
      const ru = {
        '—è–Ω–≤–∞—Ä—å': 31, '—è–Ω–≤–∞—Ä—è': 31,
        '—Ñ–µ–≤—Ä–∞–ª—å': 28, '—Ñ–µ–≤—Ä–∞–ª—è': 28,
        '–º–∞—Ä—Ç': 31, '–º–∞—Ä—Ç–∞': 31,
        '–∞–ø—Ä–µ–ª—å': 30, '–∞–ø—Ä–µ–ª—è': 30,
        '–º–∞–π': 31, '–º–∞—è': 31,
        '–∏—é–Ω—å': 30, '–∏—é–Ω—è': 30,
        '–∏—é–ª—å': 31, '–∏—é–ª—è': 31,
        '–∞–≤–≥—É—Å—Ç': 31, '–∞–≤–≥—É—Å—Ç–∞': 31,
        '—Å–µ–Ω—Ç—è–±—Ä—å': 30, '—Å–µ–Ω—Ç—è–±—Ä—è': 30,
        '–æ–∫—Ç—è–±—Ä—å': 31, '–æ–∫—Ç—è–±—Ä—è': 31,
        '–Ω–æ—è–±—Ä—å': 30, '–Ω–æ—è–±—Ä—è': 30,
        '–¥–µ–∫–∞–±—Ä—å': 31, '–¥–µ–∫–∞–±—Ä—è': 31
      };
      if (ru[m] != null) return ru[m];
      const en = {
        'january': 31,
        'february': 28,
        'march': 31,
        'april': 30,
        'may': 31,
        'june': 30,
        'july': 31,
        'august': 31,
        'september': 30,
        'october': 31,
        'november': 30,
        'december': 31
      };
      if (en[m] != null) return en[m];
      return 31;
    }

    function formatYears(card) {
      const raw = (card.timeRaw || '').trim();
      const exact = (card.timeExact || '').trim();
      if (!raw && !exact) return '';

      const hasDash =
        raw.includes('-') || raw.includes('‚Äì') || raw.includes('‚Äî');

      let res = '';
      if (exact && raw && !hasDash) {
        // –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∫–µ–π—Å: ¬´14 –∞–≤–≥—É—Å—Ç–∞ 1385 –≥.¬ª
        res = exact + ' ' + raw;
      } else if (raw) {
        res = raw;
      } else {
        // –≤–¥—Ä—É–≥ —É–∫–∞–∑–∞–Ω–∞ —Ç–æ–ª—å–∫–æ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –±–µ–∑ –≥–æ–¥–∞
        res = exact;
      }

      const era = (card.era || '').trim();

      // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ –≠–†–ê (–∫—Ä–æ–º–µ ¬´–Ω. —ç.¬ª), —Ç–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º ¬´–≥.¬ª/¬´–≥–≥.¬ª,
      // —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´14 –≤–µ–∫¬ª, –∞ –Ω–µ ¬´14 –≥. –≤–µ–∫¬ª.
      if (raw && (!era || era === '–Ω. —ç.')) {
        res += hasDash ? ' –≥–≥.' : ' –≥.';
      }

      if (era && era !== '–Ω. —ç.') {
        res += ' ' + era;
      }
      return res;
    }

    function formatFactDisplay(node, card) {
      const type = node.factType || 'assertion';
      if (type === 'assertion') {
        const subj = card.subject || node.name || '';
        return subj ? subj + ': ' + (card.text || '') : (card.text || '');
      }
      if (type === 'years') {
        const y = formatYears(card);
        const ev = card.event || '';
        const person = card.person || '';
        let prefix = '';
        if (person) prefix = person + ': ' + ev;
        else prefix = ev;
        return y ? prefix + ' ‚Äî ' + y : prefix;
      }
      if (type === 'olist') {
        return '‚Ä¢ ' + (card.text || '');
      }
      if (type === 'term') {
        return (card.word || '') + ' ‚Äî ' + (card.definition || '');
      }
      return '';
    }

    function getCategorySubtreeNodeIds(nodeId) {
      const res = [];
      function walk(id) {
        res.push(id);
        const n = getNode(id);
        if (!n) return;
        (n.children || []).forEach(ch => walk(ch));
      }
      walk(nodeId);
      return res;
    }

    function getCategoryCharacteristics(nodeId) {
      return getCategorySubtreeNodeIds(nodeId)
        .map(id => getNode(id))
        .filter(n => n && n.type === 'characteristic');
    }

    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function pickRandom(arr, count, exceptVal) {
      const base = arr.filter(x => x !== exceptVal);
      return shuffle(base).slice(0, count);
    }

    // ===== RENDER: BREADCRUMB & TREE =====

    function buildBreadcrumb(nodeId) {
      const path = [];
      let n = getNode(nodeId);
      while (n) {
        path.unshift(n);
        if (!n.parentId) break;
        n = getNode(n.parentId);
      }
      breadcrumbEl.innerHTML = '';
      path.forEach((node, idx) => {
        if (idx > 0) {
          const sep = document.createElement('span');
          sep.textContent = '‚Üí';
          sep.className = 'breadcrumb-sep';
          breadcrumbEl.appendChild(sep);
        }
        const span = document.createElement('span');
        span.textContent = node.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)';
        if (idx < path.length - 1) {
          span.onclick = () => {
            currentNodeId = node.id;
            quizState = null;
            factsState = null;
            if (node.type === 'category') {
              sidebarViewNodeId = node.id;
            } else if (node.parentId) {
              sidebarViewNodeId = node.parentId;
            }
            render();
          };
        } else {
          span.style.fontWeight = '500';
        }
        breadcrumbEl.appendChild(span);
      });
    }



// helpers for —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏–∏
function isNodeExpanded(id, depth) {
  if (Object.prototype.hasOwnProperty.call(treeExpanded, id)) {
    return !!treeExpanded[id];
  }
  // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ—Ä–Ω–µ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (depth = 0) —Ä–∞—Å–∫—Ä—ã—Ç—ã, –≤–ª–æ–∂–µ–Ω–Ω—ã–µ ‚Äî —Å–≤–µ—Ä–Ω—É—Ç—ã
  return depth === 0;
}

function setAllTreeExpanded(expanded) {
  Object.keys(state.nodes || {}).forEach(id => {
    const n = getNode(id);
    if (n && n.type === 'category') {
      treeExpanded[id] = !!expanded;
    }
  });
  renderTree();
}

function renderTree() {
  if (!treeRootEl) return;

  // –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏:
  // sidebarViewNodeId ‚Äî "—Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞", –≤ –∫–æ—Ç–æ—Ä–æ–π –º—ã —Å–µ–π—á–∞—Å –Ω–∞—Ö–æ–¥–∏–º—Å—è.
  let viewNode = getNode(sidebarViewNodeId);
  if (!viewNode) {
    viewNode = getNode(state.rootId);
    sidebarViewNodeId = viewNode ? viewNode.id : null;
  }
  if (!viewNode) return;

  const isRoot = !viewNode.parentId;

  treeRootEl.innerHTML = '';

  // –®–∞–ø–∫–∞ –∫–∞–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞—Ö / –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–µ:
  // —Å–ª–µ–≤–∞ ‚Äî –∫–Ω–æ–ø–∫–∞ ¬´–Ω–∞–∑–∞–¥¬ª, –ø–æ —Ü–µ–Ω—Ç—Ä—É ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç—Å–µ–∫–∞.
  const header = document.createElement('div');
  header.className = 'hier-header';

  const left = document.createElement('div');
  left.className = 'hier-fx';

  if (!isRoot) {
    const backBtn = document.createElement('button');
    backBtn.type = 'button';
    backBtn.className = 'hier-fx-btn';
    backBtn.textContent = '‚Üê –ù–ê–ó–ê–î';
    backBtn.onclick = (e) => {
      e.stopPropagation();
      const parent = getNode(viewNode.parentId);
      if (parent) {
        sidebarViewNodeId = parent.id;
        currentNodeId = parent.id;
        quizState = null;
        factsState = null;
        render();
      }
    };
    left.appendChild(backBtn);
  } else {
    const label = document.createElement('div');
    label.textContent = '–í–°–ï –û–¢–°–ï–ö–ò';
    left.appendChild(label);
  }

  const right = document.createElement('div');
  right.className = 'hier-fx-buttons';

  const title = document.createElement('div');
  title.className = 'hier-name';
  title.textContent = viewNode.name || '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏';

  // –ö–ª–∏–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –æ—Ç—Å–µ–∫–∞ –≤ —à–∞–ø–∫–µ ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É —Å–ø—Ä–∞–≤–∞
  if (!isRoot) {
    title.classList.add('hier-name-link');
    title.title = '–û—Ç–∫—Ä—ã—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É —ç—Ç–æ–≥–æ –æ—Ç—Å–µ–∫–∞';
    title.style.cursor = 'pointer';
    title.onclick = (e) => {
      e.stopPropagation();
      // –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç—Å–µ–∫–∞ –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏
      currentNodeId = viewNode.id;
      quizState = null;
      factsState = null;
      render();
    };
  }

  right.appendChild(title);

  header.appendChild(left);
  header.appendChild(right);
  treeRootEl.appendChild(header);

  // –°–ø–∏—Å–æ–∫ "–∫–∞–∫ –≤ —á–∞—Ç–µ": –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä—è–º—ã—Ö –¥–µ—Ç–µ–π —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç—Å–µ–∫–∞.
  const children = (viewNode.children || [])
    .map(id => getNode(id))
    .filter(n => !!n);

  if (!children.length) {
    const empty = document.createElement('div');
    empty.className = 'hint';
    empty.style.marginTop = '6px';
    empty.textContent = '–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ. –°–æ–∑–¥–∞–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω.';
    treeRootEl.appendChild(empty);
    return;
  }

  children.forEach(n => {
    const row = document.createElement('div');
    row.className = 'hier-row';
    row.dataset.id = n.id;
    row.setAttribute('draggable', 'true');

    if (n.type === 'category') row.classList.add('hier-row-category');
    else if (n.type === 'characteristic') row.classList.add('hier-row-characteristic');
    if (n.id === currentNodeId) row.classList.add('hier-row-current');

    // –±–µ–∑ –ª–µ—Å–µ–Ω–∫–∏, –≤—Å—ë –Ω–∞ –æ–¥–Ω–æ–º —É—Ä–æ–≤–Ω–µ
    row.style.paddingLeft = '8px';

    const tag = document.createElement('div');
    tag.className = 'hier-tag';
    if (n.type === 'category') tag.textContent = '–û–¢–°–ï–ö';
    else if (n.type === 'characteristic') tag.textContent = '–ü–ê–¢–¢–ï–†–ù';
    else tag.textContent = '–û–¢–°–ï–ö';

    const name = document.createElement('div');
    name.className = 'hier-name';
    name.textContent = n.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)';

    row.appendChild(tag);
    row.appendChild(name);

    // –º–∞–ª–µ–Ω—å–∫–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, —á—Ç–æ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–æ–∂–Ω–æ "–∑–∞–π—Ç–∏ –≤–Ω—É—Ç—Ä—å"
    if (n.type === 'category') {
      const arrow = document.createElement('div');
      arrow.style.marginLeft = 'auto';
      arrow.style.fontSize = '11px';
      arrow.textContent = '‚ñ∏';
      row.appendChild(arrow);
    }

    row.onclick = () => {
      currentNodeId = n.id;
      quizState = null;
      factsState = null;

      if (n.type === 'category') {
        sidebarViewNodeId = n.id; // –∑–∞—Ö–æ–¥–∏–º –≤–Ω—É—Ç—Ä—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ç—Å–µ–∫–∞
      }

      render();
    };

    treeRootEl.appendChild(row);
  });
}
function attachSectionToggles(wrapper) {
      const sections = wrapper.querySelectorAll('.section');
      sections.forEach(sec => {
        const header = sec.querySelector('.section-header');
        if (!header) return;
        header.addEventListener('click', (e) => {
          if (e.target.closest('button, input, select, textarea')) return;
          sec.classList.toggle('collapsed');
        });
      });
    }

    function renderDetails() {
      const node = getNode(currentNodeId);
      detailsRootEl.innerHTML = '';
      headerActionsEl.innerHTML = '';

      if (!node) {
        if (mainTitleTextEl) {
          mainTitleTextEl.textContent = '–ê–†–•–ò–í';
        }
        detailsRootEl.innerHTML =
          '<div class="hint">–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É —Å–ª–µ–≤–∞.</div>';
        return;
      }

      // –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–≤–µ—Ä—Ö—É: –ê–†–•–ò–í / –û–¢–°–ï–ö / –ü–ê–¢–¢–ï–†–ù
      let titleWrapper = null;
      if (mainTitleTextEl) {
        let titleText = '–ê–†–•–ò–í';
        const name = (node.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)').toUpperCase();
        if (node.type === 'category') {
          titleText = '–û–¢–°–ï–ö: ' + name;
        } else if (node.type === 'characteristic') {
          titleText = '–ü–ê–¢–¢–ï–†–ù: ' + name;
        }
        mainTitleTextEl.textContent = titleText;

        // –Ω–∞–π–¥—ë–º –æ–±—ë—Ä—Ç–∫—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ —É–±–µ—Ä—ë–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É ¬´–û–¢–°–ï–ö: ‚Ä¶¬ª, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
        titleWrapper = mainTitleTextEl.parentElement;
        if (titleWrapper) {
          const oldBtn = titleWrapper.querySelector('.main-title-parent-btn');
          if (oldBtn) oldBtn.remove();
        }
      }

      if (node.id !== state.rootId) {
        const kindLabel = node.type === 'category' ? '–û–¢–°–ï–ö' : '–ü–ê–¢–¢–ï–†–ù';

        const renameBtn = document.createElement('button');
        renameBtn.className = 'btn btn-sm btn-ghost btn-chip';
        renameBtn.textContent = '–ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–¢–¨ ' + kindLabel;
        renameBtn.onclick = () => {
          const newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', node.name || '');
          if (newName && newName.trim()) {
            renameNode(node.id, newName);
            render();
          }
        };
        headerActionsEl.appendChild(renameBtn);

        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-sm btn-danger btn-chip';
        delBtn.textContent = '–£–î–ê–õ–ò–¢–¨ ' + kindLabel;
        delBtn.onclick = () => {
          const ok = confirm(
            '–£–¥–∞–ª–∏—Ç—å "' + (node.name || '–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è') + '" –∏ –≤—Å—ë –≤–Ω—É—Ç—Ä–∏?'
          );
          if (!ok) return;
          const parentId = node.parentId || state.rootId;
          deleteNodeAndDescendants(node.id);
          currentNodeId = parentId;
          render();
        };
        headerActionsEl.appendChild(delBtn);
      }

      // –ï—Å–ª–∏ –º—ã –≤–Ω—É—Ç—Ä–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –µ–≥–æ –æ—Ç—Å–µ–∫–∞
      // –ø—Ä—è–º–æ —Ä—è–¥–æ–º —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º ¬´–ü–ê–¢–¢–ï–†–ù: ‚Ä¶¬ª.
      if (node.type === 'characteristic' && mainTitleTextEl && mainTitleTextEl.parentElement) {
        const parent = getNode(node.parentId);
        if (parent && parent.type === 'category') {
          const goCategoryBtn = document.createElement('button');
          goCategoryBtn.className = 'btn btn-sm btn-ghost btn-chip main-title-parent-btn';
          goCategoryBtn.textContent = '–û–¢–°–ï–ö: ' + (parent.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)');
          goCategoryBtn.title = '–û—Ç–∫—Ä—ã—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É —ç—Ç–æ–≥–æ –æ—Ç—Å–µ–∫–∞';
          goCategoryBtn.onclick = () => {
            currentNodeId = parent.id;
            sidebarViewNodeId = parent.id;
            quizState = null;
            factsState = null;
            render();
          };

          const wrapper = mainTitleTextEl.parentElement;
          wrapper.appendChild(goCategoryBtn);
        }
      }

      if (node.type === 'category') {
        renderCategoryDetails(node);
      } else {
        renderCharacteristicDetails(node);
      }
    }

    function renderCategoryDetails(node) {
      const wrapper = document.createElement('div');

      // title row
      const titleRow = document.createElement('div');
      titleRow.className = 'title-row';

      const titleMain = document.createElement('div');
      titleMain.className = 'title-main';
      titleMain.innerHTML =
        '<span>' + (node.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)') + '</span>';
      titleRow.appendChild(titleMain);

      if (node.parentId === state.rootId && node.config) {
        const tag = document.createElement('div');
        tag.className = 'tag-config';
        let scopeText = node.config.scope === 'personal' ? '–õ–∏—á–Ω–æ–µ' : '–ü—Ä–µ–¥–º–µ—Ç';
        let presetText = node.config.preset || '';
        if (node.config.scope === 'subject') {
          if (presetText === 'history') presetText = '–ò—Å—Ç–æ—Ä–∏—è';
          if (presetText === 'english') presetText = '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π';
        } else {
          if (presetText === 'notes') presetText = '–ó–∞–º–µ—Ç–∫–∏';
          if (presetText === 'ideas') presetText = '–ò–¥–µ–∏';
        }
        tag.textContent = scopeText + (presetText ? ' ¬∑ ' + presetText : '');
        titleRow.appendChild(tag);
      }

      wrapper.appendChild(titleRow);

      // summary line: facts & tests
      const chars = getCategoryCharacteristics(node.id);
      const factsCount = chars.reduce(
        (acc, ch) => acc + ((ch.cards || []).length),
        0
      );
      const summary = document.createElement('div');
      summary.className = 'hint';
      summary.textContent =
        '–û—Ç—Å–µ–∫: ' +
        (node.name || '') +
        ' ‚Äî ' +
        factsCount +
        ' —Ñ–∞–∫—Ç–æ–≤ –≤ ' +
        chars.length +
        ' —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö.';
      wrapper.appendChild(summary);

      // section: create inside
      const secCreate = document.createElement('div');
      secCreate.className = 'section';

      const secCreateHeader = document.createElement('div');
      secCreateHeader.className = 'section-header';
      secCreateHeader.innerHTML =
        '<div class="section-title">–ó–∞—Ä–æ–¥–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–º –≤–Ω—É—Ç—Ä–∏ –æ—Ç—Å–µ–∫–∞</div>';
      secCreate.appendChild(secCreateHeader);

      const secCreateBody = document.createElement('div');
      secCreateBody.className = 'section-body';

      const rowButtons = document.createElement('div');
      rowButtons.className = 'row';

      const btnCat = document.createElement('button');
      btnCat.className = 'btn btn-sm btn-ghost btn-full';
      btnCat.textContent = '+ –£–∑–µ–ª –æ—Ç—Å–µ–∫–∞';
      btnCat.onclick = () => openCreateDialog('category', node.id);

      const btnChar = document.createElement('button');
      btnChar.className = 'btn btn-sm btn-primary btn-full';
      btnChar.textContent = '+ –ü–∞—Ç—Ç–µ—Ä–Ω';
      btnChar.onclick = () => openCreateDialog('characteristic', node.id);

      const col1 = document.createElement('div');
      col1.appendChild(btnCat);
      const col2 = document.createElement('div');
      col2.appendChild(btnChar);

      rowButtons.appendChild(col1);
      rowButtons.appendChild(col2);

      secCreateBody.appendChild(rowButtons);
      secCreate.appendChild(secCreateBody);
      wrapper.appendChild(secCreate);

      // section: children
      const secChildren = document.createElement('div');
      secChildren.className = 'section';

      const secChHeader = document.createElement('div');
      secChHeader.className = 'section-header';
      const st = document.createElement('div');
      st.className = 'section-title';
      st.textContent = '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
      secChHeader.appendChild(st);
      secChildren.appendChild(secChHeader);

      const secChBody = document.createElement('div');
      secChBody.className = 'section-body';

      const childList = document.createElement('div');
      childList.className = 'child-list';

      if (!node.children || !node.children.length) {
        const p = document.createElement('div');
        p.className = 'hint';
        p.textContent =
          '–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É.';
        childList.appendChild(p);
      } else {
        node.children.forEach(cid => {
          const ch = getNode(cid);
          if (!ch) return;
          const card = document.createElement('div');
          card.className = 'child-card';

          const name = document.createElement('div');
          name.className = 'child-name';
          name.textContent = ch.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)';

          const meta = document.createElement('div');
          meta.className = 'child-meta';

          const left = document.createElement('span');
          left.textContent = ch.type === 'category' ? '–û—Ç—Å–µ–∫' : '–ü–∞—Ç—Ç–µ—Ä–Ω';

          const right = document.createElement('span');
          if (ch.type === 'category') {
            const subChars = getCategoryCharacteristics(ch.id);
            right.textContent = subChars.length + ' —Ö–∞—Ä.';
          } else {
            const cnt = (ch.cards || []).length;
            let t = ch.factType || 'assertion';
            if (t === 'assertion') t = '—É—Ç–≤.';
            else if (t === 'years') t = '–≥–æ–¥—ã';
            else if (t === 'olist') t = '—Å–ø–∏—Å–æ–∫';
            else if (t === 'term') t = '—Å–ª–æ–≤–∞';
            right.textContent = t + ' ¬∑ ' + cnt;
          }
          meta.appendChild(left);
          meta.appendChild(right);

          card.appendChild(name);
          card.appendChild(meta);

          card.onclick = () => {
            currentNodeId = ch.id;
            quizState = null;
            factsState = null;
            if (ch.type === 'category') {
              sidebarViewNodeId = ch.id;
            } else if (ch.parentId) {
              sidebarViewNodeId = ch.parentId;
            }
            render();
          };

          childList.appendChild(card);
        });
      }

      secChBody.appendChild(childList);
      secChildren.appendChild(secChBody);
      wrapper.appendChild(secChildren);

      // section: big tests
      const secTests = document.createElement('div');
      secTests.className = 'section';
      const secTestsHeader = document.createElement('div');
      secTestsHeader.className = 'section-header';
      secTestsHeader.innerHTML =
        '<div class="section-title">–¢–µ—Å—Ç –ø–æ –æ—Ç—Å–µ–∫—É (—É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤—Å—ë —á—Ç–æ –≤–Ω—É—Ç—Ä–∏)</div>';
      secTests.appendChild(secTestsHeader);

      const secTestsBody = document.createElement('div');
      secTestsBody.className = 'section-body';
      const hint = document.createElement('div');
      hint.className = 'hint';
      hint.textContent =
        '–ë–µ—Ä—ë—Ç—Å—è –≤—Å—ë, —á—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ –æ—Ç—Å–µ–∫–∞ –∏ –µ–≥–æ –ø–æ–¥–æ—Ç—Å–µ–∫–æ–≤. –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π, –∫–æ–≥–¥–∞ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ.';
      secTestsBody.appendChild(hint);

      const btnRow = document.createElement('div');
      btnRow.className = 'row';
      const types = [
        ['assertion', '–£–¢–í–ï–†–ñ–î–ï–ù–ò–Ø'],
        ['years', '–ì–û–î–´'],
        ['olist', '–û–ë–™–ï–ö–¢–ù–´–ï –°–ü–ò–°–ö–ò'],
        ['term', '–°–õ–û–í–ê-–û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø']
      ];
      types.forEach(([type, label]) => {
        const col = document.createElement('div');
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-ghost btn-full';
        btn.textContent = label;

        const qs = buildQuestions('category', node.id, type);
        const hasQuestions = qs && qs.length;
        if (!hasQuestions) {
          btn.disabled = true;
        } else {
          if (qs.length) {
            btn.textContent = label + ' ¬∑ ' + qs.length + ' –≤–æ–ø—Ä.';
          }
        }

        btn.onclick = () => startCategoryTest(node.id, type);
        col.appendChild(btn);
        btnRow.appendChild(col);
      });
      secTestsBody.appendChild(btnRow);
      secTests.appendChild(secTestsBody);
      wrapper.appendChild(secTests);

      detailsRootEl.appendChild(wrapper);
      attachSectionToggles(wrapper);
    }

    function renderCharacteristicDetails(node) {
      const wrapper = document.createElement('div');

      const titleRow = document.createElement('div');
      titleRow.className = 'title-row';

      const titleMain = document.createElement('div');
      titleMain.className = 'title-main characteristic';
      titleMain.textContent = node.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)';
      titleRow.appendChild(titleMain);
      wrapper.appendChild(titleRow);

      const parent = getNode(node.parentId);

      // SECTION: –¢–∏–ø —Ñ–∞–∫—Ç–∞
      const secType = document.createElement('div');
      secType.className = 'section';

      let ft = node.factType || 'assertion';
      const parentName = parent ? (parent.name || '') : '';

      const patternLabelMap = {
        assertion: '–§–ê–ö–¢–´',
        years: '–ì–û–î–ê',
        olist: '–û–ë–™–ï–ö–¢–ù–´–ï –°–ü–ò–°–ö–ò',
        term: '–°–õ–û–í–ê-–û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø'
      };
      const patternLabel = patternLabelMap[ft] || '';

      const secTypeHeader = document.createElement('div');
      secTypeHeader.className = 'section-header';
      secTypeHeader.innerHTML =
        '<div class="section-title">–¢–ò–ü –ü–ê–¢–¢–ï–†–ù–ê: ' + patternLabel + '</div>';
      secType.appendChild(secTypeHeader);

      const secTypeBody = document.createElement('div');
      secTypeBody.className = 'section-body';

      const rowType = document.createElement('div');
      rowType.className = 'row';

      const colInfo = document.createElement('div');
      const h1 = document.createElement('div');
      h1.className = 'hint';
      if (parent) {
        h1.textContent = '–û—Ç—Å–µ–∫: ' + parentName;
        h1.style.cursor = 'pointer';
        h1.title = '–û—Ç–∫—Ä—ã—Ç—å —ç—Ç–æ—Ç –æ—Ç—Å–µ–∫';
        h1.onclick = () => {
          currentNodeId = parent.id;
          sidebarViewNodeId = parent.id;
          quizState = null;
          factsState = null;
          render();
        };
      } else {
        h1.textContent = '–ë–µ–∑ –æ—Ç—Å–µ–∫–∞';
      }
      colInfo.appendChild(h1);

      const h2 = document.createElement('div');
      h2.className = 'hint';
      h2.textContent =
        '–¢–∏–ø –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏ –∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è.';
      colInfo.appendChild(h2);

      rowType.appendChild(colInfo);
      secTypeBody.appendChild(rowType);
      secType.appendChild(secTypeBody);
      wrapper.appendChild(secType);

      // SECTION: –í–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º
      const secUse = document.createElement('div');
      secUse.className = 'section';
      const secUseHeader = document.createElement('div');
      secUseHeader.className = 'section-header';
      secUseHeader.innerHTML =
        '<div class="section-title">–í–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º</div>';
      secUse.appendChild(secUseHeader);

      const secUseBody = document.createElement('div');
      secUseBody.className = 'section-body';

      const toolbar = document.createElement('div');
      toolbar.className = 'row-xs';

      const btnViewFacts = document.createElement('button');
      btnViewFacts.className = 'btn btn-sm btn-ghost';
      btnViewFacts.textContent = '–ö–ê–†–¢–û–ß–ö–ò';
      btnViewFacts.onclick = () => startFactsView(node.id);
      toolbar.appendChild(btnViewFacts);

      const tests = [
        ['assertion', '–¢–ï–°–¢: –£–¢–í–ï–†–ñ–î–ï–ù–ò–Ø'],
        ['years', '–¢–ï–°–¢: –ì–û–î–´'],
        ['olist', '–¢–ï–°–¢: –°–ü–ò–°–ö–ò'],
        ['term', '–¢–ï–°–¢: –¢–ï–†–ú–ò–ù–´']
      ];
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ —Ç–∏–ø—ã —Ç–µ—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –≤ —ç—Ç–æ–º –ø–∞—Ç—Ç–µ—Ä–Ω–µ.
      tests.forEach(([t, label]) => {
        // –¥–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ factType ‚Äî –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        if (t !== ft) return;
        const qs = buildQuestions('characteristic', node.id, t);
        if (!qs || !qs.length) return;
        const b = document.createElement('button');
        b.className = 'btn btn-sm btn-ghost btn-chip';
        b.textContent = label + ' ¬∑ ' + qs.length + ' –≤–æ–ø—Ä.';
        b.onclick = () => startCharacteristicTest(node.id, t);
        toolbar.appendChild(b);
      });

      secUseBody.appendChild(toolbar);
      secUse.appendChild(secUseBody);
      wrapper.appendChild(secUse);
// SECTION: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–∫—Ç–∞
      const secAdd = document.createElement('div');
      secAdd.className = 'section';
      const secAddHeader = document.createElement('div');
      secAddHeader.className = 'section-header';
      secAddHeader.innerHTML =
        '<div class="section-title">–ó–∞—Ä–æ–¥–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–º –≤–Ω—É—Ç—Ä–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞</div>';
      secAdd.appendChild(secAddHeader);

      const secAddBody = document.createElement('div');
      secAddBody.className = 'section-body';

      if (node.factType === 'assertion') {
        const r1 = document.createElement('div');
        r1.className = 'form-row';
        const l1 = document.createElement('div');
        l1.className = 'form-label';
        l1.textContent = '–ö—Ç–æ / —á—Ç–æ? (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)';
        const c1 = document.createElement('div');
        const i1 = document.createElement('input');
        i1.className = 'form-input';
        i1.placeholder = '–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–ú–∏–Ω—Å–∫¬ª –∏–ª–∏ ¬´–Ø–≥–ª–æ–Ω—Å–∫–∏–π¬ª';
        if (parent && parent.name) {
          i1.value = parent.name;
        }
        c1.appendChild(i1);
        r1.appendChild(l1);
        r1.appendChild(c1);

        const r2 = document.createElement('div');
        r2.className = 'form-row';
        const l2 = document.createElement('div');
        l2.className = 'form-label';
        l2.textContent = '–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ';
        const c2 = document.createElement('div');
        const t2 = document.createElement('textarea');
        t2.className = 'form-textarea';
        t2.placeholder = '–ö—Ä–∞—Ç–∫–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –ø–æ—Ç–æ–º –±—É–¥–µ—Ç –≤–æ–ø—Ä–æ—Å.';
        c2.appendChild(t2);
        r2.appendChild(l2);
        r2.appendChild(c2);

        const rowBtns = document.createElement('div');
        rowBtns.style.marginTop = '6px';
        const btnAdd = document.createElement('button');
        btnAdd.className = 'btn btn-sm btn-primary';
        btnAdd.textContent = '–î–æ–±–∞–≤–∏—Ç—å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ';
        btnAdd.onclick = () => {
          addAssertionCard(node.id, t2.value, i1.value);
          t2.value = '';
          i1.value = '';
          render();
        };
        rowBtns.appendChild(btnAdd);

        secAddBody.appendChild(r1);
        secAddBody.appendChild(r2);
        secAddBody.appendChild(rowBtns);
      } else if (node.factType === 'years') {
        const r1 = document.createElement('div');
        r1.className = 'form-row';
        const l1 = document.createElement('div');
        l1.className = 'form-label';
        l1.textContent = '–°–æ–±—ã—Ç–∏–µ';
        const c1 = document.createElement('div');
        const i1 = document.createElement('input');
        i1.className = 'form-input';
        i1.placeholder = '–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–£–±–∏–π—Å—Ç–≤–æ –í–µ—â–∏¬ª';
        c1.appendChild(i1);
        r1.appendChild(l1);
        r1.appendChild(c1);

        const r2 = document.createElement('div');
        r2.className = 'form-row';
        const l2 = document.createElement('div');
        l2.className = 'form-label';
        l2.textContent = '–ì–æ–¥ / –ø–µ—Ä–∏–æ–¥';
        const c2 = document.createElement('div');
        const i2 = document.createElement('input');
        i2.className = 'form-input';
        i2.placeholder = '–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´1067¬ª –∏–ª–∏ ¬´1359-2053¬ª';
        i2.addEventListener('input', () => {
          i2.value = i2.value.replace(/[^0-9\-‚Äì‚Äî]/g, '');
        });
        c2.appendChild(i2);
        r2.appendChild(l2);
        r2.appendChild(c2);

        const r3 = document.createElement('div');
        r3.className = 'form-row';
        const l3 = document.createElement('div');
        l3.className = 'form-label';
        l3.textContent = '–¢–æ—á–Ω–∞—è –¥–∞—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)';
        const c3 = document.createElement('div');
        const dateWrap = document.createElement('div');
        dateWrap.className = 'date-exact-row';
        const i3day = document.createElement('input');
        i3day.className = 'form-input';
        i3day.type = 'number';
        i3day.min = '1';
        i3day.max = '31';
        i3day.placeholder = '32';
        const i3month = document.createElement('input');
        i3month.className = 'form-input';
        i3month.placeholder = '–∞–≤–≥—É—Å—Ç–∞';
        i3month.addEventListener('input', () => {
          i3month.value = i3month.value.replace(/[0-9]/g, '');
          const maxDay = getMaxDaysForMonth(i3month.value.trim());
          i3day.max = String(maxDay);
          const cur = Number(i3day.value);
          if (cur > maxDay) {
            i3day.value = maxDay ? String(maxDay) : '';
          }
        });

        i3day.addEventListener('input', () => {
          const month = i3month.value.trim();
          const maxDay = month ? getMaxDaysForMonth(month) : 31;
          let val = Number(i3day.value);
          if (!val) {
            i3day.value = '';
            return;
          }
          if (val < 1) val = 1;
          if (val > maxDay) val = maxDay;
          i3day.value = String(val);
        });

        dateWrap.appendChild(i3day);
        dateWrap.appendChild(i3month);
        c3.appendChild(dateWrap);
        r3.appendChild(l3);
        r3.appendChild(c3);

        const r4 = document.createElement('div');
        r4.className = 'form-row';
        const l4 = document.createElement('div');
        l4.className = 'form-label';
        l4.textContent = '–≠—Ä–∞';
        const c4 = document.createElement('div');
        const i4 = document.createElement('input');
        i4.className = 'form-input';
        i4.placeholder = '–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–Ω. —ç.¬ª (–æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ —Ä–µ—á—å –∏–¥–µ—Ç –æ –≥–æ–¥–∞—Ö –Ω–∞—à–µ–π —ç—Ä—ã)';
        c4.appendChild(i4);
        r4.appendChild(l4);
        r4.appendChild(c4);

        const r5 = document.createElement('div');
        r5.className = 'form-row';
        const l5 = document.createElement('div');
        l5.className = 'form-label';
        l5.textContent = '–ü–µ—Ä—Å–æ–Ω–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)';
        const c5 = document.createElement('div');
        const i5 = document.createElement('input');
        i5.className = 'form-input';
        i5.placeholder = '–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–°–∫–∞—Ä–∏–Ω–∞¬ª';
        if (parent && parent.name) {
          i5.value = parent.name;
        }
        c5.appendChild(i5);
        r5.appendChild(l5);
        r5.appendChild(c5);

        const rowBtns = document.createElement('div');
        rowBtns.style.marginTop = '6px';
        const btnAdd = document.createElement('button');
        btnAdd.className = 'btn btn-sm btn-primary';
        btnAdd.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ';
        btnAdd.onclick = () => {
          const raw = (i2.value || '').trim();
          if (!raw) {
            alert('–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏ –≥–æ–¥ –∏–ª–∏ –ø–µ—Ä–∏–æ–¥.');
            return;
          }
          if (!isValidYearOrPeriod(raw)) {
            alert('–ì–æ–¥ / –ø–µ—Ä–∏–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´1385¬ª –∏–ª–∏ ¬´1385-1386¬ª.');
            return;
          }

          const day = i3day.value.trim();
          const month = i3month.value.trim();

          if (day && !month) {
            alert('–ï—Å–ª–∏ —É–∫–∞–∑—ã–≤–∞–µ—à—å —á–∏—Å–ª–æ –¥–Ω—è, —É–∫–∞–∂–∏ –∏ –º–µ—Å—è—Ü.');
            return;
          }

          if (day) {
            const maxDay = month ? getMaxDaysForMonth(month) : 31;
            const dayNum = Number(day);
            if (dayNum < 1 || dayNum > maxDay) {
              alert('–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–Ω—è ¬´' + day + '¬ª. –ú–∞–∫—Å–∏–º—É–º: ' + maxDay + '.');
              return;
            }
          }

          let exact = '';
          if (day || month) {
            exact = day && month ? (day + ' ' + month) : (day || month);
          }
          addYearsCard(node.id, i1.value, raw, i4.value, i5.value, exact);
          i1.value = '';
          i2.value = '';
          i3day.value = '';
          i3month.value = '';
          i4.value = '';
          i5.value = '';
          render();
        };
        rowBtns.appendChild(btnAdd);

        secAddBody.appendChild(r1);
        secAddBody.appendChild(r2);
        secAddBody.appendChild(r3);
        secAddBody.appendChild(r4);
        secAddBody.appendChild(r5);
        secAddBody.appendChild(rowBtns);
      } else if (node.factType === 'olist') {
        const r1 = document.createElement('div');
        r1.className = 'form-row';
        const l1 = document.createElement('div');
        l1.className = 'form-label';
        l1.textContent = '–ü—É–Ω–∫—Ç —Å–ø–∏—Å–∫–∞';
        const c1 = document.createElement('div');
        const i1 = document.createElement('textarea');
        i1.className = 'form-textarea';
        i1.placeholder =
          '–ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å–ø–∏—Å–∫–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–∫—Ç. –ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–°—Ç–æ–ª–∏—Ü–∞ ‚Äî –ú–∏–Ω—Å–∫¬ª.';
        c1.appendChild(i1);
        r1.appendChild(l1);
        r1.appendChild(c1);

        const rowBtns = document.createElement('div');
        rowBtns.style.marginTop = '6px';
        const btnAdd = document.createElement('button');
        btnAdd.className = 'btn btn-sm btn-primary';
        btnAdd.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç';
        btnAdd.onclick = () => {
          addOListItem(node.id, i1.value);
          i1.value = '';
          render();
        };
        rowBtns.appendChild(btnAdd);

        secAddBody.appendChild(r1);
        secAddBody.appendChild(rowBtns);
      } else if (node.factType === 'term') {
        const r1 = document.createElement('div');
        r1.className = 'form-row';
        const l1 = document.createElement('div');
        l1.className = 'form-label';
        l1.textContent = '–°–ª–æ–≤–æ / —Ç–µ—Ä–º–∏–Ω';
        const c1 = document.createElement('div');
        const i1 = document.createElement('input');
        i1.className = 'form-input';
        i1.placeholder = '–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–†–µ—Ñ–µ—Ä–µ–Ω–¥—É–º¬ª';
        c1.appendChild(i1);
        r1.appendChild(l1);
        r1.appendChild(c1);

        const r2 = document.createElement('div');
        r2.className = 'form-row';
        const l2 = document.createElement('div');
        l2.className = 'form-label';
        l2.textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ';
        const c2 = document.createElement('div');
        const i2 = document.createElement('textarea');
        i2.className = 'form-textarea';
        i2.placeholder = '–ö—Ä–∞—Ç–∫–æ–µ, –Ω–æ –ø–æ–Ω—è—Ç–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.';
        c2.appendChild(i2);
        r2.appendChild(l2);
        r2.appendChild(c2);

        const rowBtns = document.createElement('div');
        rowBtns.style.marginTop = '6px';
        const btnAdd = document.createElement('button');
        btnAdd.className = 'btn btn-sm btn-primary';
        btnAdd.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ä–º–∏–Ω';
        btnAdd.onclick = () => {
          addTermCard(node.id, i1.value, i2.value);
          i1.value = '';
          i2.value = '';
          render();
        };
        rowBtns.appendChild(btnAdd);

        secAddBody.appendChild(r1);
        secAddBody.appendChild(r2);
        secAddBody.appendChild(rowBtns);
      }

      secAdd.appendChild(secAddBody);
      wrapper.appendChild(secAdd);

      // SECTION: –°–ø–∏—Å–æ–∫ —Ñ–∞–∫—Ç–æ–≤ –∏ —Ç–µ—Å—Ç–æ–≤
      const secFacts = document.createElement('div');
      secFacts.className = 'section';
      const secFactsHeader = document.createElement('div');
      secFactsHeader.className = 'section-header';
      secFactsHeader.innerHTML =
        '<div class="section-title">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–∫—Ç—ã –≤–Ω—É—Ç—Ä–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞</div>';
      secFacts.appendChild(secFactsHeader);

      const secFactsBody = document.createElement('div');
      secFactsBody.className = 'section-body';

            const cards = node.cards || [];
      if (!cards.length) {
        const p = document.createElement('div');
        p.className = 'hint';
        p.textContent =
          '–§–∞–∫—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –ø–∞—Ä—É –≤—ã—à–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è.';
        secFactsBody.appendChild(p);
      } else {
        const table = document.createElement('table');
        table.className = 'card-table';
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        ['–§–∞–∫—Ç', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ', '–ü–æ—Ä—è–¥–æ–∫'].forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          trh.appendChild(th);
        });
        thead.appendChild(trh);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');

        cards.forEach((card, index) => {
          const tr = document.createElement('tr');
          const tdText = document.createElement('td');
          const span = document.createElement('div');
          span.className = 'card-display';
          span.textContent = formatFactDisplay(node, card);
          tdText.appendChild(span);

          const tdActions = document.createElement('td');
          const btns = document.createElement('div');
          btns.className = 'card-table-actions';

          const btnEdit = document.createElement('button');
          btnEdit.className = 'btn btn-sm btn-ghost';
          btnEdit.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';

          const btnDel = document.createElement('button');
          btnDel.className = 'btn btn-sm btn-danger';
          btnDel.textContent = '–£–¥–∞–ª–∏—Ç—å';

          btnDel.onclick = () => {
            const ok = confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–∫—Ç?');
            if (!ok) return;
            deleteCard(node.id, card.id);
            render();
          };

          btnEdit.onclick = () => {
            // –Ω–µ –¥–∞—ë–º –æ—Ç–∫—Ä—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ä–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ñ–∞–∫—Ç–∞
            const existing = tdText.querySelector('.fact-edit-container');
            if (existing) existing.remove();

            const editContainer = document.createElement('div');
            editContainer.className = 'fact-edit-container';
            editContainer.style.marginTop = '6px';
            const hr = document.createElement('hr');
            hr.style.border = 'none';
            hr.style.borderTop = '1px dashed rgba(148,163,184,0.4)';
            hr.style.margin = '6px 0';
            editContainer.appendChild(hr);

            const form = document.createElement('div');
            form.className = 'section-body';

            if (node.factType === 'assertion') {
              const r1 = document.createElement('div');
              r1.className = 'form-row';
              const l1 = document.createElement('div');
              l1.className = 'form-label';
              l1.textContent = '–ö—Ç–æ / —á—Ç–æ?';
              const c1 = document.createElement('div');
              const i1 = document.createElement('input');
              i1.className = 'form-input';
              i1.value = card.subject || '';
              c1.appendChild(i1);
              r1.appendChild(l1);
              r1.appendChild(c1);

              const r2 = document.createElement('div');
              r2.className = 'form-row';
              const l2 = document.createElement('div');
              l2.className = 'form-label';
              l2.textContent = '–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ';
              const c2 = document.createElement('div');
              const i2 = document.createElement('textarea');
              i2.className = 'form-textarea';
              i2.value = card.text || '';
              c2.appendChild(i2);
              r2.appendChild(l2);
              r2.appendChild(c2);

              form.appendChild(r1);
              form.appendChild(r2);

              const rowBtns = document.createElement('div');
              rowBtns.className = 'row';
              const colSave = document.createElement('div');
              const colCancel = document.createElement('div');

              const btnSave = document.createElement('button');
              btnSave.className = 'btn btn-sm btn-primary btn-full';
              btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
              btnSave.onclick = () => {
                updateCard(node.id, card.id, {
                  subject: i1.value,
                  text: i2.value
                });
                render();
              };

              const btnCancelEdit = document.createElement('button');
              btnCancelEdit.className = 'btn btn-sm btn-ghost btn-full';
              btnCancelEdit.textContent = '–û—Ç–º–µ–Ω–∞';
              btnCancelEdit.onclick = () => {
                editContainer.remove();
              };

              colSave.appendChild(btnSave);
              colCancel.appendChild(btnCancelEdit);
              rowBtns.appendChild(colSave);
              rowBtns.appendChild(colCancel);
              form.appendChild(rowBtns);
            } else if (node.factType === 'years') {
              const inputs = {};

              // –°–æ–±—ã—Ç–∏–µ
              {
                const r = document.createElement('div');
                r.className = 'form-row';
                const l = document.createElement('div');
                l.className = 'form-label';
                l.textContent = '–°–æ–±—ã—Ç–∏–µ';
                const c = document.createElement('div');
                const inp = document.createElement('input');
                inp.className = 'form-input';
                inp.value = card.event || '';
                c.appendChild(inp);
                r.appendChild(l);
                r.appendChild(c);
                form.appendChild(r);
                inputs.event = inp;
              }

              // –ì–æ–¥ / –ø–µ—Ä–∏–æ–¥
              {
                const r = document.createElement('div');
                r.className = 'form-row';
                const l = document.createElement('div');
                l.className = 'form-label';
                l.textContent = '–ì–æ–¥ / –ø–µ—Ä–∏–æ–¥';
                const c = document.createElement('div');
                const inp = document.createElement('input');
                inp.className = 'form-input';
                inp.value = card.timeRaw || '';
                inp.addEventListener('input', () => {
                  inp.value = inp.value.replace(/[^0-9\-‚Äì‚Äî]/g, '');
                });
                c.appendChild(inp);
                r.appendChild(l);
                r.appendChild(c);
                form.appendChild(r);
                inputs.timeRaw = inp;
              }

              // –¢–æ—á–Ω–∞—è –¥–∞—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ): –¥–µ–Ω—å + –º–µ—Å—è—Ü
              const rExact = document.createElement('div');
              rExact.className = 'form-row';
              const lExact = document.createElement('div');
              lExact.className = 'form-label';
              lExact.textContent = '–¢–æ—á–Ω–∞—è –¥–∞—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)';
              const cExact = document.createElement('div');
              const wrapExact = document.createElement('div');
              wrapExact.className = 'date-exact-row';

              const inpDay = document.createElement('input');
              inpDay.className = 'form-input';
              inpDay.type = 'number';
              inpDay.min = '1';
              inpDay.max = '31';
              inpDay.placeholder = '32';

              const inpMonth = document.createElement('input');
              inpMonth.className = 'form-input';
              inpMonth.placeholder = '–∞–≤–≥—É—Å—Ç–∞';

              inpMonth.addEventListener('input', () => {
                inpMonth.value = inpMonth.value.replace(/[0-9]/g, '');
                const maxDay = getMaxDaysForMonth(inpMonth.value.trim());
                inpDay.max = String(maxDay);
                const cur = Number(inpDay.value);
                if (cur > maxDay) {
                  inpDay.value = maxDay ? String(maxDay) : '';
                }
              });

              inpDay.addEventListener('input', () => {
                const month = inpMonth.value.trim();
                const maxDay = month ? getMaxDaysForMonth(month) : 31;
                let val = Number(inpDay.value);
                if (!val) {
                  inpDay.value = '';
                  return;
                }
                if (val < 1) val = 1;
                if (val > maxDay) val = maxDay;
                inpDay.value = String(val);
              });

              if (card.timeExact) {
                const parts = String(card.timeExact).split(' ');
                if (parts.length > 0) inpDay.value = parts[0];
                if (parts.length > 1) inpMonth.value = parts.slice(1).join(' ');
              }

              wrapExact.appendChild(inpDay);
              wrapExact.appendChild(inpMonth);
              cExact.appendChild(wrapExact);
              rExact.appendChild(lExact);
              rExact.appendChild(cExact);
              form.appendChild(rExact);

              // –≠—Ä–∞
              {
                const r = document.createElement('div');
                r.className = 'form-row';
                const l = document.createElement('div');
                l.className = 'form-label';
                l.textContent = '–≠—Ä–∞';
                const c = document.createElement('div');
                const inp = document.createElement('input');
                inp.className = 'form-input';
                inp.value = card.era || '';
                c.appendChild(inp);
                r.appendChild(l);
                r.appendChild(c);
                form.appendChild(r);
                inputs.era = inp;
              }

              // –ü–µ—Ä—Å–æ–Ω–∞
              {
                const r = document.createElement('div');
                r.className = 'form-row';
                const l = document.createElement('div');
                l.className = 'form-label';
                l.textContent = '–ü–µ—Ä—Å–æ–Ω–∞ (–µ—Å–ª–∏ –Ω–µ —Ç–æ—Ç –æ –∫–æ–º –∏–¥–µ—Ç —Ä–µ—á—å - –∑–∞–º–µ–Ω–∏)';
                const c = document.createElement('div');
                const inp = document.createElement('input');
                inp.className = 'form-input';
                inp.value = card.person || '';
                c.appendChild(inp);
                r.appendChild(l);
                r.appendChild(c);
                form.appendChild(r);
                inputs.person = inp;
              }

              const rowBtns = document.createElement('div');
              rowBtns.className = 'row';
              const colSave = document.createElement('div');
              const colCancel = document.createElement('div');

              const btnSave = document.createElement('button');
              btnSave.className = 'btn btn-sm btn-primary btn-full';
              btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
              btnSave.onclick = () => {
                const raw = (inputs.timeRaw.value || '').trim();
                if (!raw) {
                  alert('–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏ –≥–æ–¥ –∏–ª–∏ –ø–µ—Ä–∏–æ–¥.');
                  return;
                }
                if (!isValidYearOrPeriod(raw)) {
                  alert('–ì–æ–¥ / –ø–µ—Ä–∏–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´1385¬ª –∏–ª–∏ ¬´1385-1386¬ª.');
                  return;
                }

                const day = inpDay.value.trim();
                const month = inpMonth.value.trim();

                if (day && !month) {
                  alert('–ï—Å–ª–∏ —É–∫–∞–∑—ã–≤–∞–µ—à—å —á–∏—Å–ª–æ –¥–Ω—è, —É–∫–∞–∂–∏ –∏ –º–µ—Å—è—Ü.');
                  return;
                }

                if (day) {
                  const maxDay = month ? getMaxDaysForMonth(month) : 31;
                  const dayNum = Number(day);
                  if (dayNum < 1 || dayNum > maxDay) {
                    alert('–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–Ω—è ¬´' + day + '¬ª. –ú–∞–∫—Å–∏–º—É–º: ' + maxDay + '.');
                    return;
                  }
                }

                let exact = '';
                if (day || month) {
                  exact = day && month ? (day + ' ' + month) : (day || month);
                }
                updateCard(node.id, card.id, {
                  event: inputs.event.value,
                  timeRaw: raw,
                  era: inputs.era.value,
                  person: inputs.person.value,
                  timeExact: exact
                });
                render();
              };

              const btnCancelEdit = document.createElement('button');
              btnCancelEdit.className = 'btn btn-sm btn-ghost btn-full';
              btnCancelEdit.textContent = '–û—Ç–º–µ–Ω–∞';
              btnCancelEdit.onclick = () => {
                editContainer.remove();
              };

              colSave.appendChild(btnSave);
              colCancel.appendChild(btnCancelEdit);
              rowBtns.appendChild(colSave);
              rowBtns.appendChild(colCancel);
              form.appendChild(rowBtns);
            } else if (node.factType === 'olist') {
              const rowF = document.createElement('div');
              rowF.className = 'form-row';
              const l = document.createElement('div');
              l.className = 'form-label';
              l.textContent = '–ü—É–Ω–∫—Ç —Å–ø–∏—Å–∫–∞';
              const c = document.createElement('div');
              const t = document.createElement('textarea');
              t.className = 'form-textarea';
              t.value = card.text || '';
              c.appendChild(t);
              rowF.appendChild(l);
              rowF.appendChild(c);
              form.appendChild(rowF);

              const rowBtns = document.createElement('div');
              rowBtns.className = 'row';
              const colSave = document.createElement('div');
              const colCancel = document.createElement('div');

              const btnSave = document.createElement('button');
              btnSave.className = 'btn btn-sm btn-primary btn-full';
              btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
              btnSave.onclick = () => {
                updateCard(node.id, card.id, { text: t.value });
                render();
              };

              const btnCancelEdit = document.createElement('button');
              btnCancelEdit.className = 'btn btn-sm btn-ghost btn-full';
              btnCancelEdit.textContent = '–û—Ç–º–µ–Ω–∞';
              btnCancelEdit.onclick = () => {
                editContainer.remove();
              };

              colSave.appendChild(btnSave);
              colCancel.appendChild(btnCancelEdit);
              rowBtns.appendChild(colSave);
              rowBtns.appendChild(colCancel);
              form.appendChild(rowBtns);
            } else if (node.factType === 'term') {
              const r1 = document.createElement('div');
              r1.className = 'form-row';
              const l1 = document.createElement('div');
              l1.className = 'form-label';
              l1.textContent = '–°–ª–æ–≤–æ / —Ç–µ—Ä–º–∏–Ω';
              const c1 = document.createElement('div');
              const i1 = document.createElement('input');
              i1.className = 'form-input';
              i1.value = card.word || '';
              c1.appendChild(i1);
              r1.appendChild(l1);
              r1.appendChild(c1);

              const r2 = document.createElement('div');
              r2.className = 'form-row';
              const l2 = document.createElement('div');
              l2.className = 'form-label';
              l2.textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ';
              const c2 = document.createElement('div');
              const i2 = document.createElement('textarea');
              i2.className = 'form-textarea';
              i2.value = card.definition || '';
              c2.appendChild(i2);
              r2.appendChild(l2);
              r2.appendChild(c2);

              form.appendChild(r1);
              form.appendChild(r2);

              const rowBtns = document.createElement('div');
              rowBtns.className = 'row';
              const colSave = document.createElement('div');
              const colCancel = document.createElement('div');

              const btnSave = document.createElement('button');
              btnSave.className = 'btn btn-sm btn-primary btn-full';
              btnSave.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
              btnSave.onclick = () => {
                updateCard(node.id, card.id, {
                  word: i1.value,
                  definition: i2.value
                });
                render();
              };

              const btnCancelEdit = document.createElement('button');
              btnCancelEdit.className = 'btn btn-sm btn-ghost btn-full';
              btnCancelEdit.textContent = '–û—Ç–º–µ–Ω–∞';
              btnCancelEdit.onclick = () => {
                editContainer.remove();
              };

              colSave.appendChild(btnSave);
              colCancel.appendChild(btnCancelEdit);
              rowBtns.appendChild(colSave);
              rowBtns.appendChild(colCancel);
              form.appendChild(rowBtns);
            }

            editContainer.appendChild(form);
            tdText.appendChild(editContainer);
          };

          btns.appendChild(btnEdit);
          btns.appendChild(btnDel);
          tdActions.appendChild(btns);

          tr.appendChild(tdText);
          tr.appendChild(tdActions);

          const tdOrder = document.createElement('td');
          const orderWrap = document.createElement('div');
          orderWrap.className = 'card-order-controls';

          const btnUp = document.createElement('button');
          btnUp.className = 'btn btn-sm btn-ghost';
          btnUp.textContent = '‚Üë';
          if (index === 0) btnUp.disabled = true;
          btnUp.onclick = () => {
            moveCard(node.id, card.id, 'up');
            render();
          };

          const btnDown = document.createElement('button');
          btnDown.className = 'btn btn-sm btn-ghost';
          btnDown.textContent = '‚Üì';
          if (index === cards.length - 1) btnDown.disabled = true;
          btnDown.onclick = () => {
            moveCard(node.id, card.id, 'down');
            render();
          };

          orderWrap.appendChild(btnUp);
          orderWrap.appendChild(btnDown);
          tdOrder.appendChild(orderWrap);
          tr.appendChild(tdOrder);

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        secFactsBody.appendChild(table);
      }

      secFacts.appendChild(secFactsBody);
      wrapper.appendChild(secFacts);

      detailsRootEl.appendChild(wrapper);
      attachSectionToggles(wrapper);
    }

    // ===== FACTS OVERLAY =====

    function startFactsView(nodeId) {
      const node = getNode(nodeId);
      if (!node || node.type !== 'characteristic') return;
      const items = [];
      (node.cards || []).forEach(c => {
        items.push({
          title: node.name || '',
          text: formatFactDisplay(node, c)
        });
      });

      factsState = {
        nodeId,
        items,
        currentIndex: 0
      };

      factsHeaderTitleEl.textContent = '–§–∞–∫—Ç—ã: ' + (node.name || '');
      renderFacts();
      document.getElementById('appRoot').style.display = 'none';
      factsScreenEl.style.display = 'flex';
    }

    function renderFacts() {
      if (!factsState) return;
      const { items, currentIndex } = factsState;
      const total = items.length;
      if (!total) return;
      const item = items[currentIndex];
      factsTextEl.textContent = item.text || '';
      factsProgressEl.textContent = '–§–∞–∫—Ç ' + (currentIndex + 1) + ' –∏–∑ ' + total;
      factsCountEl.textContent = '–í—Å–µ–≥–æ —Ñ–∞–∫—Ç–æ–≤: ' + total;
      btnFactPrev.disabled = currentIndex === 0;
      btnFactNext.disabled = currentIndex === total - 1;
    }

    function exitFacts() {
      factsState = null;
      factsScreenEl.style.display = 'none';
      document.getElementById('appRoot').style.display = 'grid';
    }

    // ===== QUIZ QUESTION GENERATION =====

    function buildQuestionsForAssertion(scope, scopeId) {
      let chars = [];
      if (scope === 'category') {
        chars = getCategoryCharacteristics(scopeId).filter(
          ch => (ch.factType || 'assertion') === 'assertion'
        );
      } else {
        const n = getNode(scopeId);
        if (
          n &&
          n.type === 'characteristic' &&
          (n.factType || 'assertion') === 'assertion'
        )
          chars = [n];
      }
      const pairs = [];
      chars.forEach(ch => {
        (ch.cards || []).forEach(c => pairs.push({ node: ch, card: c }));
      });
      if (pairs.length < 2) return [];

      const subjects = [
        ...new Set(
          pairs
            .map(p => p.card.subject || p.node.name)
            .filter(Boolean)
        )
      ];
      if (subjects.length < 2) return [];

      const questions = [];
      pairs.forEach(p => {
        const node = p.node;
        const card = p.card;
        const subj = card.subject || node.name || '';
        const text = card.text || '';
        if (!subj || !text) return;

        const wrong = pickRandom(subjects, 3, subj);
        const options = shuffle([subj, ...wrong]).map(o => ({ id: o, text: o }));

        questions.push({
          type: 'single',
          testType: 'assertion',
          questionText:
            text + '\n\n–ö—Ç–æ/—á—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —ç—Ç–æ–º—É —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—é?',
          options,
          correctIds: [subj],
          correctAnswerText: subj
        });
      });
      return questions;
    }

    function buildQuestionsForYears(scope, scopeId) {
      let chars = [];
      if (scope === 'category') {
        chars = getCategoryCharacteristics(scopeId).filter(
          ch => (ch.factType || 'assertion') === 'years'
        );
      } else {
        const n = getNode(scopeId);
        if (
          n &&
          n.type === 'characteristic' &&
          (n.factType || 'assertion') === 'years'
        )
          chars = [n];
      }

      const pairs = [];
      chars.forEach(ch => {
        (ch.cards || []).forEach(c => {
          if (c.timeRaw) pairs.push({ node: ch, card: c });
        });
      });
      if (pairs.length < 2) return [];

      const allTimeLabels = pairs.map(p => formatYears(p.card)).filter(Boolean);

      const questions = [];
      pairs.forEach(p => {
        const card = p.card;
        const label = formatYears(card);
        if (!label) return;
        const ev = (card.event || '').trim();
        const person = (card.person || '').trim();
        let q;
        if (person) q = '–í –∫–∞–∫–æ–º –≥–æ–¥—É ' + person + ' ' + ev + '?';
        else q = '–í –∫–∞–∫–æ–º –≥–æ–¥—É –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–æ–±—ã—Ç–∏–µ:\n' + ev;

        const wrong = pickRandom(allTimeLabels, 3, label);
        const options = shuffle([label, ...wrong]).map(o => ({ id: o, text: o }));

        questions.push({
          type: 'single',
          testType: 'years',
          questionText: q,
          options,
          correctIds: [label],
          correctAnswerText: label
        });
      });
      return questions;
    }

    function buildQuestionsForOList(scope, scopeId) {
      let chars = [];
      if (scope === 'category') {
        chars = getCategoryCharacteristics(scopeId).filter(
          ch => (ch.factType || 'assertion') === 'olist'
        );
      } else {
        const n = getNode(scopeId);
        if (
          n &&
          n.type === 'characteristic' &&
          (n.factType || 'assertion') === 'olist'
        )
          chars = [n];
      }

      const lists = chars
        .map(ch => ({ node: ch, cards: ch.cards || [] }))
        .filter(x => x.cards.length);
      if (!lists.length) return [];

      const allItems = [];
      lists.forEach(({ node, cards }) => {
        cards.forEach(c => allItems.push({ node, card: c }));
      });

      const questions = [];
      lists.forEach(({ node, cards }) => {
        if (!cards.length) return;
        const topic = node.name || '–°–ø–∏—Å–æ–∫';

        const correctOptions = cards.map(c => ({
          id: c.id,
          text: c.text || ''
        }));

        const wrongPool = allItems.filter(it => it.node.id !== node.id);
        const wrongOptions = shuffle(wrongPool)
          .slice(0, Math.max(2, correctOptions.length))
          .map(it => ({
            id: it.card.id + '_wrong_' + it.node.id,
            text: it.card.text || ''
          }));

        const options = shuffle([...correctOptions, ...wrongOptions]);
        const correctIds = correctOptions.map(o => o.id);

        questions.push({
          type: 'multi',
          testType: 'olist',
          questionText:
            '–í—ã–±–µ—Ä–∏ –í–°–ï –ø—É–Ω–∫—Ç—ã, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ —Ç–µ–º–µ:\n¬´' + topic + '¬ª',
          options,
          correctIds,
          correctAnswerText: correctOptions.map(o => o.text).join('\n')
        });
      });

      return questions;
    }

    function buildQuestionsForTerm(scope, scopeId) {
      let chars = [];
      if (scope === 'category') {
        chars = getCategoryCharacteristics(scopeId).filter(
          ch => (ch.factType || 'assertion') === 'term'
        );
      } else {
        const n = getNode(scopeId);
        if (
          n &&
          n.type === 'characteristic' &&
          (n.factType || 'assertion') === 'term'
        )
          chars = [n];
      }

      const pairs = [];
      chars.forEach(ch => {
        (ch.cards || []).forEach(c => pairs.push({ node: ch, card: c }));
      });
      if (pairs.length < 2) return [];

      const allDefs = pairs.map(p => p.card.definition).filter(Boolean);

      const questions = [];
      pairs.forEach(p => {
        const card = p.card;
        const word = (card.word || '').trim();
        const def = (card.definition || '').trim();
        if (!word || !def) return;

        const wrong = pickRandom(allDefs, 3, def);
        const options = shuffle([def, ...wrong]).map(o => ({ id: o, text: o }));

        questions.push({
          type: 'single',
          testType: 'term',
          questionText: '–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —Å–ª–æ–≤–æ: ¬´' + word + '¬ª?',
          options,
          correctIds: [def],
          correctAnswerText: def
        });
      });
      return questions;
    }

    function buildQuestions(scope, scopeId, testType) {
      if (testType === 'assertion')
        return buildQuestionsForAssertion(scope, scopeId);
      if (testType === 'years') return buildQuestionsForYears(scope, scopeId);
      if (testType === 'olist') return buildQuestionsForOList(scope, scopeId);
      if (testType === 'term') return buildQuestionsForTerm(scope, scopeId);
      return [];
    }

    // ===== QUIZ OVERLAY LOGIC =====

    function startCategoryTest(categoryId, testType) {
      const node = getNode(categoryId);
      if (!node || node.type !== 'category') return;
      const questions = buildQuestions('category', categoryId, testType);
      if (!questions || !questions.length) {
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞.');
        return;
      }
      quizState = {
        scope: 'category',
        scopeId: categoryId,
        testType,
        questions: shuffle(questions),
        currentIndex: 0,
        total: questions.length,
        correctCount: 0
      };
      quizHeaderTitleEl.textContent = '–¢–µ—Å—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ' + (node.name || '');
      showQuiz();
    }

    function startCharacteristicTest(charId, testType) {
      const node = getNode(charId);
      if (!node || node.type !== 'characteristic') return;
      const questions = buildQuestions('characteristic', charId, testType);
      if (!questions || !questions.length) {
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∞.');
        return;
      }
      quizState = {
        scope: 'characteristic',
        scopeId: charId,
        testType,
        questions: shuffle(questions),
        currentIndex: 0,
        total: questions.length,
        correctCount: 0
      };
      quizHeaderTitleEl.textContent = '–¢–µ—Å—Ç: ' + (node.name || '');
      showQuiz();
    }

    function showQuiz() {
      renderQuiz();
      document.getElementById('appRoot').style.display = 'none';
      quizScreenEl.style.display = 'flex';
    }

    function exitQuiz() {
      quizState = null;
      quizScreenEl.style.display = 'none';
      document.getElementById('appRoot').style.display = 'grid';
    }

    function restartQuiz() {
      if (!quizState) return;
      quizState.questions = shuffle(quizState.questions);
      quizState.currentIndex = 0;
      quizState.correctCount = 0;
      renderQuiz();
    }

    function renderQuiz() {
      if (!quizState) return;
      const { questions, currentIndex, total } = quizState;
      const q = questions[currentIndex];

      quizProgressEl.textContent = '–í–æ–ø—Ä–æ—Å ' + (currentIndex + 1) + ' –∏–∑ ' + total;
      quizQuestionEl.textContent = q.questionText || '';
      quizOptionsEl.innerHTML = '';
      quizMessageEl.textContent = '';
      btnQuizNext.classList.add('btn-hidden');

      if (q.type === 'single') {
        q._answered = false;
        q.options.forEach(opt => {
          const btn = document.createElement('button');
          btn.className = 'btn btn-option';
          btn.textContent = opt.text || '';
          btn.dataset.id = opt.id;
          btn.onclick = () => {
            if (q._answered) return;
            q._answered = true;
            const isCorrect = q.correctIds.includes(opt.id);
            if (isCorrect) {
              quizState.correctCount++;
            }
            Array.from(quizOptionsEl.children).forEach(b => {
              const id = b.dataset.id;
              if (q.correctIds.includes(id)) {
                b.classList.add('btn-option-correct');
              }
            });
            if (!isCorrect) {
              btn.classList.add('btn-option-wrong');
            }

            if (isCorrect) {
              quizMessageEl.textContent = '–í–µ—Ä–Ω–æ! üëç';
            } else {
              quizMessageEl.textContent =
                '–ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ' + (q.correctAnswerText || '');
            }
            btnQuizNext.classList.remove('btn-hidden');
          };
          quizOptionsEl.appendChild(btn);
        });
      } else if (q.type === 'multi') {
        q._selected = new Set();
        q._answered = false;

        q.options.forEach(opt => {
          const btn = document.createElement('button');
          btn.className = 'btn btn-option';
          btn.textContent = opt.text || '';
          btn.dataset.id = opt.id;
          btn.onclick = () => {
            if (q._answered) return;
            if (q._selected.has(opt.id)) {
              q._selected.delete(opt.id);
              btn.classList.remove('btn-option-selected');
            } else {
              q._selected.add(opt.id);
              btn.classList.add('btn-option-selected');
            }
          };
          quizOptionsEl.appendChild(btn);
        });

        const btnCheck = document.createElement('button');
        btnCheck.className = 'btn btn-sm btn-primary';
        btnCheck.textContent = '–ì–æ—Ç–æ–≤–æ / –ø—Ä–æ–≤–µ—Ä–∏—Ç—å';
        btnCheck.onclick = () => {
          if (q._answered) return;
          q._answered = true;
          const selected = Array.from(q._selected || []);
          const correctSet = new Set(q.correctIds || []);
          const selectedSet = new Set(selected);
          let allCorrect = true;
          if (correctSet.size !== selectedSet.size) {
            allCorrect = false;
          } else {
            for (const id of correctSet) {
              if (!selectedSet.has(id)) {
                allCorrect = false;
                break;
              }
            }
          }

          Array.from(quizOptionsEl.children).forEach(b => {
            const id = b.dataset.id;
            if (!id) return;
            if (correctSet.has(id)) {
              b.classList.add('btn-option-correct');
            } else if (selectedSet.has(id)) {
              b.classList.add('btn-option-wrong');
            }
          });

          if (allCorrect) {
            quizState.correctCount++;
            quizMessageEl.textContent = '–í—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –≤—ã–±—Ä–∞–Ω—ã! üëç';
          } else {
            quizMessageEl.textContent =
              '–ï—Å—Ç—å –æ—à–∏–±–∫–∏. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã:\n' +
              (q.correctAnswerText || '');
          }
          btnQuizNext.classList.remove('btn-hidden');
        };
        quizOptionsEl.appendChild(btnCheck);
      }
    }

    function goToNextQuestion() {
      if (!quizState) return;
      quizState.currentIndex++;
      if (quizState.currentIndex >= quizState.total) {
        alert(
          '–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω.\n' +
          '–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ' +
          quizState.correctCount +
          ' –∏–∑ ' +
          quizState.total
        );
        exitQuiz();
      } else {
        renderQuiz();
      }
    }

    // ===== CREATE MODAL =====

    let createDialogState = null;
    let createConfigScope = 'subject';
    let createConfigPresetSubject = 'history';
    let createConfigPresetPersonal = 'notes';
    let createPatternType = 'assertion';

    function openCreateDialog(kind, parentId) {
      createDialogState = { kind, parentId };

      if (kind === 'category') {
        createModalTitleEl.textContent = '–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è';
        createModalSubtitleEl.textContent =
          parentId === state.rootId
            ? '–≠—Ç–æ –∫–æ—Ä–Ω–µ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è. –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–ò—Å—Ç–æ—Ä–∏—è, –ê–Ω–≥–ª, –õ–∏—á–Ω–æ–µ).'
            : '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏.';
        createNameLabelEl.textContent = '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
        createConfigBlockEl.style.display =
          parentId === state.rootId ? 'block' : 'none';
        if (createPatternTypeBlockEl) createPatternTypeBlockEl.style.display = 'none';
      } else {
        createModalTitleEl.textContent = '–ù–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω';
        createModalSubtitleEl.textContent =
          '–î–∞–π –∏–º—è –ø–∞—Ç—Ç–µ—Ä–Ω—É –∏ –≤—ã–±–µ—Ä–∏ —Ç–∏–ø —Ñ–∞–∫—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ.';
        createNameLabelEl.textContent = '–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞';
        createConfigBlockEl.style.display = 'none';
        if (createPatternTypeBlockEl) createPatternTypeBlockEl.style.display = 'block';
      }

      createNameInputEl.value = '';
      createConfigScope = 'subject';
      createConfigPresetSubject = 'history';
      createConfigPresetPersonal = 'notes';
      createPatternType = 'assertion';
      updateConfigSegUI();
      updatePatternTypeUI();

      createModalEl.style.display = 'flex';
      setTimeout(() => createNameInputEl.focus(), 0);
    }

    function closeCreateDialog() {
      createModalEl.style.display = 'none';
      createDialogState = null;
    }

    function updateConfigSegUI() {
      Array.from(segConfigScopeEl.querySelectorAll('button')).forEach(b => {
        b.classList.toggle('active', b.dataset.scope === createConfigScope);
      });
      if (createConfigScope === 'subject') {
        configPresetSubjectEl.style.display = 'block';
        configPresetPersonalEl.style.display = 'none';
      } else {
        configPresetSubjectEl.style.display = 'none';
        configPresetPersonalEl.style.display = 'block';
      }
      Array.from(segConfigPresetSubjectEl.querySelectorAll('button')).forEach(b => {
        b.classList.toggle('active', b.dataset.preset === createConfigPresetSubject);
      });
      Array.from(segConfigPresetPersonalEl.querySelectorAll('button')).forEach(b => {
        b.classList.toggle('active', b.dataset.preset === createConfigPresetPersonal);
      });
    }


    function updatePatternTypeUI() {
      if (!segPatternTypeEl) return;
      Array.from(segPatternTypeEl.querySelectorAll('button')).forEach(b => {
        b.classList.toggle('active', b.dataset.ptype === createPatternType);
      });
    }

    // ===== EXPORT / IMPORT =====

    btnExport.onclick = () => {
      const json = JSON.stringify(state, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'exam-db.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    btnImport.onclick = () => {
      fileInput.value = '';
      fileInput.click();
    };

    fileInput.onchange = (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (!data || typeof data !== 'object' || !data.nodes) {
            alert('–§–∞–π–ª –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –±–∞–∑—É –ü–æ–º–æ–≥–∞—Ç–æ—Ä–∞.');
            return;
          }
          state = data;
          currentNodeId = state.rootId || 'root';
          saveState();
          render();
        } catch (err) {
          console.error(err);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å JSON-—Ñ–∞–π–ª.');
        }
      };
      reader.readAsText(file, 'utf-8');
    };

    // ===== EVENT BINDINGS =====

    if (segPatternTypeEl) {
      segPatternTypeEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn || !btn.dataset.ptype) return;
        createPatternType = btn.dataset.ptype;
        updatePatternTypeUI();
      });
    }


    if (btnImportInCreate) {
      btnImportInCreate.onclick = () => {
        closeCreateDialog();
        btnImport.click();
      };
    }

    btnCreateRootCategory.onclick = () => {
      const node = getNode(currentNodeId) || getNode(state.rootId);
      const parentId = node && node.type === 'category' ? node.id : state.rootId;
      openCreateDialog('category', parentId);
    };

    if (btnRootsAdd) {
      btnRootsAdd.onclick = () => openCreateDialog('category', state.rootId);
    }

    if (btnRootbarAdd) {
      btnRootbarAdd.onclick = () => openCreateDialog('category', state.rootId);
    }


    segConfigScopeEl.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      createConfigScope = btn.dataset.scope;
      updateConfigSegUI();
    });

    segConfigPresetSubjectEl.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      createConfigPresetSubject = btn.dataset.preset;
      updateConfigSegUI();
    });

    segConfigPresetPersonalEl.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      createConfigPresetPersonal = btn.dataset.preset;
      updateConfigSegUI();
    });

    btnCreateClose.onclick = () => closeCreateDialog();
    btnCreateCancel.onclick = () => closeCreateDialog();
    btnCreateConfirm.onclick = () => {
      if (!createDialogState) {
        closeCreateDialog();
        return;
      }
      const { kind, parentId } = createDialogState;
      let name = createNameInputEl.value.trim();
      if (!name) {
        name =
          kind === 'category'
            ? parentId === state.rootId
              ? '–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è'
              : '–ù–æ–≤–∞—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è'
            : '–ù–æ–≤–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞';
      }

      let newId = null;
      if (kind === 'category') {
        let config = null;
        if (parentId === state.rootId) {
          config = {
            scope: createConfigScope,
            preset:
              createConfigScope === 'subject'
                ? createConfigPresetSubject
                : createConfigPresetPersonal
          };
        }
        newId = createCategory(name, parentId, config);
      } else {
        newId = createCharacteristic(name, parentId, createPatternType);
      }

      if (newId) {
        currentNodeId = newId;
        if (kind === 'category') {
          sidebarViewNodeId = newId;
        } else if (parentId) {
          const parentNode = getNode(parentId);
          if (parentNode && parentNode.type === 'category') {
            sidebarViewNodeId = parentNode.id;
          }
        }
      }

      closeCreateDialog();
      render();
    };

    // quiz buttons
    btnQuizExit.onclick = () => exitQuiz();
    btnQuizRestart.onclick = () => restartQuiz();
    btnQuizNext.onclick = () => goToNextQuestion();

    // facts buttons
    btnFactsClose.onclick = () => exitFacts();
    btnFactPrev.onclick = () => {
      if (!factsState) return;
      if (factsState.currentIndex > 0) {
        factsState.currentIndex--;
        renderFacts();
      }
    };
    btnFactNext.onclick = () => {
      if (!factsState) return;
      if (factsState.currentIndex < factsState.items.length - 1) {
        factsState.currentIndex++;
        renderFacts();
      }
    };

    // ===== –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –∫–æ—Ä–Ω—è =====

    function renderRootsScreen() {
      if (!rootsListEl) return;

      rootsListEl.innerHTML = '';

      const root = getNode(state.rootId);
      const hasUserRoot = !!root;

      // --- –°–ï–ö–¶–ò–Ø: —Ç–≤–æ–∏ –∫–æ—Ä–Ω–∏ ---
      if (hasUserRoot) {
        const userSection = document.createElement('div');
        userSection.className = 'roots-section';

        const userTitle = document.createElement('div');
        userTitle.className = 'roots-section-title';
        userTitle.textContent = '—Ç–≤–æ–∏ –∫–æ—Ä–Ω–∏';
        userSection.appendChild(userTitle);

        const items = (root.children || [])
          .map(id => getNode(id))
          .filter(n => n && n.type === 'category');

        if (!items.length) {
          const empty = document.createElement('div');
          empty.className = 'roots-empty';
          empty.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ—Ä–Ω–µ–π. –ù–∞–∂–º–∏ ¬´+¬ª, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π.';
          userSection.appendChild(empty);
        } else {
          items.forEach(node => {
            const row = document.createElement('div');
            row.className = 'root-item';
            row.dataset.id = node.id;
            row.dataset.source = 'user';

            const star = document.createElement('div');
            star.className = 'root-item-star';
            star.textContent = '‚ú∂';

            const label = document.createElement('div');
            label.className = 'root-item-label';
            label.textContent = '–ü–†–ï–î–ú–ï–¢ // ' + (node.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)');

            row.appendChild(star);
            row.appendChild(label);

            userSection.appendChild(row);
          });
        }

        rootsListEl.appendChild(userSection);
      }

      // --- –°–ï–ö–¶–ò–Ø: item:–∫–æ—Ä–Ω–∏ (–∫–æ—Ä–Ω–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞) ---
      if (window.__developerState && window.__developerState.nodes) {
        const devRootId = window.__developerState.rootId;
        const devRoot = window.__developerState.nodes[devRootId];
        if (devRoot) {
          const devItems = (devRoot.children || [])
            .map(id => window.__developerState.nodes[id])
            .filter(n => n && n.type === 'category');

          if (devItems.length) {
            const devSection = document.createElement('div');
            devSection.className = 'roots-section';

            const devTitle = document.createElement('div');
            devTitle.className = 'roots-section-title';
            devTitle.textContent = 'item:–∫–æ—Ä–Ω–∏ (–∫–æ—Ä–Ω–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞)';
            devSection.appendChild(devTitle);

            devItems.forEach(node => {
              const row = document.createElement('div');
              row.className = 'root-item';
              row.dataset.id = node.id;
              row.dataset.source = 'dev';

              const star = document.createElement('div');
              star.className = 'root-item-star';
              star.textContent = '‚ú∂';

              const label = document.createElement('div');
              label.className = 'root-item-label';
              label.textContent = 'DEV // ' + (node.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)');

              row.appendChild(star);
              row.appendChild(label);

              devSection.appendChild(row);
            });

            rootsListEl.appendChild(devSection);
          }
        }
      }
    }


    function findRootCategoryForNode(nodeId) {
      const root = getNode(state.rootId);
      if (!root) return null;
      let node = getNode(nodeId);
      if (!node) return null;
      while (node.parentId && node.parentId !== state.rootId) {
        node = getNode(node.parentId);
        if (!node) return null;
      }
      if (node.parentId === state.rootId) return node.id;
      return null;
    }

    function renderRootbar() {
      if (!rootbarListEl) return;

      rootbarListEl.innerHTML = '';

      const root = getNode(state.rootId);
      if (!root) {
        const empty = document.createElement('div');
        empty.className = 'hint';
        empty.style.fontSize = '9px';
        empty.textContent = '–ù–µ—Ç –∫–æ—Ä–Ω–µ–≤—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.';
        rootbarListEl.appendChild(empty);
        return;
      }

      const items = (root.children || [])
        .map(id => getNode(id))
        .filter(n => n && n.type === 'category');

      const title = document.createElement('div');
      title.className = 'rootbar-section-title';
      title.textContent = '—Ç–≤–æ–∏ –∫–æ—Ä–Ω–∏';
      rootbarListEl.appendChild(title);

      if (!items.length) {
        const empty = document.createElement('div');
        empty.className = 'hint';
        empty.style.fontSize = '9px';
        empty.textContent = '–ù–∞–∂–º–∏ ¬´+¬ª, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –∫–æ—Ä–µ–Ω—å.';
        rootbarListEl.appendChild(empty);
        return;
      }

      const currentRootId = findRootCategoryForNode(currentNodeId);

      items.forEach(node => {
        const row = document.createElement('div');
        row.className = 'rootbar-item';
        if (currentRootId && currentRootId === node.id) {
          row.classList.add('rootbar-item-current');
        }
        const label = document.createElement('div');
        label.className = 'rootbar-item-label';
        label.textContent = node.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)';
        row.appendChild(label);

        row.onclick = () => {
          quizState = null;
          factsState = null;
          sidebarViewNodeId = node.id;
          currentNodeId = node.id;
          render();
        };

        rootbarListEl.appendChild(row);
      });
    }
    
    function findRootCategoryForNode(nodeId) {
      const root = getNode(state.rootId);
      if (!root) return null;
      let node = getNode(nodeId);
      if (!node) return null;
      while (node.parentId && node.parentId !== state.rootId) {
        node = getNode(node.parentId);
        if (!node) return null;
      }
      if (node.parentId === state.rootId) return node.id;
      return null;
    }

    function renderRootbar() {
      if (!rootbarListEl) return;

      rootbarListEl.innerHTML = '';

      const root = getNode(state.rootId);
      if (!root) {
        const empty = document.createElement('div');
        empty.className = 'hint';
        empty.style.fontSize = '9px';
        empty.textContent = '–ù–µ—Ç –∫–æ—Ä–Ω–µ–≤—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.';
        rootbarListEl.appendChild(empty);
        return;
      }

      const items = (root.children || [])
        .map(id => getNode(id))
        .filter(n => n && n.type === 'category');

      const title = document.createElement('div');
      title.className = 'rootbar-section-title';
      title.textContent = '—Ç–≤–æ–∏ –∫–æ—Ä–Ω–∏';
      rootbarListEl.appendChild(title);

      if (!items.length) {
        const empty = document.createElement('div');
        empty.className = 'hint';
        empty.style.fontSize = '9px';
        empty.textContent = '–ù–∞–∂–º–∏ ¬´+¬ª, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –∫–æ—Ä–µ–Ω—å.';
        rootbarListEl.appendChild(empty);
        return;
      }

      const currentRootId = findRootCategoryForNode(currentNodeId);

      items.forEach(node => {
        const row = document.createElement('div');
        row.className = 'rootbar-item';
        if (currentRootId && currentRootId === node.id) {
          row.classList.add('rootbar-item-current');
        }
        const label = document.createElement('div');
        label.className = 'rootbar-item-label';
        label.textContent = node.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)';
        row.appendChild(label);

        row.onclick = () => {
          quizState = null;
          factsState = null;
          sidebarViewNodeId = node.id;
          currentNodeId = node.id;
          render();
        };

        rootbarListEl.appendChild(row);
      });
    }

        
        // ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö –ü–û –°–ê–ô–¢–£ =====
    const globalSearchInputEl = document.getElementById('globalSearchInput');
    const globalSearchResultsEl = document.getElementById('globalSearchResults');

    function normalizeTextForSearch(str) {
      return (str || '')
        .toString()
        .toLowerCase()
        .replace(/—ë/g, '–µ')
        .replace(/—ç/g, '–µ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function tokenizeForSearch(str) {
      const s = normalizeTextForSearch(str);
      const m = s.match(/[a-z–∞-—è0-9]+/g);
      return m ? m : [];
    }

    function isNumericQueryToken(t) {
      return /^[0-9]+$/.test(t || '');
    }

    // –û—á–µ–Ω—å –ª—ë–≥–∫–∏–π "—Å—Ç–µ–º–º–µ—Ä" –ø–æ–¥ —Ä—É—Å—Å–∫–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è (–ø—Ä–∏–º–µ—Ä: —Ü–µ—Ö–ò ~ —Ü–µ—Ö–ê)
    function ruStem(word) {
      const w = normalizeTextForSearch(word);
      if (w.length <= 3) return w;

      const endings = [
        '–∏—è–º–∏','—è–º–∏','–∞–º–∏',
        '–æ–≥–æ','–µ–≥–æ','–æ–º—É','–µ–º—É',
        '—ã–º–∏','–∏–º–∏',
        '–∞—Ö','—è—Ö',
        '–æ–≤','–µ–≤','—ë–≤',
        '–∞–º','—è–º',
        '–∞—è','—è—è',
        '–æ–µ','–µ–µ',
        '—É—é','—é—é',
        '—ã–π','–∏–π',
        '—ã–µ','–∏–µ',
        '–∞','—è','—ã','–∏','–µ','–æ','—É','—é','—å','–π'
      ];

      for (const end of endings) {
        if (w.endsWith(end) && w.length - end.length >= 3) {
          return w.slice(0, -end.length);
        }
      }
      return w;
    }

    function trigrams(s) {
      const t = normalizeTextForSearch(s);
      const out = new Set();
      if (t.length <= 2) {
        out.add(t);
        return out;
      }
      for (let i = 0; i < t.length - 2; i++) {
        out.add(t.slice(i, i + 3));
      }
      return out;
    }

    function jaccard(a, b) {
      if (!a.size && !b.size) return 1;
      let inter = 0;
      for (const x of a) if (b.has(x)) inter++;
      const union = a.size + b.size - inter;
      return union ? inter / union : 0;
    }

    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω (–±—ã—Å—Ç—Ä–æ –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è "—Ü–µ—Ö–∞"~"—Ü–µ—Ö–∏")
    function levenshtein(a, b, maxDist) {
      a = normalizeTextForSearch(a);
      b = normalizeTextForSearch(b);
      if (a === b) return 0;
      if (!a || !b) return Math.max(a.length, b.length);
      if (Math.abs(a.length - b.length) > maxDist) return maxDist + 1;

      const v0 = new Array(b.length + 1);
      const v1 = new Array(b.length + 1);

      for (let i = 0; i <= b.length; i++) v0[i] = i;

      for (let i = 0; i < a.length; i++) {
        v1[0] = i + 1;
        let rowMin = v1[0];

        for (let j = 0; j < b.length; j++) {
          const cost = a[i] === b[j] ? 0 : 1;
          v1[j + 1] = Math.min(
            v1[j] + 1,
            v0[j + 1] + 1,
            v0[j] + cost
          );
          if (v1[j + 1] < rowMin) rowMin = v1[j + 1];
        }

        if (rowMin > maxDist) return maxDist + 1;

        for (let j = 0; j <= b.length; j++) v0[j] = v1[j];
      }
      return v0[b.length];
    }

    function fuzzyTermInText(term, textNorm, tokens) {
      const t = normalizeTextForSearch(term);
      if (!t) return false;

      // –î–ª—è —á–∏—Å–µ–ª (–≥–æ–¥—ã –∏ —Ç.–ø.) ‚Äî —Ç–æ–ª—å–∫–æ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–Ω–∏–∫–∞–∫–∏—Ö "–ø–æ—Ö–æ–∂–∏—Ö –≥–æ–¥–æ–≤")
      if (isNumericQueryToken(t)) {
        return textNorm.includes(t);
      }

      // 1) —Ç–æ—á–Ω–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ (–±—ã—Å—Ç—Ä–æ)
      if (textNorm.includes(t)) return true;

      // 2) —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ —Å–ª–æ–≤–∞–º
      const tStem = ruStem(t);
      const tTri = trigrams(tStem);
      const tLen = t.length;

      for (const w of tokens) {
        if (!w) continue;

        // –±—ã—Å—Ç—Ä—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É
        if (w.startsWith(t) || t.startsWith(w)) {
          if (Math.min(w.length, tLen) >= 3) return true;
        }

        // –µ—Å–ª–∏ —Å–ª–æ–≤–æ –≤ —Ç–µ–∫—Å—Ç–µ —á–∏—Å–ª–æ–≤–æ–µ ‚Äî –Ω–µ —Å—á–∏—Ç–∞–µ–º –µ–≥–æ "–ø–æ—Ö–æ–∂–∏–º" –Ω–∞ –Ω–µ-—á–∏—Å–ª–æ
        if (isNumericQueryToken(w)) continue;

        const wStem = ruStem(w);

        // —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å—Ç–µ–º–æ–≤
        if (wStem === tStem && wStem.length >= 3) return true;

        // –±–ª–∏–∑–æ—Å—Ç—å –ø–æ –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω—É (–∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–≤–∞)
        const maxDist = tLen <= 6 ? 1 : (tLen <= 10 ? 2 : 0);
        if (maxDist) {
          const d = levenshtein(wStem, tStem, maxDist);
          if (d <= maxDist) return true;
        }

        // "–ø–æ—Ö–æ–∂–µ—Å—Ç—å" –ø–æ —Ç—Ä–∏–≥—Ä–∞–º–º–∞–º (–¥–ª—è —á—É—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤)
        const sim = jaccard(tTri, trigrams(wStem));
        if (sim >= 0.45 && Math.min(wStem.length, tStem.length) >= 4) return true;
      }

      return false;
    }

    function buildNodeRawText(node) {
      if (!node) return '';
      let parts = [node.name || ''];
      if (node.cards && node.cards.length) {
        (node.cards || []).forEach(card => {
          parts.push(formatFactDisplay(node, card));
          if (card.text) parts.push(card.text);
          if (card.event) parts.push(card.event);
          if (card.person) parts.push(card.person);
          if (card.word) parts.push(card.word);
          if (card.definition) parts.push(card.definition);
          if (card.timeRaw) parts.push(card.timeRaw);
        });
      }
      return parts.join(' ‚Ä¢ ');
    }

    function buildNodeFullText(node) {
      return normalizeTextForSearch(buildNodeRawText(node));
    }

    function buildPathForNode(node) {
      if (!node) return '';
      const parts = [node.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'];
      let current = node;
      while (current && current.parentId) {
        const parent = getNode(current.parentId);
        if (!parent) break;
        parts.push(parent.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)');
        current = parent;
      }
      parts.reverse();
      return parts.join(' ‚Üí ');
    }

    function collectMatchInfo(terms, rawText, textNorm, tokens) {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º: —á—Ç–æ –Ω–∞—à–ª–∏ (—Ç–æ—á–Ω–æ/–ø–æ—Ö–æ–∂–µ), –∫–∞–∫–æ–µ —Å–ª–æ–≤–æ –≤ —Ç–µ–∫—Å—Ç–µ –∑–∞—Ü–µ–ø–∏–ª–æ, –∏ –Ω–µ–±–æ–ª—å—à–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
      const out = {
        foundWord: '',
        foundTerm: '',
        matchKind: 'fuzzy', // 'exact' | 'fuzzy'
        snippet: ''
      };

      if (!rawText) return out;

      // 1) –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ç–æ—á–Ω—ã–π —Ç–µ—Ä–º–∏–Ω –∫–∞–∫ –ø–æ–¥—Å—Ç—Ä–æ–∫—É (–≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ),
      // –∞ –∑–∞—Ç–µ–º –≤—ã—Ç–∞—â–∏—Ç—å –∫—É—Å–æ–∫ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ.
      for (const t0 of terms) {
        const t = normalizeTextForSearch(t0);
        if (!t) continue;
        if (isNumericQueryToken(t) && textNorm.includes(t)) {
          out.foundTerm = t0;
          out.foundWord = t;
          out.matchKind = 'exact';
          break;
        }
        if (textNorm.includes(t)) {
          out.foundTerm = t0;
          out.foundWord = t0;
          out.matchKind = 'exact';
          break;
        }
      }

      // 2) –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ –Ω–µ—Ç ‚Äî –≤—ã–±–∏—Ä–∞–µ–º "—Å–∞–º–æ–µ –ø–æ—Ö–æ–∂–µ–µ" —Å–ª–æ–≤–æ –∏–∑ —Ç–æ–∫–µ–Ω–æ–≤
      if (!out.foundTerm) {
        outer: for (const t0 of terms) {
          const t = normalizeTextForSearch(t0);
          if (!t) continue;
          if (isNumericQueryToken(t)) continue;

          const tStem = ruStem(t);
          const tTri = trigrams(tStem);
          const tLen = t.length;

          let best = null;
          let bestScore = -1;

          for (const w of tokens) {
            if (!w || isNumericQueryToken(w)) continue;
            const wNorm = normalizeTextForSearch(w);
            if (wNorm === t) {
              best = w;
              bestScore = 999;
              break;
            }
            // –ø—Ä–µ—Ñ–∏–∫—Å
            if (wNorm.startsWith(t) || t.startsWith(wNorm)) {
              const s = 50 + Math.min(wNorm.length, tLen);
              if (s > bestScore) { bestScore = s; best = w; }
              continue;
            }
            const wStem = ruStem(wNorm);
            if (wStem === tStem && wStem.length >= 3) {
              const s = 80 + wStem.length;
              if (s > bestScore) { bestScore = s; best = w; }
              continue;
            }
            const maxDist = tLen <= 6 ? 1 : (tLen <= 10 ? 2 : 0);
            if (maxDist) {
              const d = levenshtein(wStem, tStem, maxDist);
              if (d <= maxDist) {
                const s = 40 - d;
                if (s > bestScore) { bestScore = s; best = w; }
                continue;
              }
            }
            const sim = jaccard(tTri, trigrams(wStem));
            if (sim >= 0.45 && Math.min(wStem.length, tStem.length) >= 4) {
              const s = sim * 30;
              if (s > bestScore) { bestScore = s; best = w; }
            }
          }

          if (best) {
            out.foundTerm = t0;
            out.foundWord = best;
            out.matchKind = 'fuzzy';
            break outer;
          }
        }
      }

      // 3) –°–Ω–∏–ø–ø–µ—Ç: —Å—Ç–∞—Ä–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å –∫—É—Å–æ–∫ —Ç–µ–∫—Å—Ç–∞ –≤–æ–∫—Ä—É–≥ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞/—Ç–µ—Ä–º–∏–Ω–∞
      const baseNeedle = out.foundWord || out.foundTerm;
      if (baseNeedle) {
        const raw = (rawText || '').toString();
        const needle = (baseNeedle || '').toString().trim();
        if (needle) {
          const re = new RegExp(escapeRegExp(needle), 'i');
          const mm = raw.match(re);
          if (mm && typeof mm.index === 'number') {
            const i = mm.index;
            const left = Math.max(0, i - 42);
            const right = Math.min(raw.length, i + needle.length + 56);
            let snippet = raw.slice(left, right);
            if (left > 0) snippet = '‚Ä¶' + snippet;
            if (right < raw.length) snippet = snippet + '‚Ä¶';
            out.snippet = snippet;
          } else {
            // fallback: –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–≤—ã–µ N —Å–∏–º–≤–æ–ª–æ–≤
            out.snippet = raw.length > 110 ? (raw.slice(0, 110) + '‚Ä¶') : raw;
          }
        }
      }

      return out;
    }

    function runGlobalSearch(query) {
      const normQ = normalizeTextForSearch(query);
      if (!normQ) return [];

      // —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å–ª–æ–≤–∞, —É–±–∏—Ä–∞–µ–º —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ
      const terms = tokenizeForSearch(normQ).filter(t => t.length >= 2);
      if (!terms.length) return [];

      const nodes = state && state.nodes ? Object.values(state.nodes) : [];
      const results = [];

      nodes.forEach(node => {
        const rawText = buildNodeRawText(node);
        const text = normalizeTextForSearch(rawText);
        if (!text) return;

        const tokens = tokenizeForSearch(text);

        // "—É–º–Ω–æ–µ" —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: –∫–∞–∂–¥—ã–π —Ç–µ—Ä–º–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–π–¥–µ–Ω (—Ç–æ—á–Ω–æ –∏–ª–∏ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)
        const ok = terms.every(t => fuzzyTermInText(t, text, tokens));
        if (!ok) return;

        // –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤—ã—à–µ –ø–æ—Ö–æ–∂–∏—Ö
        const allExact = terms.every(t => {
          const tt = normalizeTextForSearch(t);
          if (!tt) return false;
          return text.includes(tt);
        });

        // —Å–∫–æ—Ä–∏–Ω–≥
        let score = 0;
        const nameNorm = normalizeTextForSearch(node.name || '');

        terms.forEach(t => {
          const tt = normalizeTextForSearch(t);
          if (!tt) return;

          // —á–∏—Å–ª–∞ ‚Äî —Ç–æ–ª—å–∫–æ —Ç–æ—á–Ω–æ–µ
          if (isNumericQueryToken(tt)) {
            if (text.includes(tt)) score += 22;
            return;
          }

          if (nameNorm.includes(tt)) score += 10;
          if (text.includes(' ' + tt) || text.startsWith(tt)) score += 4;
          if (text.includes(tt)) score += 2;

          // –Ω–µ–±–æ–ª—å—à–æ–π –±–æ–Ω—É—Å –∑–∞ "–ø–æ—Ö–æ–∂–µ—Å—Ç—å", –µ—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ –Ω–µ—Ç
          if (!text.includes(tt)) score += 1;
        });

        // –±–æ–Ω—É—Å –∑–∞ —Ç–∏–ø: –ø–∞—Ç—Ç–µ—Ä–Ω —á–∞—â–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
        if (node.type === 'characteristic') score += 1;

        const path = buildPathForNode(node);
        const mi = collectMatchInfo(terms, rawText, text, tokens);

        results.push({
          nodeId: node.id,
          type: node.type,
          title: node.name || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)',
          path,
          score,
          allExact,
          foundWord: mi.foundWord,
          foundTerm: mi.foundTerm,
          matchKind: mi.matchKind,
          snippet: mi.snippet
        });
      });

      results.sort((a, b) => {
        if (a.allExact !== b.allExact) return a.allExact ? -1 : 1; // exact first
        if (a.matchKind !== b.matchKind) return a.matchKind === 'exact' ? -1 : 1;
        return b.score - a.score;
      });

      return results.slice(0, 30);
    }

    function renderGlobalSearchResults(list) {
      if (!globalSearchResultsEl) return;
      globalSearchResultsEl.innerHTML = '';
      if (!list || !list.length) {
        globalSearchResultsEl.style.display = 'none';
        return;
      }

      list.forEach(item => {
        const row = document.createElement('div');
        row.className = 'sidebar-search-result';

        const title = document.createElement('div');
        title.className = 'sidebar-search-title';
        const typeLabel =
          item.type === 'category'
            ? '–û–¢–°–ï–ö'
            : item.type === 'characteristic'
            ? '–ü–ê–¢–¢–ï–†–ù'
            : '–≠–õ–ï–ú–ï–ù–¢';
        title.textContent = typeLabel + ' ¬∑ ' + item.title;

        const meta = document.createElement('div');
        meta.className = 'sidebar-search-path';
        const kind = item.matchKind === 'exact' ? '—Ç–æ—á–Ω–æ' : '–ø–æ—Ö–æ–∂–µ';
        const found = (item.foundWord || item.foundTerm || '').toString().trim();
        meta.textContent = found
          ? (`¬´${found}¬ª (${kind}) ‚Äî ${item.snippet || ''}`.trim())
          : (item.snippet || '').trim();

        // –ø—É—Ç—å –æ—Å—Ç–∞–≤–∏–º –≤ –ø–æ–¥—Å–∫–∞–∑–∫–µ (–Ω–µ –º–µ—à–∞–µ—Ç, –Ω–æ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å)
        row.title = item.path || '';

        row.appendChild(title);
        row.appendChild(meta);

        row.addEventListener('click', () => {
          const node = getNode(item.nodeId);
          if (!node) return;

          currentNodeId = node.id;
          if (node.type === 'category') {
            sidebarViewNodeId = node.id;
          } else if (node.parentId) {
            sidebarViewNodeId = node.parentId;
          }

          quizState = null;
          factsState = null;

          // –ø–æ–¥—Å–≤–µ—Ç–∏–º –Ω–∞–π–¥–µ–Ω–Ω–æ–µ –≤ –¥–µ—Ç–∞–ª—è—Ö, –Ω–æ –ù–ï –±—É–¥–µ–º –¥–µ—Ä–≥–∞—Ç—å —ç–∫—Ä–∞–Ω –ø—Ä–∏ –Ω–∞–±–æ—Ä–µ —Ç–µ–∫—Å—Ç–∞
          const q = (globalSearchInputEl && globalSearchInputEl.value) ? globalSearchInputEl.value : '';
          __activeSearchHighlight = (q || '').trim();

          render();
          applyActiveSearchHighlight(true);
          globalSearchResultsEl.style.display = 'none';
        });

        globalSearchResultsEl.appendChild(row);
      });

      globalSearchResultsEl.style.display = 'block';
    }

    let __globalSearchLastQuery = '';
    let __globalSearchLastResults = [];
    let __globalSearchDebounce = null;

    function refreshGlobalSearch({ forceShow = false } = {}) {
      if (!globalSearchInputEl) return;
      const q = (globalSearchInputEl.value || '').trim();
      __activeSearchHighlight = q;

      // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤ —Ç–µ–∫—É—â–µ–º —ç–∫—Ä–∞–Ω–µ ‚Äî –ë–ï–ó –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª–∞, —á—Ç–æ–±—ã –Ω–µ –¥–µ—Ä–≥–∞–ª—Å—è —ç–∫—Ä–∞–Ω –ø—Ä–∏ –Ω–∞–±–æ—Ä–µ
      applyActiveSearchHighlight(false);

      if (!q || q.length < 2) {
        __globalSearchLastQuery = q;
        __globalSearchLastResults = [];
        renderGlobalSearchResults([]);
        return;
      }

      // –µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ñ–æ–∫—É—Å ‚Äî –ø–æ–∫–∞–∂–µ–º –ø—Ä–µ–∂–Ω–∏–π —Å–ø–∏—Å–æ–∫, –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—è
      if (!forceShow && __globalSearchLastQuery === q && __globalSearchLastResults.length) {
        renderGlobalSearchResults(__globalSearchLastResults);
        return;
      }

      const results = runGlobalSearch(q);
      __globalSearchLastQuery = q;
      __globalSearchLastResults = results;
      renderGlobalSearchResults(results);
    }

    if (globalSearchInputEl) {
      globalSearchInputEl.addEventListener('input', () => {
        if (__globalSearchDebounce) clearTimeout(__globalSearchDebounce);
        __globalSearchDebounce = setTimeout(() => refreshGlobalSearch({ forceShow: true }), 80);
      });

      // –í–ê–ñ–ù–û: –Ω–∞ —Ñ–æ–∫—É—Å/–∫–ª–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ç–µ–∫—Å—Ç—É,
      // –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∏—á–µ–≥–æ –Ω–µ –≤–≤–æ–¥–∏—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ
      globalSearchInputEl.addEventListener('focus', () => {
        refreshGlobalSearch({ forceShow: true });
      });
      globalSearchInputEl.addEventListener('click', () => {
        refreshGlobalSearch({ forceShow: true });
      });

      globalSearchInputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          globalSearchInputEl.value = '';
          renderGlobalSearchResults([]);
          __activeSearchHighlight = '';
          applyActiveSearchHighlight(false);
        }
      });
    }

    document.addEventListener('click', (e) => {
      if (!globalSearchResultsEl || !globalSearchInputEl) return;
      if (
        e.target === globalSearchInputEl ||
        globalSearchResultsEl.contains(e.target)
      ) {
        return;
      }
      globalSearchResultsEl.style.display = 'none';
    });


    // ===== –ü–û–î–°–í–ï–¢–ö–ê –ù–ê–ô–î–ï–ù–ù–û–ì–û –¢–ï–ö–°–¢–ê (–∫–∞–∫ Ctrl+F) =====
    let __activeSearchHighlight = '';

    function escapeRegExp(str) {
      return (str || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function buildHighlightRegex(terms) {
      const parts = (terms || [])
        .map(t => normalizeTextForSearch(t))
        .filter(Boolean)
        .map(t => escapeRegExp(t).replace(/—ë/g, '[–µ—ë]').replace(/–µ/g, '[–µ—ë]'));

      if (!parts.length) return null;
      return new RegExp('(' + parts.join('|') + ')', 'gi');
    }

    function clearSearchHighlights(rootEl) {
      const root = rootEl || document;
      const marks = root.querySelectorAll('mark.search-highlight');
      marks.forEach(m => {
        const parent = m.parentNode;
        if (!parent) return;
        parent.replaceChild(document.createTextNode(m.textContent || ''), m);
        parent.normalize();
      });
    }

    function highlightInElement(rootEl, query, opts) {
      const root = rootEl;
      opts = opts || {};
      const shouldScroll = !!opts.scroll;
      if (!root) return;

      clearSearchHighlights(root);

      const q = (query || '').trim();
      if (!q || q.length < 2) return;

      const terms = tokenizeForSearch(q).filter(t => t.length >= 2);
      if (!terms.length) return;

      function fuzzyWordMatch(term, word) {
        const t = normalizeTextForSearch(term);
        const w = normalizeTextForSearch(word);
        if (!t || !w) return false;

        // —Ç–æ—á–Ω–æ–µ / —á–∞—Å—Ç–∏—á–Ω–æ–µ
        if (w === t) return true;
        if ((w.includes(t) || t.includes(w)) && Math.min(w.length, t.length) >= 3) return true;

        const tStem = ruStem(t);
        const wStem = ruStem(w);

        // —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å—Ç–µ–º–æ–≤
        if (tStem === wStem && tStem.length >= 3) return true;

        // –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–ª–æ–≤
        const maxDist = t.length <= 6 ? 1 : (t.length <= 10 ? 2 : 0);
        if (maxDist) {
          const d = levenshtein(wStem, tStem, maxDist);
          if (d <= maxDist) return true;
        }

        // —Ç—Ä–∏–≥—Ä–∞–º–º—ã –¥–ª—è —á—É—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
        const sim = jaccard(trigrams(tStem), trigrams(wStem));
        if (sim >= 0.45 && Math.min(wStem.length, tStem.length) >= 4) return true;

        return false;
      }

      const wordRe = /[A-Za-z–ê-–Ø–∞-—è–Å—ë–≠—ç0-9]+/g;

      const walker = document.createTreeWalker(
        root,
        NodeFilter.SHOW_TEXT,
        {
          acceptNode: function (node) {
            if (!node || !node.nodeValue) return NodeFilter.FILTER_REJECT;
            const parent = node.parentNode;
            if (!parent) return NodeFilter.FILTER_REJECT;
            const tag = (parent.tagName || '').toLowerCase();
            if (tag === 'script' || tag === 'style' || tag === 'mark') return NodeFilter.FILTER_REJECT;
            if (tag === 'input' || tag === 'textarea') return NodeFilter.FILTER_REJECT;
            if (parent.closest && parent.closest('mark.search-highlight')) return NodeFilter.FILTER_REJECT;

            const raw = node.nodeValue;
            if (!raw || !raw.trim()) return NodeFilter.FILTER_REJECT;

            const norm = normalizeTextForSearch(raw);
            const tokens = tokenizeForSearch(norm);
            // –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ—Ä–º–∏–Ω –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ—ë.
            const ok = terms.some(t => fuzzyTermInText(t, norm, tokens));
            return ok ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
          }
        },
        false
      );

      const textNodes = [];
      let n;
      while ((n = walker.nextNode())) textNodes.push(n);

      textNodes.forEach(node => {
        const txt = node.nodeValue;
        if (!txt) return;

        wordRe.lastIndex = 0;
        let m;
        let lastIdx = 0;
        let changed = false;
        const frag = document.createDocumentFragment();

        while ((m = wordRe.exec(txt))) {
          const idx = m.index;
          const word = m[0];

          if (idx > lastIdx) frag.appendChild(document.createTextNode(txt.slice(lastIdx, idx)));

          const shouldMark = terms.some(t => fuzzyWordMatch(t, word));
          if (shouldMark) {
            changed = true;
            const mark = document.createElement('mark');
            mark.className = 'search-highlight';
            mark.textContent = word;
            frag.appendChild(mark);
          } else {
            frag.appendChild(document.createTextNode(word));
          }

          lastIdx = idx + word.length;
        }

        if (!changed) return; // –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥—Å–≤–µ—Ç–∏–ª–∏

        if (lastIdx < txt.length) frag.appendChild(document.createTextNode(txt.slice(lastIdx)));

        if (node.parentNode) node.parentNode.replaceChild(frag, node);
      });

      if (shouldScroll) {
        const first = root.querySelector('mark.search-highlight');
        if (first && first.scrollIntoView) {
          try {
            first.scrollIntoView({ block: 'center', inline: 'nearest', behavior: 'smooth' });
          } catch (e) {
            first.scrollIntoView(true);
          }
        }
      }
    }

    function applyActiveSearchHighlight(shouldScroll) {
      // –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏ (–¥–µ—Ç–∞–ª–∏), —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –∏–µ—Ä–∞—Ä—Ö–∏—é
      highlightInElement(detailsRootEl, __activeSearchHighlight, { scroll: !!shouldScroll });
    }

// ===== MAIN RENDER =====

    function render() {
      buildBreadcrumb(currentNodeId);
      renderRootbar();
      renderTree();
      renderDetails();
      applyActiveSearchHighlight(false);
    }

    render();
  </script>

  <script>
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤ –∏ –º–∏–∫—Ä–æ‚Äë–ª–æ–≥–∏–∫–∞ –æ–±—ë—Ä—Ç–∫–∏
    (function () {
      const screens = {
        splash: document.getElementById('screen-splash'),
        brain: document.getElementById('screen-brain'),
        roots: document.getElementById('screen-roots'),
        app: document.getElementById('screen-app')
      };

      function showScreen(name) {
        Object.values(screens).forEach(function (el) {
          if (!el) return;
          el.classList.remove('screen-visible');
        });
        if (screens[name]) {
          screens[name].classList.add('screen-visible');
        }
        if (name === 'app') {
          render();
        } else if (name === 'roots') {
          renderRootsScreen();
        }
      }

      const splash = screens.splash;
      if (splash) {
        splash.addEventListener('click', function () {
          showScreen('brain');
        });
        // –ê–≤—Ç–æ-–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≤—Ç–æ—Ä–æ–π —ç–∫—Ä–∞–Ω
        setTimeout(function () {
          showScreen('brain');
        }, 2200);
      }

      const btnGoToApp = document.getElementById('btnGoToApp');
      if (btnGoToApp) {
        btnGoToApp.addEventListener('click', function () {
          showScreen('app');
        });
      }

      const brainTitle = document.getElementById('brainTitle');
      if (brainTitle) {
        brainTitle.addEventListener('click', function () {
          showScreen('app');
        });
      }

      const rootsList = document.getElementById('rootsList');
      if (rootsList) {
        rootsList.addEventListener('click', function (e) {
          const item = e.target.closest('.root-item');
          if (!item) return;
          const id = item.dataset.id;
          if (!id) return;

          const source = item.dataset.source || 'user';

          // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–æ—Å —Ç–µ—Å—Ç–æ–≤/—Ñ–∞–∫—Ç–æ–≤
          quizState = null;
          factsState = null;

          if (source === 'dev') {
            if (!window.__developerState || !window.__developerState.nodes) {
              alert('–ö–æ—Ä–Ω–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
              return;
            }
            // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –±–∞–∑—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω—É—é
            state = JSON.parse(JSON.stringify(window.__developerState));
            currentNodeId = id;
            saveState();
          } else {
            currentNodeId = id;
          }

          showScreen('app');
        });
      }

      const backToBrain = document.getElementById('backToBrain');
      if (backToBrain) {
        backToBrain.addEventListener('click', function () {
          showScreen('brain');
        });
      }

      const backToBrainRoots = document.getElementById('backToBrainRoots');
      if (backToBrainRoots) {
        backToBrainRoots.addEventListener('click', function () {
          showScreen('brain');
        });
      }

      const appRoot = document.getElementById('appRoot');

      function setSidebarCollapsed(collapsed) {
        if (!appRoot) return;
        const isCollapsed = appRoot.classList.contains('sidebar-collapsed');
        const next = typeof collapsed === 'boolean' ? collapsed : !isCollapsed;
        if (next === isCollapsed) return;

        if (next) {
          if (typeof window.__sidebarWidthPx === 'undefined') {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
              window.__sidebarWidthPx = sidebar.getBoundingClientRect().width;
            }
          }
          appRoot.dataset.prevGridTemplate = appRoot.style.gridTemplateColumns || '';
          appRoot.style.gridTemplateColumns = '';
          appRoot.classList.add('sidebar-collapsed');
        } else {
          appRoot.classList.remove('sidebar-collapsed');
          const w = window.__sidebarWidthPx;
          if (w && !isNaN(w)) {
            appRoot.style.gridTemplateColumns = `96px ${w}px 6px minmax(0, 1fr)`;
          } else if (appRoot.dataset.prevGridTemplate) {
            appRoot.style.gridTemplateColumns = appRoot.dataset.prevGridTemplate;
          }
        }
        updateSidebarToggleIcons();
      }

      function updateSidebarToggleIcons() {
        const collapsed = appRoot && appRoot.classList.contains('sidebar-collapsed');
        document.querySelectorAll('.js-sidebar-toggle').forEach(btn => {
          if (!btn) return;
          btn.textContent = collapsed ? '‚ñ∂' : '‚óÄ';
          btn.title = collapsed ? '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å' : '–°–≤–µ—Ä–Ω—É—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å';
        });
      }

      const sidebarToggles = document.querySelectorAll('.js-sidebar-toggle');
      if (sidebarToggles.length) {
        sidebarToggles.forEach(btn => {
          btn.addEventListener('click', function () {
            setSidebarCollapsed();
          });
        });
        updateSidebarToggleIcons();
      }

      const collapsedGoBrain = document.getElementById('collapsedGoBrain');
      if (collapsedGoBrain) {
        collapsedGoBrain.addEventListener('click', function () {
          showScreen('brain');
        });
      }

      const collapsedAddRoot = document.getElementById('collapsedAddRoot');
      if (collapsedAddRoot) {
        collapsedAddRoot.addEventListener('click', function () {
          const btnRootbarAdd = document.getElementById('btnRootbarAdd');
          if (btnRootbarAdd) btnRootbarAdd.click();
          setSidebarCollapsed(false);
        });
      }

      const collapsedSearch = document.getElementById('collapsedSearch');
      if (collapsedSearch) {
        collapsedSearch.addEventListener('click', function () {
          setSidebarCollapsed(false);
          const input = document.getElementById('globalSearchInput');
          if (input) {
            setTimeout(() => input.focus(), 0);
          }
        });
      }

      // –¢–µ–∫—Å—Ç –ø—Ä–æ –º–æ–∑–≥
      const brainIcon = document.getElementById('brainIcon');
      const brainStory = document.getElementById('brainStory');
      const brainStoryClose = document.getElementById('brainStoryClose');

      if (brainIcon && brainStory && brainStoryClose) {
        brainIcon.addEventListener('click', function () {
          brainStory.classList.add('visible');
        });
        brainStoryClose.addEventListener('click', function () {
          brainStory.classList.remove('visible');
        });
      }
    })();
  </script>
</body>
</html>
